importVuefrom'vue'import{injectStyles,waitForUpdate,nextFrame}from'./helpers'describe('Transitionmode',()=>{const{duration,buffer}=injectStyles()constcomponents={one:{template:'<div>one</div>'},two:{template:'<div>two</div>'}}letelbeforeEach(()=>{el=document.createElement('div')document.body.appendChild(el)})it('dynamiccomponents,simultaneous',done=>{constvm=newVue({template:`<div><transition><component:is="view"class="test"></component></transition></div>`,data:{view:'one'},components}).$mount(el)expect(vm.$el.textContent).toBe('one')vm.view='two'waitForUpdate(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testv-leavev-leave-active">one</div>'+'<divclass="testv-enterv-enter-active">two</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testv-leave-activev-leave-to">one</div>'+'<divclass="testv-enter-activev-enter-to">two</div>')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">two</div>')}).then(done)})it('dynamiccomponents,out-in',done=>{letnextconstvm=newVue({template:`<div><transitionname="test"mode="out-in"@after-leave="afterLeave"><component:is="view"class="test"></component></transition></div>`,data:{view:'one'},components,methods:{afterLeave(){next()}}}).$mount(el)expect(vm.$el.textContent).toBe('one')vm.view='two'waitForUpdate(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leavetest-leave-active">one</div><!---->')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leave-activetest-leave-to">one</div><!---->')}).thenWaitFor(_next=>{next=_next}).then(()=>{expect(vm.$el.innerHTML).toBe('<!---->')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-entertest-enter-active">two</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-enter-activetest-enter-to">two</div>')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">two</div>')}).then(done)})#3440it('dynamiccomponents,out-in(withextrare-render)',done=>{letnextconstvm=newVue({template:`<div><transitionname="test"mode="out-in"@after-leave="afterLeave"><component:is="view"class="test"></component></transition></div>`,data:{view:'one'},components,methods:{afterLeave(){next()}}}).$mount(el)expect(vm.$el.textContent).toBe('one')vm.view='two'waitForUpdate(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leavetest-leave-active">one</div><!---->')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leave-activetest-leave-to">one</div><!---->')Forcere-renderbeforetheelementfinishesleavingthisshouldnotcausetheincomingelementtoenterearlyvm.$forceUpdate()}).thenWaitFor(_next=>{next=_next}).then(()=>{expect(vm.$el.innerHTML).toBe('<!---->')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-entertest-enter-active">two</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-enter-activetest-enter-to">two</div>')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">two</div>')}).then(done)})it('dynamiccomponents,in-out',done=>{letnextconstvm=newVue({template:`<div><transitionname="test"mode="in-out"@after-enter="afterEnter"><component:is="view"class="test"></component></transition></div>`,data:{view:'one'},components,methods:{afterEnter(){next()}}}).$mount(el)expect(vm.$el.textContent).toBe('one')vm.view='two'waitForUpdate(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">one</div>'+'<divclass="testtest-entertest-enter-active">two</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">one</div>'+'<divclass="testtest-enter-activetest-enter-to">two</div>')}).thenWaitFor(_next=>{next=_next}).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">one</div>'+'<divclass="test">two</div>')}).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leavetest-leave-active">one</div>'+'<divclass="test">two</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leave-activetest-leave-to">one</div>'+'<divclass="test">two</div>')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">two</div>')}).then(done)})it('dynamiccomponents,in-outwithearlycancel',done=>{letnextconstvm=newVue({template:`<div><transitionname="test"mode="in-out"@after-enter="afterEnter"><component:is="view"class="test"></component></transition></div>`,data:{view:'one'},components,methods:{afterEnter(){next()}}}).$mount(el)expect(vm.$el.textContent).toBe('one')vm.view='two'waitForUpdate(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">one</div>'+'<divclass="testtest-entertest-enter-active">two</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">one</div>'+'<divclass="testtest-enter-activetest-enter-to">two</div>')switchagainbeforeenterfinishes,thiscancelsbothenterandleave.vm.view='one'}).then(()=>{1.thependingleaving"one"shouldberemovedinstantly.2.theentering"two"shouldbeplacedintoitsfinalstateinstantly.3.anew"one"iscreatedandenteringexpect(vm.$el.innerHTML).toBe('<divclass="test">two</div>'+'<divclass="testtest-entertest-enter-active">one</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">two</div>'+'<divclass="testtest-enter-activetest-enter-to">one</div>')}).thenWaitFor(_next=>{next=_next}).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">two</div>'+'<divclass="test">one</div>')}).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leavetest-leave-active">two</div>'+'<divclass="test">one</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leave-activetest-leave-to">two</div>'+'<divclass="test">one</div>')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">one</div>')}).then(done)})it('normalelementswithdifferentkeys,simultaneous',done=>{constvm=newVue({template:`<div><transition><div:key="view"class="test">{{view}}</div></transition></div>`,data:{view:'one'},components}).$mount(el)expect(vm.$el.textContent).toBe('one')vm.view='two'waitForUpdate(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testv-leavev-leave-active">one</div>'+'<divclass="testv-enterv-enter-active">two</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testv-leave-activev-leave-to">one</div>'+'<divclass="testv-enter-activev-enter-to">two</div>')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">two</div>')}).then(done)})it('normalelementswithdifferentkeys,out-in',done=>{letnextconstvm=newVue({template:`<div><transitionname="test"mode="out-in"@after-leave="afterLeave"><div:key="view"class="test">{{view}}</div></transition></div>`,data:{view:'one'},components,methods:{afterLeave(){next()}}}).$mount(el)expect(vm.$el.textContent).toBe('one')vm.view='two'waitForUpdate(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leavetest-leave-active">one</div><!---->')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leave-activetest-leave-to">one</div><!---->')}).thenWaitFor(_next=>{next=_next}).then(()=>{expect(vm.$el.innerHTML).toBe('<!---->')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-entertest-enter-active">two</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-enter-activetest-enter-to">two</div>')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">two</div>')}).then(done)})it('normalelementswithdifferentkeys,in-out',done=>{letnextconstvm=newVue({template:`<div><transitionname="test"mode="in-out"@after-enter="afterEnter"><div:key="view"class="test">{{view}}</div></transition></div>`,data:{view:'one'},components,methods:{afterEnter(){next()}}}).$mount(el)expect(vm.$el.textContent).toBe('one')vm.view='two'waitForUpdate(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">one</div>'+'<divclass="testtest-entertest-enter-active">two</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">one</div>'+'<divclass="testtest-enter-activetest-enter-to">two</div>')}).thenWaitFor(_next=>{next=_next}).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">one</div>'+'<divclass="test">two</div>')}).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leavetest-leave-active">one</div>'+'<divclass="test">two</div>')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="testtest-leave-activetest-leave-to">one</div>'+'<divclass="test">two</div>')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.innerHTML).toBe('<divclass="test">two</div>')}).then(done)})it('transitionout-inonasynccomponent(resolvebeforeleavecomplete)',done=>{constvm=newVue({template:`<div><transitionname="test-anim"mode="out-in"><component-av-if="ok"></component-a><component-bv-else></component-b></transition></div>`,components:{componentA:resolve=>{setTimeout(()=>{resolve({template:'<div><h1>componentA</h1></div>'})next1()},duration/2)},componentB:resolve=>{setTimeout(()=>{resolve({template:'<div><h1>componentB</h1></div>'})},duration/2)}},data:{ok:true}}).$mount(el)expect(vm.$el.innerHTML).toBe('<!---->')functionnext1(){Vue.nextTick(()=>{expect(vm.$el.children.length).toBe(1)expect(vm.$el.textContent).toBe('componentA')expect(vm.$el.children[0].className).toBe('test-anim-entertest-anim-enter-active')nextFrame(()=>{expect(vm.$el.children[0].className).toBe('test-anim-enter-activetest-anim-enter-to')setTimeout(()=>{expect(vm.$el.children[0].className).toBe('')vm.ok=falsenext2()},duration+buffer)})})}functionnext2(){waitForUpdate(()=>{expect(vm.$el.children.length).toBe(1)expect(vm.$el.textContent).toBe('componentA')expect(vm.$el.children[0].className).toBe('test-anim-leavetest-anim-leave-active')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.children[0].className).toBe('test-anim-leave-activetest-anim-leave-to')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.children.length).toBe(1)expect(vm.$el.textContent).toBe('componentB')expect(vm.$el.children[0].className).toMatch('test-anim-enter-active')}).thenWaitFor(duration*2).then(()=>{expect(vm.$el.children[0].className).toBe('')}).then(done)}})it('transitionout-inonasynccomponent(resolveafterleavecomplete)',done=>{constvm=newVue({template:`<div><transitionname="test-anim"mode="out-in"><component-av-if="ok"></component-a><component-bv-else></component-b></transition></div>`,components:{componentA:{template:'<div><h1>componentA</h1></div>'},componentB:resolve=>{setTimeout(()=>{resolve({template:'<div><h1>componentB</h1></div>'})Vue.nextTick(next)},(duration+buffer)*1.7)}},data:{ok:true}}).$mount(el)expect(vm.$el.innerHTML).toBe('<div><h1>componentA</h1></div>')letnextvm.ok=falsewaitForUpdate(()=>{expect(vm.$el.children.length).toBe(1)expect(vm.$el.textContent).toBe('componentA')expect(vm.$el.children[0].className).toBe('test-anim-leavetest-anim-leave-active')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.children[0].className).toBe('test-anim-leave-activetest-anim-leave-to')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.children.length).toBe(0)expect(vm.$el.innerHTML).toBe('<!---->')}).thenWaitFor(_next=>{next=_next}).then(()=>{expect(vm.$el.children.length).toBe(1)expect(vm.$el.textContent).toBe('componentB')expect(vm.$el.children[0].className).toBe('test-anim-entertest-anim-enter-active')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.children[0].className).toBe('test-anim-enter-activetest-anim-enter-to')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.children.length).toBe(1)expect(vm.$el.textContent).toBe('componentB')expect(vm.$el.children[0].className).toBe('')}).then(done)})it('transitionin-outonasynccomponent',done=>{constvm=newVue({template:`<div><transitionname="test-anim"mode="in-out"><component-av-if="ok"></component-a><component-bv-else></component-b></transition></div>`,components:{componentA:resolve=>{setTimeout(()=>{resolve({template:'<div><h1>componentA</h1></div>'})next1()},duration/2)},componentB:resolve=>{setTimeout(()=>{resolve({template:'<div><h1>componentB</h1></div>'})next2()},duration/2)}},data:{ok:true}}).$mount(el)expect(vm.$el.innerHTML).toBe('<!---->')functionnext1(){Vue.nextTick(()=>{expect(vm.$el.children.length).toBe(1)expect(vm.$el.textContent).toBe('componentA')expect(vm.$el.children[0].className).toBe('test-anim-entertest-anim-enter-active')nextFrame(()=>{expect(vm.$el.children[0].className).toBe('test-anim-enter-activetest-anim-enter-to')setTimeout(()=>{expect(vm.$el.children[0].className).toBe('')vm.ok=false},duration+buffer)})})}functionnext2(){waitForUpdate(()=>{expect(vm.$el.children.length).toBe(2)expect(vm.$el.textContent).toBe('componentAcomponentB')expect(vm.$el.children[0].className).toBe('')expect(vm.$el.children[1].className).toBe('test-anim-entertest-anim-enter-active')}).thenWaitFor(nextFrame).then(()=>{expect(vm.$el.children[1].className).toBe('test-anim-enter-activetest-anim-enter-to')}).thenWaitFor(duration+buffer).then(()=>{expect(vm.$el.children.length).toBe(2)expect(vm.$el.textContent).toBe('componentAcomponentB')expect(vm.$el.children[0].className).toMatch('test-anim-leave-active')expect(vm.$el.children[1].className).toBe('')}).thenWaitFor(duration+buffer*2).then(()=>{expect(vm.$el.children.length).toBe(1)expect(vm.$el.textContent).toBe('componentB')expect(vm.$el.children[0].className).toBe('')}).then(done)}})it('warninvalidmode',()=>{newVue({template:'<transitionmode="foo"><div>123</div></transition>'}).$mount()expect('invalid<transition>mode:foo').toHaveBeenWarned()})})