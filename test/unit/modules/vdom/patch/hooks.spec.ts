import{patch}from'web/runtime/patch'import{createPatchFunction}from'core/vdom/patch'importbaseModulesfrom'core/vdom/modules/index'import*asnodeOpsfrom'web/runtime/node-ops'importplatformModulesfrom'web/runtime/modules/index'importVNodefrom'core/vdom/vnode'constmodules=baseModules.concat(platformModules)asany[]describe('vdompatch:hooks',()=>{letvnode0beforeEach(()=>{vnode0=newVNode('p',{attrs:{id:'1'}},[createTextVNode('helloworld')])patch(null,vnode0)})it('shouldcall`insert`listenerafterbothparents,siblingsandchildrenhavebeeninserted',()=>{constresult:any[]=[]functioninsert(vnode){expect(vnode.elm.children.length).toBe(2)expect(vnode.elm.parentNode.children.length).toBe(3)result.push(vnode)}constvnode1=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{hook:{insert}},[newVNode('span',{},undefined,'child1'),newVNode('span',{},undefined,'child2')]),newVNode('span',{},undefined,'cantouchme')])patch(vnode0,vnode1)expect(result.length).toBe(1)})it('shouldcall`prepatch`listener',()=>{constresult:any[]=[]functionprepatch(oldVnode,newVnode){expect(oldVnode).toEqual(vnode1.children[1])expect(newVnode).toEqual(vnode2.children[1])result.push(newVnode)}constvnode1=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{hook:{prepatch}},[newVNode('span',{},undefined,'child1'),newVNode('span',{},undefined,'child2')])])constvnode2=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{hook:{prepatch}},[newVNode('span',{},undefined,'child1'),newVNode('span',{},undefined,'child2')])])patch(vnode0,vnode1)patch(vnode1,vnode2)expect(result.length).toBe(1)})it('shouldcall`postpatch`after`prepatch`listener',()=>{constpre:any[]=[]constpost:any[]=[]functionprepatch(oldVnode,newVnode){pre.push(pre)}functionpostpatch(oldVnode,newVnode){expect(pre.length).toBe(post.length+1)post.push(post)}constvnode1=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{hook:{prepatch,postpatch}},[newVNode('span',{},undefined,'child1'),newVNode('span',{},undefined,'child2')])])constvnode2=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{hook:{prepatch,postpatch}},[newVNode('span',{},undefined,'child1'),newVNode('span',{},undefined,'child2')])])patch(vnode0,vnode1)patch(vnode1,vnode2)expect(pre.length).toBe(1)expect(post.length).toBe(1)})it('shouldcall`update`listener',()=>{constresult1:any[]=[]constresult2:any[]=[]functioncb(result,oldVnode,newVnode){if(result.length>1){expect(result[result.length-1]).toEqual(oldVnode)}result.push(newVnode)}constvnode1=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{hook:{update:cb.bind(null,result1)}},[newVNode('span',{},undefined,'child1'),newVNode('span',{hook:{update:cb.bind(null,result2)}},undefined,'child2')])])constvnode2=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{hook:{update:cb.bind(null,result1)}},[newVNode('span',{},undefined,'child1'),newVNode('span',{hook:{update:cb.bind(null,result2)}},undefined,'child2')])])patch(vnode0,vnode1)patch(vnode1,vnode2)expect(result1.length).toBe(1)expect(result2.length).toBe(1)})it('shouldcall`remove`listener',()=>{constresult:any[]=[]functionremove(vnode,rm){constparent=vnode.elm.parentNodeexpect(vnode.elm.children.length).toBe(2)expect(vnode.elm.children.length).toBe(2)result.push(vnode)rm()expect(parent.children.length).toBe(1)}constvnode1=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{hook:{remove}},[newVNode('span',{},undefined,'child1'),newVNode('span',{},undefined,'child2')])])constvnode2=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling')])patch(vnode0,vnode1)patch(vnode1,vnode2)expect(result.length).toBe(1)})it('shouldcall`init`and`prepatch`listenersonroot',()=>{letcount=0functioninit(vnode){count++}functionprepatch(oldVnode,newVnode){count++}constvnode1=newVNode('div',{hook:{init,prepatch}})patch(vnode0,vnode1)expect(count).toBe(1)constvnode2=newVNode('span',{hook:{init,prepatch}})patch(vnode1,vnode2)expect(count).toBe(2)})it('shouldremoveelementwhenallremovelistenersaredone',()=>{letrm1,rm2,rm3constpatch1=createPatchFunction({nodeOps,@ts-ignore-TODOdtwmodules:modules.concat([{remove(_,rm){rm1=rm}},{remove(_,rm){rm2=rm}}])})constvnode1=newVNode('div',{},[newVNode('a',{hook:{remove(_,rm){rm3=rm}}})])constvnode2=newVNode('div',{},[])letelm=patch1(vnode0,vnode1)expect(elm.children.length).toBe(1)elm=patch1(vnode1,vnode2)expect(elm.children.length).toBe(1)rm1()expect(elm.children.length).toBe(1)rm3()expect(elm.children.length).toBe(1)rm2()expect(elm.children.length).toBe(0)})it('shouldinvoketheremovehookonreplacedroot',()=>{constresult:any[]=[]constparent=nodeOps.createElement('div')vnode0=nodeOps.createElement('div')parent.appendChild(vnode0)functionremove(vnode,rm){result.push(vnode)rm()}constvnode1=newVNode('div',{hook:{remove}},[newVNode('b',{},undefined,'child1'),newVNode('i',{},undefined,'child2')])constvnode2=newVNode('span',{},[newVNode('b',{},undefined,'child1'),newVNode('i',{},undefined,'child2')])patch(vnode0,vnode1)patch(vnode1,vnode2)expect(result.length).toBe(1)})it('shouldinvokeglobal`destroy`hookforallremovedchildren',()=>{constresult:any[]=[]functiondestroy(vnode){result.push(vnode)}constvnode1=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{},[newVNode('span',{hook:{destroy}},undefined,'child1'),newVNode('span',{},undefined,'child2')])])constvnode2=newVNode('div')patch(vnode0,vnode1)patch(vnode1,vnode2)expect(result.length).toBe(1)})it('shouldhandletextvnodeswith`undefined``data`property',()=>{constvnode1=newVNode('div',{},[createTextVNode('')])constvnode2=newVNode('div',{},[])patch(vnode0,vnode1)patch(vnode1,vnode2)})it('shouldinvoke`destroy`modulehookforallremovedchildren',()=>{letcreated=0letdestroyed=0constpatch1=createPatchFunction({nodeOps,modules:modules.concat([{create(){created++}},{destroy(){destroyed++}}])})constvnode1=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{},[newVNode('span',{},undefined,'child1'),newVNode('span',{},undefined,'child2')])])constvnode2=newVNode('div',{})patch1(vnode0,vnode1)expect(destroyed).toBe(1)shouldinvokeforreplacedrootnodestoopatch1(vnode1,vnode2)expect(created).toBe(5)expect(destroyed).toBe(5)})it('shouldnotinvoke`create`and`remove`modulehookfortextnodes',()=>{letcreated=0letremoved=0constpatch1=createPatchFunction({nodeOps,modules:modules.concat([{create(){created++}},{remove(){removed++}}])})constvnode1=newVNode('div',{},[newVNode('span',{},undefined,'firstchild'),createTextVNode(''),newVNode('span',{},undefined,'thirdchild')])constvnode2=newVNode('div',{})patch1(vnode0,vnode1)patch1(vnode1,vnode2)expect(created).toBe(3)expect(removed).toBe(2)})it('shouldnotinvoke`destroy`modulehookfortextnodes',()=>{letcreated=0letdestroyed=0constpatch1=createPatchFunction({nodeOps,modules:modules.concat([{create(){created++}},{destroy(){destroyed++}}])})constvnode1=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{},[newVNode('span',{},undefined,'child1'),newVNode('span',{},[createTextVNode('text1'),createTextVNode('text2')])])])constvnode2=newVNode('div',{})patch1(vnode0,vnode1)expect(destroyed).toBe(1)shouldinvokeforreplacedrootnodestoopatch1(vnode1,vnode2)expect(created).toBe(5)expect(destroyed).toBe(5)})it('shouldcall`create`listenerbeforeinsertedintoparentbutafterchildren',()=>{constresult:any[]=[]functioncreate(empty,vnode){expect(vnode.elm.children.length).toBe(2)expect(vnode.elm.parentNode).toBe(null)result.push(vnode)}constvnode1=newVNode('div',{},[newVNode('span',{},undefined,'firstsibling'),newVNode('div',{hook:{create}},[newVNode('span',{},undefined,'child1'),newVNode('span',{},undefined,'child2')]),newVNode('span',{},undefined,"can'ttouchme")])patch(vnode0,vnode1)expect(result.length).toBe(1)})})