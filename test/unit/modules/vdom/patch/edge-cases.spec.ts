importVuefrom'vue'import{SSR_ATTR}from'shared/constants'describe('vdompatch:edgecases',()=>{//exposedby#3406//Whenastaticvnodeisinsidev-for,it'spossibleforthesamevnode//tobeusedinmultipleplaces,anditselementwillbereplaced.This//causespatcherrorswhennodeopsdependonthevnode'selementposition.it('shouldhandlestaticvnodesbykey',done=>{constvm=newVue({data:{ok:true},template:`<div><divv-for="iin2"><divv-if="ok">a</div><div>b</div><divv-if="!ok">c</div><div>d</div></div></div>`}).$mount()expect(vm.$el.textContent).toBe('abdabd')vm.ok=falsewaitForUpdate(()=>{expect(vm.$el.textContent).toBe('bcdbcd')}).then(done)})//exposedby#7705//methodsandfunctionexpressionswithmodifiersshouldreturnresultinsteadofundefined//skippedoddchildren[1,3,...]becausetheyarerenderedastextnodeswithundefinedvalueit("shouldreturnlistener'sresultformethodnameandfunctionexpressionwithandw/omodifiers",done=>{constdummyEvt={preventDefault:()=>{}}newVue({template:`<divv-test><div@click="addFive"></div><div@click.prevent="addFive"></div><div@click="addFive($event,5)"></div><div@click.prevent="addFive($event,5)"></div></div>`,methods:{addFive($event,toAdd=0){returntoAdd+5}},directives:{test:{bind(el,binding,vnode){waitForUpdate(()=>{expect(vnode.children[0].data.on.click()).toBe(5)expect(vnode.children[2].data.on.click(dummyEvt)).toBe(5)expect(vnode.children[4].data.on.click()).toBe(10)expect(vnode.children[6].data.on.click(dummyEvt)).toBe(10)}).then(done)}}}}).$mount()})//#3533//astaticnodeisreusedincreateElm,whichchangesitselmreference//andisinsertedintoadifferentparent.//laterwhenpatchingthenextelementaDOMinsertionusesitasthe//referencenode,causingaparentmismatch.it("shouldhandlestaticnodeedgecasewhenit'sreusedANDusedasareferencenodeforinsertion",done=>{constvm=newVue({data:{ok:true},template:`<div><button@click="ok=!ok">toggle</button><divclass="b"v-if="ok">123</div><divclass="c"><div><span/></div><p>{{1}}</p></div><divclass="d"><label>{{2}}</label></div><divclass="b"v-if="ok">123</div></div>`}).$mount()expect(vm.$el.querySelector('.c').textContent).toBe('1')expect(vm.$el.querySelector('.d').textContent).toBe('2')vm.ok=falsewaitForUpdate(()=>{expect(vm.$el.querySelector('.c').textContent).toBe('1')expect(vm.$el.querySelector('.d').textContent).toBe('2')}).then(done)})it('shouldhandleslotnodesbeingreusedacrossrender',done=>{constvm=newVue({template:`<fooref="foo"><div>slot</div></foo>`,components:{foo:{data(){return{ok:true}},render(h){constchildren=[this.ok?h('div','toggler'):null,h('div',[this.$slots.default,h('span','1')]),h('div',[h('label','2')])]returnh('div',children)}}}}).$mount()expect(vm.$el.textContent).toContain('togglerslot12')vm.$refs.foo.ok=falsewaitForUpdate(()=>{expect(vm.$el.textContent).toContain('slot12')vm.$refs.foo.ok=true}).then(()=>{expect(vm.$el.textContent).toContain('togglerslot12')vm.$refs.foo.ok=false}).then(()=>{expect(vm.$el.textContent).toContain('slot12')vm.$refs.foo.ok=true}).then(done)})it("shouldsynchronizevm'vnode",done=>{constcomp={data:()=>({swap:true}),render(h){returnthis.swap?h('a','atag'):h('span','span')}}constwrapper={render:h=>h('comp'),components:{comp}}constvm=newVue({render(h){constchildren=[h('wrapper'),h('div','row')]if(this.swap){children.reverse()}returnh('div',children)},data:()=>({swap:false}),components:{wrapper}}).$mount()expect(vm.$el.innerHTML).toBe('<a>atag</a><div>row</div>')constwrapperVm=vm.$children[0]constcompVm=wrapperVm.$children[0]vm.swap=truewaitForUpdate(()=>{expect(compVm.$vnode.parent).toBe(wrapperVm.$vnode)expect(vm.$el.innerHTML).toBe('<div>row</div><a>atag</a>')vm.swap=false}).then(()=>{expect(compVm.$vnode.parent).toBe(wrapperVm.$vnode)expect(vm.$el.innerHTML).toBe('<a>atag</a><div>row</div>')compVm.swap=false}).then(()=>{expect(vm.$el.innerHTML).toBe('<span>span</span><div>row</div>')expect(compVm.$vnode.parent).toBe(wrapperVm.$vnode)vm.swap=true}).then(()=>{expect(vm.$el.innerHTML).toBe('<div>row</div><span>span</span>')expect(compVm.$vnode.parent).toBe(wrapperVm.$vnode)vm.swap=true}).then(done)})//#4530it('shouldnotresetvaluewhenpatchingbetweendynamic/staticbindings',done=>{constvm=newVue({data:{ok:true},template:`<div><inputtype="button"v-if="ok"value="a"><inputtype="button":value="'b'"></div>`}).$mount()expect(vm.$el.children[0].value).toBe('a')vm.ok=falsewaitForUpdate(()=>{expect(vm.$el.children[0].value).toBe('b')vm.ok=true}).then(()=>{expect(vm.$el.children[0].value).toBe('a')}).then(done)})//#6313it('shouldnotreplacenodewhenswitchingbetweentext-likeinputs',done=>{constvm=newVue({data:{show:false},template:`<div><input:type="show?'text':'password'"></div>`}).$mount()constnode=vm.$el.children[0]expect(vm.$el.children[0].type).toBe('password')vm.$el.children[0].value='test'vm.show=truewaitForUpdate(()=>{expect(vm.$el.children[0]).toBe(node)expect(vm.$el.children[0].value).toBe('test')expect(vm.$el.children[0].type).toBe('text')vm.show=false}).then(()=>{expect(vm.$el.children[0]).toBe(node)expect(vm.$el.children[0].value).toBe('test')expect(vm.$el.children[0].type).toBe('password')}).then(done)})it('shouldproperlypatchnestedHOCwhenrootelementisreplaced',done=>{constvm=newVue({template:`<fooclass="hello"ref="foo"/>`,components:{foo:{template:`<barref="bar"/>`,components:{bar:{template:`<divv-if="ok"></div><spanv-else></span>`,data(){return{ok:true}}}}}}}).$mount()expect(vm.$refs.foo.$refs.bar.$el.tagName).toBe('DIV')expect(vm.$refs.foo.$refs.bar.$el.className).toBe(`hello`)expect(vm.$el.tagName).toBe('DIV')expect(vm.$el.className).toBe(`hello`)vm.$refs.foo.$refs.bar.ok=falsewaitForUpdate(()=>{expect(vm.$refs.foo.$refs.bar.$el.tagName).toBe('SPAN')expect(vm.$refs.foo.$refs.bar.$el.className).toBe(`hello`)expect(vm.$el.tagName).toBe('SPAN')expect(vm.$el.className).toBe(`hello`)}).then(done)})//#6790it('shouldnotrenderundefinedforemptynestedarrays',()=>{constvm=newVue({template:`<div><templatev-for="iinemptyArr"></template></div>`,data:{emptyArr:[]}}).$mount()expect(vm.$el.textContent).toBe('')})//#6803it('backwardscompatwithcheckboxcodegeneratedbefore2.4',()=>{constspy=vi.fn()constvm=newVue({data:{label:'foobar',name:'foobar'},computed:{value:{get(){return1},set:spy}},render(h){const_vm=thisreturnh('div',{},[h('input',{directives:[{name:'model',rawName:'v-model',value:_vm.value,expression:'value'}],attrs:{type:'radio',name:_vm.name},domProps:{value:_vm.label,checked:_vm._q(_vm.value,_vm.label)},on:{__c:function($event){_vm.value=_vm.label}}})])}}).$mount()document.body.appendChild(vm.$el)vm.$el.children[0].click()expect(spy).toHaveBeenCalled()})//#7041it('transitionchildrenwithonlydeepbindingsshouldbepatchedonupdate',done=>{constvm=newVue({template:`<div><transition><div:style="style"></div></transition></div>`,data:()=>({style:{color:'red'}})}).$mount()expect(vm.$el.children[0].style.color).toBe('red')vm.style.color='green'waitForUpdate(()=>{expect(vm.$el.children[0].style.color).toBe('green')}).then(done)})//#7294it('shouldcleanupcomponentinlineeventsonpatchwhennoeventsarepresent',done=>{constlog=vi.fn()constvm=newVue({data:{ok:true},template:`<div><foov-if="ok"@custom="log"/><foov-else/></div>`,components:{foo:{render(){}}},methods:{log}}).$mount()vm.ok=falsewaitForUpdate(()=>{vm.$children[0].$emit('custom')expect(log).not.toHaveBeenCalled()}).then(done)})//#6864it('shouldnotspecial-casebooleanattributesforcustomelements',()=>{Vue.config.ignoredElements=[/^custom-/]constvm=newVue({template:`<div><custom-fooselected="1"/></div>`}).$mount()expect(vm.$el.querySelector('custom-foo').getAttribute('selected')).toBe('1')Vue.config.ignoredElements=[]})//#7805it('shouldnotcauseduplicateinitwhencomponentssharedataobject',()=>{constBase={render(h){returnh('div',this.$options.name)}}constFoo={name:'Foo',extends:Base}constBar={name:'Bar',extends:Base}//sometimeswedoneedtotapintotheseinternalhooks(e.g.invue-router)//somakesureitdoesworkconstinlineHookSpy=vi.fn()constvm=newVue({render(h){constdata={staticClass:'text-red',hook:{init:inlineHookSpy}}returnh('div',[h(Foo,data),h(Bar,data)])}}).$mount()expect(vm.$el.textContent).toBe('FooBar')expect(inlineHookSpy.mock.calls.length).toBe(2)})//#9549it('DOMpropssetthrowingshouldnotbreakapp',done=>{constvm=newVue({data:{n:Infinity},template:`<div><progress:value="n"/>{{n}}</div>`}).$mount()expect(vm.$el.textContent).toMatch('Infinity')vm.n=1waitForUpdate(()=>{expect(vm.$el.textContent).toMatch('1')expect(vm.$el.textContent).not.toMatch('Infinity')}).then(done)})it('shouldnotthrowwhenhydratedpendingasynccomponentispatchedbyv-if="false"',done=>{constPendingAsyncComponent=()=>newPromise(()=>{})constssrAsyncComponent=document.createElement('div')ssrAsyncComponent.setAttribute(SSR_ATTR,'true')constvm=newVue({data:{visible:true},components:{PendingAsyncComponent},template:'<pending-async-componentv-if="visible"></pending-async-component>'}).$mount(ssrAsyncComponent)vm.visible=falsevm.$nextTick(done)})})