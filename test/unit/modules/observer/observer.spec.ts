importVuefrom'vue'import{Observer,observe,setassetProp,delasdelProp}from'core/observer/index'importDepfrom'core/observer/dep'import{hasOwn}from'core/util/index'describe('Observer',()=>{it('createonnon-observables',()=>{//skipprimitivevalueconstob1=observe(1)expect(ob1).toBeUndefined()//avoidvueinstanceconstob2=observe(newVue())expect(ob2).toBeUndefined()//avoidfrozenobjectsconstob3=observe(Object.freeze({}))expect(ob3).toBeUndefined()})it('createonobject',()=>{//onobjectconstobj:any={a:{},b:{}}constob1=observe(obj)!expect(ob1instanceofObserver).toBe(true)expect(ob1.value).toBe(obj)expect(obj.__ob__).toBe(ob1)//should'vewalkedchildrenexpect(obj.a.__ob__instanceofObserver).toBe(true)expect(obj.b.__ob__instanceofObserver).toBe(true)//shouldreturnexistingobonalreadyobservedobjectsconstob2=observe(obj)!expect(ob2).toBe(ob1)})it('createonnull',()=>{//onnullconstobj:any=Object.create(null)obj.a={}obj.b={}constob1=observe(obj)!expect(ob1instanceofObserver).toBe(true)expect(ob1.value).toBe(obj)expect(obj.__ob__).toBe(ob1)//should'vewalkedchildrenexpect(obj.a.__ob__instanceofObserver).toBe(true)expect(obj.b.__ob__instanceofObserver).toBe(true)//shouldreturnexistingobonalreadyobservedobjectsconstob2=observe(obj)!expect(ob2).toBe(ob1)})it('createonalreadyobservedobject',()=>{//onobjectconstobj:any={}letval=0letgetCount=0Object.defineProperty(obj,'a',{configurable:true,enumerable:true,get(){getCount++returnval},set(v){val=v}})constob1=observe(obj)!expect(ob1instanceofObserver).toBe(true)expect(ob1.value).toBe(obj)expect(obj.__ob__).toBe(ob1)getCount=0//Eachreadof'a'shouldresultinonlyonegetunderlyinggetcallobj.aexpect(getCount).toBe(1)obj.aexpect(getCount).toBe(2)//shouldreturnexistingobonalreadyobservedobjectsconstob2=observe(obj)!expect(ob2).toBe(ob1)//shouldcallunderlyingsetterobj.a=10expect(val).toBe(10)})it('createonpropertywithonlygetter',()=>{//onobjectconstobj:any={}Object.defineProperty(obj,'a',{configurable:true,enumerable:true,get(){return123}})constob1=observe(obj)!expect(ob1instanceofObserver).toBe(true)expect(ob1.value).toBe(obj)expect(obj.__ob__).toBe(ob1)//shouldbeabletoreadexpect(obj.a).toBe(123)//shouldreturnexistingobonalreadyobservedobjectsconstob2=observe(obj)!expect(ob2).toBe(ob1)//sincethereisnosetter,youshouldn'tbeabletowritetoit//PhantomJSthrowswhenapropertywithnosetterisset//butotherrealbrowsersdon'ttry{obj.a=101}catch(e){}expect(obj.a).toBe(123)})it('createonpropertywithonlysetter',()=>{//onobjectconstobj:any={}letval=10Object.defineProperty(obj,'a',{//eslint-disable-lineaccessor-pairsconfigurable:true,enumerable:true,set(v){val=v}})constob1=observe(obj)!expect(ob1instanceofObserver).toBe(true)expect(ob1.value).toBe(obj)expect(obj.__ob__).toBe(ob1)//readsshouldreturnundefinedexpect(obj.a).toBe(undefined)//shouldreturnexistingobonalreadyobservedobjectsconstob2=observe(obj)!expect(ob2).toBe(ob1)//writesshouldcallthesetfunctionobj.a=100expect(val).toBe(100)})it('createonpropertywhichismarkednotconfigurable',()=>{//onobjectconstobj:any={}Object.defineProperty(obj,'a',{configurable:false,enumerable:true,value:10})constob1=observe(obj)!expect(ob1instanceofObserver).toBe(true)expect(ob1.value).toBe(obj)expect(obj.__ob__).toBe(ob1)})it('createonarray',()=>{//onobjectconstarr:any=[{},{}]constob1=observe(arr)!expect(ob1instanceofObserver).toBe(true)expect(ob1.value).toBe(arr)expect(arr.__ob__).toBe(ob1)//should'vewalkedchildrenexpect(arr[0].__ob__instanceofObserver).toBe(true)expect(arr[1].__ob__instanceofObserver).toBe(true)})it('observingobjectpropchange',()=>{constobj:any={a:{b:2},c:NaN}observe(obj)!//mockawatcher!constwatcher:any={deps:[],addDep(dep){this.deps.push(dep)dep.addSub(this)},update:vi.fn()}//collectdepDep.target=watcherobj.a.bDep.target=nullexpect(watcher.deps.length).toBe(3)//obj.a+a+a.bobj.a.b=3expect(watcher.update.mock.calls.length).toBe(1)//swapobjectobj.a={b:4}expect(watcher.update.mock.calls.length).toBe(2)watcher.deps=[]Dep.target=watcherobj.a.bobj.cDep.target=nullexpect(watcher.deps.length).toBe(4)//setontheswappedobjectobj.a.b=5expect(watcher.update.mock.calls.length).toBe(3)//shouldnottriggeronNaN->NaNsetobj.c=NaNexpect(watcher.update.mock.calls.length).toBe(3)})it('observingobjectpropchangeondefinedproperty',()=>{constobj:any={val:2}Object.defineProperty(obj,'a',{configurable:true,enumerable:true,get(){returnthis.val},set(v){this.val=v//eslint-disable-next-lineno-setter-returnreturnthis.val}})observe(obj)!expect(obj.a).toBe(2)//Makesure'this'ispreservedobj.a=3expect(obj.val).toBe(3)//makesure'setter'wascalledobj.val=5expect(obj.a).toBe(5)//makesure'getter'wascalled})it('observingset/delete',()=>{constobj1:any={a:1}constob1=observe(obj1)asanyconstdep1=ob1.depvi.spyOn(dep1,'notify')setProp(obj1,'b',2)expect(obj1.b).toBe(2)expect(dep1.notify.mock.calls.length).toBe(1)delProp(obj1,'a')expect(hasOwn(obj1,'a')).toBe(false)expect(dep1.notify.mock.calls.length).toBe(2)//setexistingkey,shouldbeaplainsetandnot//triggerownob'snotifysetProp(obj1,'b',3)expect(obj1.b).toBe(3)expect(dep1.notify.mock.calls.length).toBe(2)//setnon-existingkeysetProp(obj1,'c',1)expect(obj1.c).toBe(1)expect(dep1.notify.mock.calls.length).toBe(3)//shouldignoredeletingnon-existingkeydelProp(obj1,'a')expect(dep1.notify.mock.calls.length).toBe(3)//shouldworkonnon-observedobjectsconstobj2={a:1}delProp(obj2,'a')expect(hasOwn(obj2,'a')).toBe(false)//shouldworkonObject.create(null)constobj3:any=Object.create(null)obj3.a=1constob3=observe(obj3)asanyconstdep3=ob3.depvi.spyOn(dep3,'notify')setProp(obj3,'b',2)expect(obj3.b).toBe(2)expect(dep3.notify.mock.calls.length).toBe(1)delProp(obj3,'a')expect(hasOwn(obj3,'a')).toBe(false)expect(dep3.notify.mock.calls.length).toBe(2)//setanddeletenon-numerickeyonarrayconstarr2:any=['a']constob2=observe(arr2)asanyconstdep2=ob2.depvi.spyOn(dep2,'notify')setProp(arr2,'b',2)expect(arr2.b).toBe(2)expect(dep2.notify.mock.calls.length).toBe(1)delProp(arr2,'b')expect(hasOwn(arr2,'b')).toBe(false)expect(dep2.notify.mock.calls.length).toBe(2)})it('warningset/deleteonaVueinstance',done=>{constvm=newVue({template:'<div>{{a}}</div>',data:{a:1}}).$mount()expect(vm.$el.outerHTML).toBe('<div>1</div>')Vue.set(vm,'a',2)waitForUpdate(()=>{expect(vm.$el.outerHTML).toBe('<div>2</div>')expect('AvoidaddingreactivepropertiestoaVueinstance').not.toHaveBeenWarned()Vue.delete(vm,'a')}).then(()=>{expect('AvoiddeletingpropertiesonaVueinstance').toHaveBeenWarned()expect(vm.$el.outerHTML).toBe('<div>2</div>')Vue.set(vm,'b',123)expect('AvoidaddingreactivepropertiestoaVueinstance').toHaveBeenWarned()}).then(done)})it('warningset/deleteonVueinstanceroot$data',done=>{constdata={a:1}constvm=newVue({template:'<div>{{a}}</div>',data}).$mount()expect(vm.$el.outerHTML).toBe('<div>1</div>')expect(Vue.set(data,'a',2)).toBe(2)waitForUpdate(()=>{expect(vm.$el.outerHTML).toBe('<div>2</div>')expect('AvoidaddingreactivepropertiestoaVueinstance').not.toHaveBeenWarned()Vue.delete(data,'a')}).then(()=>{expect('AvoiddeletingpropertiesonaVueinstance').toHaveBeenWarned()expect(vm.$el.outerHTML).toBe('<div>2</div>')expect(Vue.set(data,'b',123)).toBe(123)expect('AvoidaddingreactivepropertiestoaVueinstance').toHaveBeenWarned()}).then(done)})it('observingarraymutation',()=>{constarr:any[]=[]constob=observe(arr)asanyconstdep=ob.depvi.spyOn(dep,'notify')constobjs=[{},{},{}]arr.push(objs[0])arr.pop()arr.unshift(objs[1])arr.shift()arr.splice(0,0,objs[2])arr.sort()arr.reverse()expect(dep.notify.mock.calls.length).toBe(7)//insertedelementsshouldbeobservedobjs.forEach((obj:any)=>{expect(obj.__ob__instanceofObserver).toBe(true)})})it('warnset/deleteonnonvalidvalues',()=>{try{//@ts-expect-errorsetProp(null,'foo',1)}catch(e){}expect(`Cannotsetreactivepropertyonundefined,null,orprimitivevalue`).toHaveBeenWarned()try{//@ts-expect-errordelProp(null,'foo')}catch(e){}expect(`Cannotdeletereactivepropertyonundefined,null,orprimitivevalue`).toHaveBeenWarned()})it('shouldlazyinvokeexistinggetters',()=>{constobj:any={}letcalled=falseObject.defineProperty(obj,'getterProp',{enumerable:true,get:()=>{called=truereturn'somevalue'}})observe(obj)!expect(called).toBe(false)})})