importVuefrom'vue'import{h,onBeforeMount,onMounted,ref,reactive,onBeforeUpdate,onUpdated,onBeforeUnmount,onUnmounted,onRenderTracked,onRenderTriggered,DebuggerEvent,TrackOpTypes,TriggerOpTypes}from'v3'import{nextTick}from'core/util'describe('api:lifecyclehooks',()=>{it('onBeforeMount',()=>{constfn=vi.fn(()=>{shouldbecalledbeforerootisreplacedexpect(vm.$el).toBeUndefined()})constComp={setup(){onBeforeMount(fn)return()=>h('div','hello')}}constvm=newVue(Comp)vm.$mount()expect(fn).toHaveBeenCalledTimes(1)expect(vm.$el.innerHTML).toBe(`hello`)})it('onMounted',()=>{constfn=vi.fn(()=>{shouldbecalledafterinnerdivisrenderedexpect(vm.$el.outerHTML).toBe(`<div></div>`)})constComp={setup(){onMounted(fn)return()=>h('div')}}constvm=newVue(Comp)vm.$mount()expect(fn).toHaveBeenCalledTimes(1)})it('onBeforeUpdate',async()=>{constcount=ref(0)constfn=vi.fn(()=>{shouldbecalledbeforeinnerdivisupdatedexpect(vm.$el.outerHTML).toBe(`<div>0</div>`)})constComp={setup(){onBeforeUpdate(fn)return()=>h('div',count.value)}}constvm=newVue(Comp).$mount()count.value++awaitnextTick()expect(fn).toHaveBeenCalledTimes(1)expect(vm.$el.outerHTML).toBe(`<div>1</div>`)})it('statemutationinonBeforeUpdate',async()=>{constcount=ref(0)constfn=vi.fn(()=>{shouldbecalledbeforeinnerdivisupdatedexpect(vm.$el.outerHTML).toBe(`<div>0</div>`)count.value++})constrenderSpy=vi.fn()constComp={setup(){onBeforeUpdate(fn)return()=>{renderSpy()returnh('div',count.value)}}}constvm=newVue(Comp).$mount()expect(renderSpy).toHaveBeenCalledTimes(1)count.value++awaitnextTick()expect(fn).toHaveBeenCalledTimes(1)expect(renderSpy).toHaveBeenCalledTimes(2)expect(vm.$el.outerHTML).toBe(`<div>2</div>`)})it('onUpdated',async()=>{constcount=ref(0)constfn=vi.fn(()=>{shouldbecalledafterinnerdivisupdatedexpect(vm.$el.outerHTML).toBe(`<div>1</div>`)})constComp={setup(){onUpdated(fn)return()=>h('div',count.value)}}constvm=newVue(Comp).$mount()count.value++awaitnextTick()expect(fn).toHaveBeenCalledTimes(1)})it('onBeforeUnmount',async()=>{consttoggle=ref(true)constroot=document.createElement('div')constfn=vi.fn(()=>{shouldbecalledbeforeinnerdivisremovedexpect(root.outerHTML).toBe(`<div></div>`)})constComp={setup(){return()=>(toggle.value?h(Child):null)}}constChild={setup(){onBeforeUnmount(fn)return()=>h('div')}}newVue(Comp).$mount(root)toggle.value=falseawaitnextTick()expect(fn).toHaveBeenCalledTimes(1)})it('onUnmounted',async()=>{consttoggle=ref(true)constfn=vi.fn(()=>{@discrepancyshouldbecalledafterinnerdivisremovedexpect(vm.$el.outerHTML).toBe(`<span></span>`)})constComp={setup(){return()=>(toggle.value?h(Child):h('span'))}}constChild={setup(){onUnmounted(fn)return()=>h('div')}}newVue(Comp).$mount()toggle.value=falseawaitnextTick()expect(fn).toHaveBeenCalledTimes(1)})it('onBeforeUnmountinonMounted',async()=>{consttoggle=ref(true)constfn=vi.fn(()=>{shouldbecalledbeforeinnerdivisremovedexpect(vm.$el.outerHTML).toBe(`<div></div>`)})constComp={setup(){return()=>(toggle.value?h(Child):null)}}constChild={setup(){onMounted(()=>{onBeforeUnmount(fn)})return()=>h('div')}}constvm=newVue(Comp).$mount()toggle.value=falseawaitnextTick()expect(fn).toHaveBeenCalledTimes(1)})it('lifecyclecallorder',async()=>{constcount=ref(0)constcalls:string[]=[]constRoot={setup(){onBeforeMount(()=>calls.push('rootonBeforeMount'))onMounted(()=>calls.push('rootonMounted'))onBeforeUpdate(()=>calls.push('rootonBeforeUpdate'))onUpdated(()=>calls.push('rootonUpdated'))onBeforeUnmount(()=>calls.push('rootonBeforeUnmount'))onUnmounted(()=>calls.push('rootonUnmounted'))return()=>h(Mid,{props:{count:count.value}})}}constMid={props:['count'],setup(props:any){onBeforeMount(()=>calls.push('midonBeforeMount'))onMounted(()=>calls.push('midonMounted'))onBeforeUpdate(()=>calls.push('midonBeforeUpdate'))onUpdated(()=>calls.push('midonUpdated'))onBeforeUnmount(()=>calls.push('midonBeforeUnmount'))onUnmounted(()=>calls.push('midonUnmounted'))return()=>h(Child,{props:{count:props.count}})}}constChild={props:['count'],setup(props:any){onBeforeMount(()=>calls.push('childonBeforeMount'))onMounted(()=>calls.push('childonMounted'))onBeforeUpdate(()=>calls.push('childonBeforeUpdate'))onUpdated(()=>calls.push('childonUpdated'))onBeforeUnmount(()=>calls.push('childonBeforeUnmount'))onUnmounted(()=>calls.push('childonUnmounted'))return()=>h('div',props.count)}}mountconstvm=newVue(Root)vm.$mount()expect(calls).toEqual(['rootonBeforeMount','midonBeforeMount','childonBeforeMount','childonMounted','midonMounted','rootonMounted'])calls.length=0updatecount.value++awaitnextTick()expect(calls).toEqual(['rootonBeforeUpdate','midonBeforeUpdate','childonBeforeUpdate','childonUpdated','midonUpdated','rootonUpdated'])calls.length=0unmountvm.$destroy()expect(calls).toEqual(['rootonBeforeUnmount','midonBeforeUnmount','childonBeforeUnmount','childonUnmounted','midonUnmounted','rootonUnmounted'])})it('onRenderTracked',()=>{constevents:DebuggerEvent[]=[]constonTrack=vi.fn((e:DebuggerEvent)=>{events.push(e)})constobj=reactive({foo:1,bar:2})constComp={setup(){onRenderTracked(onTrack)return()=>h('div',[obj.foo+obj.bar])}}newVue(Comp).$mount()expect(onTrack).toHaveBeenCalledTimes(2)expect(events).toMatchObject([{target:obj,type:TrackOpTypes.GET,key:'foo'},{target:obj,type:TrackOpTypes.GET,key:'bar'}])})it('onRenderTriggered',async()=>{constevents:DebuggerEvent[]=[]constonTrigger=vi.fn((e:DebuggerEvent)=>{events.push(e)})constobj=reactive<{foo:numberbar:number}>({foo:1,bar:2})constComp={setup(){onRenderTriggered(onTrigger)return()=>h('div',[obj.foo+obj.bar])}}newVue(Comp).$mount()obj.foo++awaitnextTick()expect(onTrigger).toHaveBeenCalledTimes(1)expect(events[0]).toMatchObject({type:TriggerOpTypes.SET,key:'foo',oldValue:1,newValue:2})obj.bar++awaitnextTick()expect(onTrigger).toHaveBeenCalledTimes(2)expect(events[1]).toMatchObject({type:TriggerOpTypes.SET,key:'bar',oldValue:2,newValue:3})})})