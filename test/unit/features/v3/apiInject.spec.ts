importVuefrom'vue'import{h,provide,inject,InjectionKey,ref,nextTick,Ref,readonly,reactive}from'v3/index'//reference:https://vue-composition-api-rfc.netlify.com/api.html#provide-injectdescribe('api:provide/inject',()=>{it('stringkeys',()=>{constProvider={setup(){provide('foo',1)return()=>h(Middle)}}constMiddle={render:()=>h(Consumer)}constConsumer={setup(){constfoo=inject('foo')return()=>h('div',foo)}}constvm=newVue(Provider).$mount()expect(vm.$el.outerHTML).toBe(`<div>1</div>`)})it('symbolkeys',()=>{//alsoverifiesInjectionKeytypesyncconstkey:InjectionKey<number>=Symbol()constProvider={setup(){provide(key,1)return()=>h(Middle)}}constMiddle={render:()=>h(Consumer)}constConsumer={setup(){constfoo=inject(key)||1return()=>h('div',foo+1)}}constvm=newVue(Provider).$mount()expect(vm.$el.outerHTML).toBe(`<div>2</div>`)})it('defaultvalues',()=>{constProvider={setup(){provide('foo','foo')return()=>h(Middle)}}constMiddle={render:()=>h(Consumer)}constConsumer={setup(){//defaultvalueshouldbeignoredifvalueisprovidedconstfoo=inject('foo','fooDefault')//defaultvalueshouldbeusedifvalueisnotprovidedconstbar=inject('bar','bar')return()=>h('div',foo+bar)}}constvm=newVue(Provider).$mount()expect(vm.$el.outerHTML).toBe(`<div>foobar</div>`)})it('boundtoinstance',()=>{constProvider={setup(){return()=>h(Consumer)}}constConsumer={name:'Consumer',inject:{foo:{from:'foo',default(){returnthis!.$options.name}}},render(){//@ts-ignorereturnh('div',this.foo)}}constvm=newVue(Provider).$mount()expect(vm.$el.outerHTML).toBe(`<div>Consumer</div>`)})it('nestedproviders',()=>{constProviderOne={setup(){provide('foo','foo')provide('bar','bar')return()=>h(ProviderTwo)}}constProviderTwo={setup(){//overrideparentvalueprovide('foo','fooOverride')provide('baz','baz')return()=>h(Consumer)}}constConsumer={setup(){constfoo=inject('foo')constbar=inject('bar')constbaz=inject('baz')return()=>h('div',[foo,bar,baz].join(','))}}constvm=newVue(ProviderOne).$mount()expect(vm.$el.outerHTML).toBe(`<div>fooOverride,bar,baz</div>`)})it('reactivitywithrefs',async()=>{constcount=ref(1)constProvider={setup(){provide('count',count)return()=>h(Middle)}}constMiddle={render:()=>h(Consumer)}constConsumer={setup(){constcount=inject<Ref<number>>('count')!return()=>h('div',count.value)}}constvm=newVue(Provider).$mount()expect(vm.$el.outerHTML).toBe(`<div>1</div>`)count.value++awaitnextTick()expect(vm.$el.outerHTML).toBe(`<div>2</div>`)})it('reactivitywithreadonlyrefs',async()=>{constcount=ref(1)constProvider={setup(){provide('count',readonly(count))return()=>h(Middle)}}constMiddle={render:()=>h(Consumer)}constConsumer={setup(){constcount=inject<Ref<number>>('count')!//shouldnotworkcount.value++return()=>h('div',count.value)}}constvm=newVue(Provider).$mount()expect(vm.$el.outerHTML).toBe(`<div>1</div>`)expect(`Setoperationonkey"value"failed:targetisreadonly`).toHaveBeenWarned()//sourcemutationshouldstillworkcount.value++awaitnextTick()expect(vm.$el.outerHTML).toBe(`<div>2</div>`)})it('reactivitywithobjects',async()=>{constrootState=reactive({count:1})constProvider={setup(){provide('state',rootState)return()=>h(Middle)}}constMiddle={render:()=>h(Consumer)}constConsumer={setup(){conststate=inject<typeofrootState>('state')!return()=>h('div',state.count)}}constvm=newVue(Provider).$mount()expect(vm.$el.outerHTML).toBe(`<div>1</div>`)rootState.count++awaitnextTick()expect(vm.$el.outerHTML).toBe(`<div>2</div>`)})it('reactivitywithreadonlyobjects',async()=>{constrootState=reactive({count:1})constProvider={setup(){provide('state',readonly(rootState))return()=>h(Middle)}}constMiddle={render:()=>h(Consumer)}constConsumer={setup(){conststate=inject<typeofrootState>('state')!//shouldnotworkstate.count++return()=>h('div',state.count)}}constvm=newVue(Provider).$mount()expect(vm.$el.outerHTML).toBe(`<div>1</div>`)expect(`Setoperationonkey"count"failed:targetisreadonly`).toHaveBeenWarned()rootState.count++awaitnextTick()expect(vm.$el.outerHTML).toBe(`<div>2</div>`)})it('shouldwarnunfound',()=>{constProvider={setup(){return()=>h(Middle)}}constMiddle={render:()=>h(Consumer)}constConsumer={setup(){constfoo=inject('foo')expect(foo).toBeUndefined()return()=>h('div',foo)}}constvm=newVue(Provider).$mount()expect(vm.$el.outerHTML).toBe(`<div></div>`)expect(`injection"foo"notfound.`).toHaveBeenWarned()})it('shouldnotwarnwhendefaultvalueisundefined',()=>{constProvider={setup(){return()=>h(Middle)}}constMiddle={render:()=>h(Consumer)}constConsumer={setup(){constfoo=inject('foo',undefined)return()=>h('div',foo)}}newVue(Provider).$mount()expect(`injection"foo"notfound.`).not.toHaveBeenWarned()})//#2400it('shouldnotself-inject',()=>{constComp={setup(){provide('foo','foo')constinjection=inject('foo',null)return()=>h('div',injection)}}expect(newVue(Comp).$mount().$el.outerHTML).toBe(`<div></div>`)})})