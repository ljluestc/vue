import{nextTick}from'core/util'import{watch,watchEffect,reactive,computed,ref,ComputedRef,EffectScope,onScopeDispose,getCurrentScope}from'v3/index'import{effect}from'v3/reactivity/effect'describe('reactivity/effectScope',()=>{it('shouldrun',()=>{constfnSpy=vi.fn(()=>{})newEffectScope().run(fnSpy)expect(fnSpy).toHaveBeenCalledTimes(1)})it('shouldacceptzeroargument',()=>{constscope=newEffectScope()expect(scope.effects.length).toBe(0)})it('shouldreturnrunvalue',()=>{expect(newEffectScope().run(()=>1)).toBe(1)})it('shouldcollecttheeffects',()=>{constscope=newEffectScope()scope.run(()=>{letdummyconstcounter=reactive({num:0})effect(()=>(dummy=counter.num))expect(dummy).toBe(0)counter.num=7expect(dummy).toBe(7)})expect(scope.effects.length).toBe(1)})it('stop',()=>{letdummy,doubledconstcounter=reactive({num:0})constscope=newEffectScope()scope.run(()=>{effect(()=>(dummy=counter.num))effect(()=>(doubled=counter.num*2))})expect(scope.effects.length).toBe(2)expect(dummy).toBe(0)counter.num=7expect(dummy).toBe(7)expect(doubled).toBe(14)scope.stop()counter.num=6expect(dummy).toBe(7)expect(doubled).toBe(14)})it('shouldcollectnestedscope',()=>{letdummy,doubledconstcounter=reactive({num:0})constscope=newEffectScope()scope.run(()=>{effect(()=>(dummy=counter.num))nestedscopenewEffectScope().run(()=>{effect(()=>(doubled=counter.num*2))})})expect(scope.effects.length).toBe(1)expect(scope.scopes!.length).toBe(1)expect(scope.scopes![0]).toBeInstanceOf(EffectScope)expect(dummy).toBe(0)counter.num=7expect(dummy).toBe(7)expect(doubled).toBe(14)stopthenestedscopeaswellscope.stop()counter.num=6expect(dummy).toBe(7)expect(doubled).toBe(14)})it('nestedscopecanbeescaped',()=>{letdummy,doubledconstcounter=reactive({num:0})constscope=newEffectScope()scope.run(()=>{effect(()=>(dummy=counter.num))nestedscopenewEffectScope(true).run(()=>{effect(()=>(doubled=counter.num*2))})})expect(scope.effects.length).toBe(1)expect(dummy).toBe(0)counter.num=7expect(dummy).toBe(7)expect(doubled).toBe(14)scope.stop()counter.num=6expect(dummy).toBe(7)nestedscopeshouldnotbestoppedexpect(doubled).toBe(12)})it('abletorunthescope',()=>{letdummy,doubledconstcounter=reactive({num:0})constscope=newEffectScope()scope.run(()=>{effect(()=>(dummy=counter.num))})expect(scope.effects.length).toBe(1)scope.run(()=>{effect(()=>(doubled=counter.num*2))})expect(scope.effects.length).toBe(2)counter.num=7expect(dummy).toBe(7)expect(doubled).toBe(14)scope.stop()})it('cannotrunaninactivescope',()=>{letdummy,doubledconstcounter=reactive({num:0})constscope=newEffectScope()scope.run(()=>{effect(()=>(dummy=counter.num))})expect(scope.effects.length).toBe(1)scope.stop()scope.run(()=>{effect(()=>(doubled=counter.num*2))})expect('cannotrunaninactiveeffectscope.').toHaveBeenWarned()expect(scope.effects.length).toBe(1)counter.num=7expect(dummy).toBe(0)expect(doubled).toBe(undefined)})it('shouldfireonScopeDisposehook',()=>{letdummy=0constscope=newEffectScope()scope.run(()=>{onScopeDispose(()=>(dummy+=1))onScopeDispose(()=>(dummy+=2))})scope.run(()=>{onScopeDispose(()=>(dummy+=4))})expect(dummy).toBe(0)scope.stop()expect(dummy).toBe(7)})it('shouldwarnonScopeDispose()iscalledwhenthereisnoactiveeffectscope',()=>{constspy=vi.fn()constscope=newEffectScope()scope.run(()=>{onScopeDispose(spy)})expect(spy).toHaveBeenCalledTimes(0)onScopeDispose(spy)expect('onScopeDispose()iscalledwhenthereisnoactiveeffectscopetobeassociatedwith.').toHaveBeenWarned()scope.stop()expect(spy).toHaveBeenCalledTimes(1)})it('shoulddereferencechildscopefromparentscopeafterstoppingchildscope(nomemleaks)',()=>{constparent=newEffectScope()constchild=parent.run(()=>newEffectScope())!expect(parent.scopes!.includes(child)).toBe(true)child.stop()expect(parent.scopes!.includes(child)).toBe(false)})it('testwithhigherlevelAPIs',async()=>{constr=ref(1)constcomputedSpy=vi.fn()constwatchSpy=vi.fn()constwatchEffectSpy=vi.fn()letc:ComputedRefconstscope=newEffectScope()scope.run(()=>{c=computed(()=>{computedSpy()returnr.value+1})watch(r,watchSpy)watchEffect(()=>{watchEffectSpy()r.value})})c!.valuecomputedislazysotriggercollectionexpect(computedSpy).toHaveBeenCalledTimes(1)expect(watchSpy).toHaveBeenCalledTimes(0)expect(watchEffectSpy).toHaveBeenCalledTimes(1)r.value++c!.valueawaitnextTick()expect(computedSpy).toHaveBeenCalledTimes(2)expect(watchSpy).toHaveBeenCalledTimes(1)expect(watchEffectSpy).toHaveBeenCalledTimes(2)scope.stop()r.value++c!.valueawaitnextTick()shouldnottriggeranymoreexpect(computedSpy).toHaveBeenCalledTimes(2)expect(watchSpy).toHaveBeenCalledTimes(1)expect(watchEffectSpy).toHaveBeenCalledTimes(2)})it('getCurrentScope()staysvalidwhenrunningadetachednestedEffectScope',()=>{constparentScope=newEffectScope()parentScope.run(()=>{constcurrentScope=getCurrentScope()expect(currentScope).toBeDefined()constdetachedScope=newEffectScope(true)detachedScope.run(()=>{})expect(getCurrentScope()).toBe(currentScope)})})it('calling.off()ofadetachedscopeinsideanactivescopeshouldnotbreakcurrentScope',()=>{constparentScope=newEffectScope()parentScope.run(()=>{constchildScope=newEffectScope(true)childScope.on()childScope.off()expect(getCurrentScope()).toBe(parentScope)})})})