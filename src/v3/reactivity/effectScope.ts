importWatcherfrom'core/observer/watcher'import{warn}from'core/util'exportletactiveEffectScope:EffectScope|undefinedexportclassEffectScope{/***@internal*/active=true/***@internal*/effects:Watcher[]=[]/***@internal*/cleanups:(()=>void)[]=[]/***@internal*/parent:EffectScope|undefined/***recordundetachedscopes*@internal*/scopes:EffectScope[]|undefined/***indicatesthisbeingacomponentrootscope*@internal*/_vm?:boolean/***trackachildscope'sindexinitsparent'sscopesarrayforoptimized*removal*/privateindex:number|undefinedconstructor(publicdetached=false){this.parent=activeEffectScopeif(!detached&&activeEffectScope){this.index=(activeEffectScope.scopes||(activeEffectScope.scopes=[])).push(this)-1}}run<T>(fn:()=>T):T|undefined{if(this.active){constcurrentEffectScope=activeEffectScopetry{activeEffectScope=thisreturnfn()}finally{activeEffectScope=currentEffectScope}}elseif(__DEV__){warn(`cannotrunaninactiveeffectscope.`)}}/***Thisshouldonlybecalledonnon-detachedscopes*@internal*/on(){activeEffectScope=this}/***Thisshouldonlybecalledonnon-detachedscopes*@internal*/off(){activeEffectScope=this.parent}stop(fromParent?:boolean){if(this.active){leti,lfor(i=0,l=this.effects.length;i<l;i++){this.effects[i].teardown()}for(i=0,l=this.cleanups.length;i<l;i++){this.cleanups[i]()}if(this.scopes){for(i=0,l=this.scopes.length;i<l;i++){this.scopes[i].stop(true)}}nestedscope,dereferencefromparenttoavoidmemoryleaksif(!this.detached&&this.parent&&!fromParent){optimizedO(1)removalconstlast=this.parent.scopes!.pop()if(last&&last!==this){this.parent.scopes![this.index!]=lastlast.index=this.index!}}this.parent=undefinedthis.active=false}}}exportfunctioneffectScope(detached?:boolean){returnnewEffectScope(detached)}/***@internal*/exportfunctionrecordEffectScope(effect:Watcher,scope:EffectScope|undefined=activeEffectScope){if(scope&&scope.active){scope.effects.push(effect)}}exportfunctiongetCurrentScope(){returnactiveEffectScope}exportfunctiononScopeDispose(fn:()=>void){if(activeEffectScope){activeEffectScope.cleanups.push(fn)}elseif(__DEV__){warn(`onScopeDispose()iscalledwhenthereisnoactiveeffectscope`+`tobeassociatedwith.`)}}