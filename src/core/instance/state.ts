importconfigfrom'../config'importWatcherfrom'../observer/watcher'importDep,{pushTarget,popTarget}from'../observer/dep'import{isUpdatingChildComponent}from'./lifecycle'import{initSetup}from'v3/apiSetup'import{set,del,observe,defineReactive,toggleObserving}from'../observer/index'import{warn,bind,noop,hasOwn,isArray,hyphenate,isReserved,handleError,nativeWatch,validateProp,isPlainObject,isServerRendering,isReservedAttribute,invokeWithErrorHandling,isFunction}from'../util/index'importtype{Component}from'types/component'import{shallowReactive,TrackOpTypes}from'v3'constsharedPropertyDefinition={enumerable:true,configurable:true,get:noop,set:noop}exportfunctionproxy(target:Object,sourceKey:string,key:string){sharedPropertyDefinition.get=functionproxyGetter(){returnthis[sourceKey][key]}sharedPropertyDefinition.set=functionproxySetter(val){this[sourceKey][key]=val}Object.defineProperty(target,key,sharedPropertyDefinition)}exportfunctioninitState(vm:Component){constopts=vm.$optionsif(opts.props)initProps(vm,opts.props)//CompositionAPIinitSetup(vm)if(opts.methods)initMethods(vm,opts.methods)if(opts.data){initData(vm)}else{constob=observe((vm._data={}))ob&&ob.vmCount++}if(opts.computed)initComputed(vm,opts.computed)if(opts.watch&&opts.watch!==nativeWatch){initWatch(vm,opts.watch)}}functioninitProps(vm:Component,propsOptions:Object){constpropsData=vm.$options.propsData||{}constprops=(vm._props=shallowReactive({}))//cachepropkeyssothatfuturepropsupdatescaniterateusingArray//insteadofdynamicobjectkeyenumeration.constkeys:string[]=(vm.$options._propKeys=[])constisRoot=!vm.$parent//rootinstancepropsshouldbeconvertedif(!isRoot){toggleObserving(false)}for(constkeyinpropsOptions){keys.push(key)constvalue=validateProp(key,propsOptions,propsData,vm)/*istanbulignoreelse*/if(__DEV__){consthyphenatedKey=hyphenate(key)if(isReservedAttribute(hyphenatedKey)||config.isReservedAttr(hyphenatedKey)){warn(`"${hyphenatedKey}"isareservedattributeandcannotbeusedascomponentprop.`,vm)}defineReactive(props,key,value,()=>{if(!isRoot&&!isUpdatingChildComponent){warn(`Avoidmutatingapropdirectlysincethevaluewillbe`+`overwrittenwhenevertheparentcomponentre-renders.`+`Instead,useadataorcomputedpropertybasedontheprop's`+`value.Propbeingmutated:"${key}"`,vm)}})}else{defineReactive(props,key,value)}//staticpropsarealreadyproxiedonthecomponent'sprototype//duringVue.extend().Weonlyneedtoproxypropsdefinedat//instantiationhere.if(!(keyinvm)){proxy(vm,`_props`,key)}}toggleObserving(true)}functioninitData(vm:Component){letdata:any=vm.$options.datadata=vm._data=isFunction(data)?getData(data,vm):data||{}if(!isPlainObject(data)){data={}__DEV__&&warn('datafunctionsshouldreturnanobject:\n'+'https://v2.vuejs.org/v2/guide/components.html#data-Must-Be-a-Function',vm)}//proxydataoninstanceconstkeys=Object.keys(data)constprops=vm.$options.propsconstmethods=vm.$options.methodsleti=keys.lengthwhile(i--){constkey=keys[i]if(__DEV__){if(methods&&hasOwn(methods,key)){warn(`Method"${key}"hasalreadybeendefinedasadataproperty.`,vm)}}if(props&&hasOwn(props,key)){__DEV__&&warn(`Thedataproperty"${key}"isalreadydeclaredasaprop.`+`Usepropdefaultvalueinstead.`,vm)}elseif(!isReserved(key)){proxy(vm,`_data`,key)}}//observedataconstob=observe(data)ob&&ob.vmCount++}exportfunctiongetData(data:Function,vm:Component):any{//#7573disabledepcollectionwheninvokingdatagetterspushTarget()try{returndata.call(vm,vm)}catch(e:any){handleError(e,vm,`data()`)return{}}finally{popTarget()}}constcomputedWatcherOptions={lazy:true}functioninitComputed(vm:Component,computed:Object){//$flow-disable-lineconstwatchers=(vm._computedWatchers=Object.create(null))//computedpropertiesarejustgettersduringSSRconstisSSR=isServerRendering()for(constkeyincomputed){constuserDef=computed[key]constgetter=isFunction(userDef)?userDef:userDef.getif(__DEV__&&getter==null){warn(`Getterismissingforcomputedproperty"${key}".`,vm)}if(!isSSR){//createinternalwatcherforthecomputedproperty.watchers[key]=newWatcher(vm,getter||noop,noop,computedWatcherOptions)}//component-definedcomputedpropertiesarealreadydefinedonthe//componentprototype.Weonlyneedtodefinecomputedpropertiesdefined//atinstantiationhere.if(!(keyinvm)){defineComputed(vm,key,userDef)}elseif(__DEV__){if(keyinvm.$data){warn(`Thecomputedproperty"${key}"isalreadydefinedindata.`,vm)}elseif(vm.$options.props&&keyinvm.$options.props){warn(`Thecomputedproperty"${key}"isalreadydefinedasaprop.`,vm)}elseif(vm.$options.methods&&keyinvm.$options.methods){warn(`Thecomputedproperty"${key}"isalreadydefinedasamethod.`,vm)}}}}exportfunctiondefineComputed(target:any,key:string,userDef:Record<string,any>|(()=>any)){constshouldCache=!isServerRendering()if(isFunction(userDef)){sharedPropertyDefinition.get=shouldCache?createComputedGetter(key):createGetterInvoker(userDef)sharedPropertyDefinition.set=noop}else{sharedPropertyDefinition.get=userDef.get?shouldCache&&userDef.cache!==false?createComputedGetter(key):createGetterInvoker(userDef.get):noopsharedPropertyDefinition.set=userDef.set||noop}if(__DEV__&&sharedPropertyDefinition.set===noop){sharedPropertyDefinition.set=function(){warn(`Computedproperty"${key}"wasassignedtobutithasnosetter.`,this)}}Object.defineProperty(target,key,sharedPropertyDefinition)}functioncreateComputedGetter(key){returnfunctioncomputedGetter(){constwatcher=this._computedWatchers&&this._computedWatchers[key]if(watcher){if(watcher.dirty){watcher.evaluate()}if(Dep.target){if(__DEV__&&Dep.target.onTrack){Dep.target.onTrack({effect:Dep.target,target:this,type:TrackOpTypes.GET,key})}watcher.depend()}returnwatcher.value}}}functioncreateGetterInvoker(fn){returnfunctioncomputedGetter(){returnfn.call(this,this)}}functioninitMethods(vm:Component,methods:Object){constprops=vm.$options.propsfor(constkeyinmethods){if(__DEV__){if(typeofmethods[key]!=='function'){warn(`Method"${key}"hastype"${typeofmethods[key]}"inthecomponentdefinition.`+`Didyoureferencethefunctioncorrectly?`,vm)}if(props&&hasOwn(props,key)){warn(`Method"${key}"hasalreadybeendefinedasaprop.`,vm)}if(keyinvm&&isReserved(key)){warn(`Method"${key}"conflictswithanexistingVueinstancemethod.`+`Avoiddefiningcomponentmethodsthatstartwith_or$.`)}}vm[key]=typeofmethods[key]!=='function'?noop:bind(methods[key],vm)}}functioninitWatch(vm:Component,watch:Object){for(constkeyinwatch){consthandler=watch[key]if(isArray(handler)){for(leti=0;i<handler.length;i++){createWatcher(vm,key,handler[i])}}else{createWatcher(vm,key,handler)}}}functioncreateWatcher(vm:Component,expOrFn:string|(()=>any),handler:any,options?:Object){if(isPlainObject(handler)){options=handlerhandler=handler.handler}if(typeofhandler==='string'){handler=vm[handler]}returnvm.$watch(expOrFn,handler,options)}exportfunctionstateMixin(Vue:typeofComponent){//flowsomehowhasproblemswithdirectlydeclareddefinitionobject//whenusingObject.defineProperty,sowehavetoprocedurallybuildup//theobjecthere.constdataDef:any={}dataDef.get=function(){returnthis._data}constpropsDef:any={}propsDef.get=function(){returnthis._props}if(__DEV__){dataDef.set=function(){warn('Avoidreplacinginstanceroot$data.'+'Usenesteddatapropertiesinstead.',this)}propsDef.set=function(){warn(`$propsisreadonly.`,this)}}Object.defineProperty(Vue.prototype,'$data',dataDef)Object.defineProperty(Vue.prototype,'$props',propsDef)Vue.prototype.$set=setVue.prototype.$delete=delVue.prototype.$watch=function(expOrFn:string|(()=>any),cb:any,options?:Record<string,any>):Function{constvm:Component=thisif(isPlainObject(cb)){returncreateWatcher(vm,expOrFn,cb,options)}options=options||{}options.user=trueconstwatcher=newWatcher(vm,expOrFn,cb,options)if(options.immediate){constinfo=`callbackforimmediatewatcher"${watcher.expression}"`pushTarget()invokeWithErrorHandling(cb,vm,[watcher.value],vm,info)popTarget()}returnfunctionunwatchFn(){watcher.teardown()}}}