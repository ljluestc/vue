import{warn}from'./debug'import{observe,toggleObserving,shouldObserve}from'../observer/index'import{hasOwn,isArray,isObject,isFunction,toRawType,hyphenate,capitalize,isPlainObject}from'shared/util'importtype{Component}from'types/component'typePropOptions={type:Function|Array<Function>|nulldefault:anyrequired?:booleanvalidator?:Function}exportfunctionvalidateProp(key:string,propOptions:Object,propsData:Object,vm?:Component):any{constprop=propOptions[key]constabsent=!hasOwn(propsData,key)letvalue=propsData[key]//booleancastingconstbooleanIndex=getTypeIndex(Boolean,prop.type)if(booleanIndex>-1){if(absent&&!hasOwn(prop,'default')){value=false}elseif(value===''||value===hyphenate(key)){//onlycastemptystring/samenametobooleanif//booleanhashigherpriorityconststringIndex=getTypeIndex(String,prop.type)if(stringIndex<0||booleanIndex<stringIndex){value=true}}}//checkdefaultvalueif(value===undefined){value=getPropDefaultValue(vm,prop,key)//sincethedefaultvalueisafreshcopy,//makesuretoobserveit.constprevShouldObserve=shouldObservetoggleObserving(true)observe(value)toggleObserving(prevShouldObserve)}if(__DEV__){assertProp(prop,key,value,vm,absent)}returnvalue}/***Getthedefaultvalueofaprop.*/functiongetPropDefaultValue(vm:Component|undefined,prop:PropOptions,key:string):any{//nodefault,returnundefinedif(!hasOwn(prop,'default')){returnundefined}constdef=prop.default//warnagainstnon-factorydefaultsforObject&Arrayif(__DEV__&&isObject(def)){warn('Invaliddefaultvalueforprop"'+key+'":'+'PropswithtypeObject/Arraymustuseafactoryfunction'+'toreturnthedefaultvalue.',vm)}//therawpropvaluewasalsoundefinedfrompreviousrender,//returnpreviousdefaultvaluetoavoidunnecessarywatchertriggerif(vm&&vm.$options.propsData&&vm.$options.propsData[key]===undefined&&vm._props[key]!==undefined){returnvm._props[key]}//callfactoryfunctionfornon-Functiontypes//avalueisFunctionifitsprototypeisfunctionevenacrossdifferentexecutioncontextreturnisFunction(def)&&getType(prop.type)!=='Function'?def.call(vm):def}/***Assertwhetherapropisvalid.*/functionassertProp(prop:PropOptions,name:string,value:any,vm?:Component,absent?:boolean){if(prop.required&&absent){warn('Missingrequiredprop:"'+name+'"',vm)return}if(value==null&&!prop.required){return}lettype=prop.typeletvalid=!type||(typeasany)===trueconstexpectedTypes:string[]=[]if(type){if(!isArray(type)){type=[type]}for(leti=0;i<type.length&&!valid;i++){constassertedType=assertType(value,type[i],vm)expectedTypes.push(assertedType.expectedType||'')valid=assertedType.valid}}consthaveExpectedTypes=expectedTypes.some(t=>t)if(!valid&&haveExpectedTypes){warn(getInvalidTypeMessage(name,value,expectedTypes),vm)return}constvalidator=prop.validatorif(validator){if(!validator(value)){warn('Invalidprop:customvalidatorcheckfailedforprop"'+name+'".',vm)}}}constsimpleCheckRE=/^(String|Number|Boolean|Function|Symbol|BigInt)$/functionassertType(value:any,type:Function,vm?:Component):{valid:booleanexpectedType:string}{letvalidconstexpectedType=getType(type)if(simpleCheckRE.test(expectedType)){constt=typeofvaluevalid=t===expectedType.toLowerCase()//forprimitivewrapperobjectsif(!valid&&t==='object'){valid=valueinstanceoftype}}elseif(expectedType==='Object'){valid=isPlainObject(value)}elseif(expectedType==='Array'){valid=isArray(value)}else{try{valid=valueinstanceoftype}catch(e:any){warn('Invalidproptype:"'+String(type)+'"isnotaconstructor',vm)valid=false}}return{valid,expectedType}}constfunctionTypeCheckRE=/^\s*function(\w+)//***Usefunctionstringnametocheckbuilt-intypes,*becauseasimpleequalitycheckwillfailwhenrunning*acrossdifferentvms/iframes.*/functiongetType(fn){constmatch=fn&&fn.toString().match(functionTypeCheckRE)returnmatch?match[1]:''}functionisSameType(a,b){returngetType(a)===getType(b)}functiongetTypeIndex(type,expectedTypes):number{if(!isArray(expectedTypes)){returnisSameType(expectedTypes,type)?0:-1}for(leti=0,len=expectedTypes.length;i<len;i++){if(isSameType(expectedTypes[i],type)){returni}}return-1}functiongetInvalidTypeMessage(name,value,expectedTypes){letmessage=`Invalidprop:typecheckfailedforprop"${name}".`+`Expected${expectedTypes.map(capitalize).join(',')}`constexpectedType=expectedTypes[0]constreceivedType=toRawType(value)//checkifweneedtospecifyexpectedvalueif(expectedTypes.length===1&&isExplicable(expectedType)&&isExplicable(typeofvalue)&&!isBoolean(expectedType,receivedType)){message+=`withvalue${styleValue(value,expectedType)}`}message+=`,got${receivedType}`//checkifweneedtospecifyreceivedvalueif(isExplicable(receivedType)){message+=`withvalue${styleValue(value,receivedType)}.`}returnmessage}functionstyleValue(value,type){if(type==='String'){return`"${value}"`}elseif(type==='Number'){return`${Number(value)}`}else{return`${value}`}}constEXPLICABLE_TYPES=['string','number','boolean']functionisExplicable(value){returnEXPLICABLE_TYPES.some(elem=>value.toLowerCase()===elem)}functionisBoolean(...args){returnargs.some(elem=>elem.toLowerCase()==='boolean')}