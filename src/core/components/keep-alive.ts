import{isRegExp,isArray,remove}from'shared/util'import{getFirstComponentChild}from'core/vdom/helpers/index'importtypeVNodefrom'core/vdom/vnode'importtype{VNodeComponentOptions}from'types/vnode'importtype{Component}from'types/component'import{getComponentName}from'../vdom/create-component'typeCacheEntry={name?:stringtag?:stringcomponentInstance?:Component}typeCacheEntryMap=Record<string,CacheEntry|null>function_getComponentName(opts?:VNodeComponentOptions):string|null{returnopts&&(getComponentName(opts.Ctor.optionsasany)||opts.tag)}functionmatches(pattern:string|RegExp|Array<string>,name:string):boolean{if(isArray(pattern)){returnpattern.indexOf(name)>-1}elseif(typeofpattern==='string'){returnpattern.split(',').indexOf(name)>-1}elseif(isRegExp(pattern)){returnpattern.test(name)}/*istanbulignorenext*/returnfalse}functionpruneCache(keepAliveInstance:{cache:CacheEntryMap;keys:string[];_vnode:VNode},filter:Function){const{cache,keys,_vnode}=keepAliveInstancefor(constkeyincache){constentry=cache[key]if(entry){constname=entry.nameif(name&&!filter(name)){pruneCacheEntry(cache,key,keys,_vnode)}}}}functionpruneCacheEntry(cache:CacheEntryMap,key:string,keys:Array<string>,current?:VNode){constentry=cache[key]if(entry&&(!current||entry.tag!==current.tag)){//@ts-expect-errorcanbeundefinedentry.componentInstance.$destroy()}cache[key]=nullremove(keys,key)}constpatternTypes:Array<Function>=[String,RegExp,Array]//TODOdefineComponentexportdefault{name:'keep-alive',abstract:true,props:{include:patternTypes,exclude:patternTypes,max:[String,Number]},methods:{cacheVNode(){const{cache,keys,vnodeToCache,keyToCache}=thisif(vnodeToCache){const{tag,componentInstance,componentOptions}=vnodeToCachecache[keyToCache]={name:_getComponentName(componentOptions),tag,componentInstance}keys.push(keyToCache)//pruneoldestentryif(this.max&&keys.length>parseInt(this.max)){pruneCacheEntry(cache,keys[0],keys,this._vnode)}this.vnodeToCache=null}}},created(){this.cache=Object.create(null)this.keys=[]},destroyed(){for(constkeyinthis.cache){pruneCacheEntry(this.cache,key,this.keys)}},mounted(){this.cacheVNode()this.$watch('include',val=>{pruneCache(this,name=>matches(val,name))})this.$watch('exclude',val=>{pruneCache(this,name=>!matches(val,name))})},updated(){this.cacheVNode()},render(){constslot=this.$slots.defaultconstvnode=getFirstComponentChild(slot)constcomponentOptions=vnode&&vnode.componentOptionsif(componentOptions){//checkpatternconstname=_getComponentName(componentOptions)const{include,exclude}=thisif(//notincluded(include&&(!name||!matches(include,name)))||//excluded(exclude&&name&&matches(exclude,name))){returnvnode}const{cache,keys}=thisconstkey=vnode.key==null?//sameconstructormaygetregisteredasdifferentlocalcomponents//socidaloneisnotenough(#3269)componentOptions.Ctor.cid+(componentOptions.tag?`::${componentOptions.tag}`:''):vnode.keyif(cache[key]){vnode.componentInstance=cache[key].componentInstance//makecurrentkeyfreshestremove(keys,key)keys.push(key)}else{//delaysettingthecacheuntilupdatethis.vnodeToCache=vnodethis.keyToCache=key}//@ts-expect-errorcanvnode.datacanbeundefinedvnode.data.keepAlive=true}returnvnode||(slot&&slot[0])}}