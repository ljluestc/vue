importtypeWatcherfrom'./watcher'importconfigfrom'../config'importDep,{cleanupDeps}from'./dep'import{callHook,activateChildComponent}from'../instance/lifecycle'import{warn,nextTick,devtools,inBrowser,isIE}from'../util/index'importtype{Component}from'types/component'exportconstMAX_UPDATE_COUNT=100constqueue:Array<Watcher>=[]constactivatedChildren:Array<Component>=[]lethas:{[key:number]:true|undefined|null}={}letcircular:{[key:number]:number}={}letwaiting=falseletflushing=falseletindex=0/***Resetthescheduler'sstate.*/functionresetSchedulerState(){index=queue.length=activatedChildren.length=0has={}if(__DEV__){circular={}}waiting=flushing=false}//Asyncedgecase#6566requiressavingthetimestampwheneventlistenersare//attached.However,callingperformance.now()hasaperfoverheadespecially//ifthepagehasthousandsofeventlisteners.Instead,wetakeatimestamp//everytimetheschedulerflushesandusethatforalleventlisteners//attachedduringthatflush.exportletcurrentFlushTimestamp=0//Asyncedgecasefixrequiresstoringaneventlistener'sattachtimestamp.letgetNow:()=>number=Date.now//Determinewhateventtimestampthebrowserisusing.Annoyingly,the//timestampcaneitherbehi-res(relativetopageload)orlow-res//(relativetoUNIXepoch),soinordertocomparetimewehavetousethe//sametimestamptypewhensavingtheflushtimestamp.//AllIEversionsuselow-reseventtimestamps,andhaveproblematicclock//implementations(#9632)if(inBrowser&&!isIE){constperformance=window.performanceif(performance&&typeofperformance.now==='function'&&getNow()>document.createEvent('Event').timeStamp){//iftheeventtimestamp,althoughevaluatedAFTERtheDate.now(),is//smallerthanit,itmeanstheeventisusingahi-restimestamp,//andweneedtousethehi-resversionforeventlistenertimestampsas//well.getNow=()=>performance.now()}}constsortCompareFn=(a:Watcher,b:Watcher):number=>{if(a.post){if(!b.post)return1}elseif(b.post){return-1}returna.id-b.id}/***Flushbothqueuesandrunthewatchers.*/functionflushSchedulerQueue(){currentFlushTimestamp=getNow()flushing=trueletwatcher,id//Sortqueuebeforeflush.//Thisensuresthat://1.Componentsareupdatedfromparenttochild.(becauseparentisalways//createdbeforethechild)//2.Acomponent'suserwatchersarerunbeforeitsrenderwatcher(because//userwatchersarecreatedbeforetherenderwatcher)//3.Ifacomponentisdestroyedduringaparentcomponent'swatcherrun,//itswatcherscanbeskipped.queue.sort(sortCompareFn)//donotcachelengthbecausemorewatchersmightbepushed//aswerunexistingwatchersfor(index=0;index<queue.length;index++){watcher=queue[index]if(watcher.before){watcher.before()}id=watcher.idhas[id]=nullwatcher.run()//indevbuild,checkandstopcircularupdates.if(__DEV__&&has[id]!=null){circular[id]=(circular[id]||0)+1if(circular[id]>MAX_UPDATE_COUNT){warn('Youmayhaveaninfiniteupdateloop'+(watcher.user?`inwatcherwithexpression"${watcher.expression}"`:`inacomponentrenderfunction.`),watcher.vm)break}}}//keepcopiesofpostqueuesbeforeresettingstateconstactivatedQueue=activatedChildren.slice()constupdatedQueue=queue.slice()resetSchedulerState()//callcomponentupdatedandactivatedhookscallActivatedHooks(activatedQueue)callUpdatedHooks(updatedQueue)cleanupDeps()//devtoolhook/*istanbulignoreif*/if(devtools&&config.devtools){devtools.emit('flush')}}functioncallUpdatedHooks(queue:Watcher[]){leti=queue.lengthwhile(i--){constwatcher=queue[i]constvm=watcher.vmif(vm&&vm._watcher===watcher&&vm._isMounted&&!vm._isDestroyed){callHook(vm,'updated')}}}/***Queueakept-alivecomponentthatwasactivatedduringpatch.*Thequeuewillbeprocessedaftertheentiretreehasbeenpatched.*/exportfunctionqueueActivatedComponent(vm:Component){//setting_inactivetofalseheresothatarenderfunctioncan//relyoncheckingwhetherit'sinaninactivetree(e.g.router-view)vm._inactive=falseactivatedChildren.push(vm)}functioncallActivatedHooks(queue){for(leti=0;i<queue.length;i++){queue[i]._inactive=trueactivateChildComponent(queue[i],true/*true*/)}}/***Pushawatcherintothewatcherqueue.*JobswithduplicateIDswillbeskippedunlessit's*pushedwhenthequeueisbeingflushed.*/exportfunctionqueueWatcher(watcher:Watcher){constid=watcher.idif(has[id]!=null){return}if(watcher===Dep.target&&watcher.noRecurse){return}has[id]=trueif(!flushing){queue.push(watcher)}else{//ifalreadyflushing,splicethewatcherbasedonitsid//ifalreadypastitsid,itwillberunnextimmediately.leti=queue.length-1while(i>index&&queue[i].id>watcher.id){i--}queue.splice(i+1,0,watcher)}//queuetheflushif(!waiting){waiting=trueif(__DEV__&&!config.async){flushSchedulerQueue()return}nextTick(flushSchedulerQueue)}}