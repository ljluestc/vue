import{warn,remove,isObject,parsePath,_SetasSet,handleError,invokeWithErrorHandling,noop,isFunction}from'../util/index'import{traverse}from'./traverse'import{queueWatcher}from'./scheduler'importDep,{pushTarget,popTarget,DepTarget}from'./dep'import{DebuggerEvent,DebuggerOptions}from'v3/debug'importtype{SimpleSet}from'../util/index'importtype{Component}from'types/component'import{activeEffectScope,recordEffectScope}from'v3/reactivity/effectScope'letuid=0/***@internal*/exportinterfaceWatcherOptionsextendsDebuggerOptions{deep?:booleanuser?:booleanlazy?:booleansync?:booleanbefore?:Function}/***Awatcherparsesanexpression,collectsdependencies,*andfirescallbackwhentheexpressionvaluechanges.*Thisisusedforboththe$watch()apianddirectives.*@internal*/exportdefaultclassWatcherimplementsDepTarget{vm?:Component|nullexpression:stringcb:Functionid:numberdeep:booleanuser:booleanlazy:booleansync:booleandirty:booleanactive:booleandeps:Array<Dep>newDeps:Array<Dep>depIds:SimpleSetnewDepIds:SimpleSetbefore?:FunctiononStop?:FunctionnoRecurse?:booleangetter:Functionvalue:anypost:booleandevonlyonTrack?:((event:DebuggerEvent)=>void)|undefinedonTrigger?:((event:DebuggerEvent)=>void)|undefinedconstructor(vm:Component|null,expOrFn:string|(()=>any),cb:Function,options?:WatcherOptions|null,isRenderWatcher?:boolean){recordEffectScope(this,iftheactiveeffectscopeismanuallycreated(notacomponentscope),prioritizeitactiveEffectScope&&!activeEffectScope._vm?activeEffectScope:vm?vm._scope:undefined)if((this.vm=vm)&&isRenderWatcher){vm._watcher=this}optionsif(options){this.deep=!!options.deepthis.user=!!options.userthis.lazy=!!options.lazythis.sync=!!options.syncthis.before=options.beforeif(__DEV__){this.onTrack=options.onTrackthis.onTrigger=options.onTrigger}}else{this.deep=this.user=this.lazy=this.sync=false}this.cb=cbthis.id=++uiduidforbatchingthis.active=truethis.post=falsethis.dirty=this.lazyforlazywatchersthis.deps=[]this.newDeps=[]this.depIds=newSet()this.newDepIds=newSet()this.expression=__DEV__?expOrFn.toString():''parseexpressionforgetterif(isFunction(expOrFn)){this.getter=expOrFn}else{this.getter=parsePath(expOrFn)if(!this.getter){this.getter=noop__DEV__&&warn(`Failedwatchingpath:"${expOrFn}"`+'Watcheronlyacceptssimpledot-delimitedpaths.'+'Forfullcontrol,useafunctioninstead.',vm)}}this.value=this.lazy?undefined:this.get()}/***Evaluatethegetter,andre-collectdependencies.*/get(){pushTarget(this)letvalueconstvm=this.vmtry{value=this.getter.call(vm,vm)}catch(e:any){if(this.user){handleError(e,vm,`getterforwatcher"${this.expression}"`)}else{throwe}}finally{"touch"everypropertysotheyarealltrackedasdependenciesfordeepwatchingif(this.deep){traverse(value)}popTarget()this.cleanupDeps()}returnvalue}/***Addadependencytothisdirective.*/addDep(dep:Dep){constid=dep.idif(!this.newDepIds.has(id)){this.newDepIds.add(id)this.newDeps.push(dep)if(!this.depIds.has(id)){dep.addSub(this)}}}/***Cleanupfordependencycollection.*/cleanupDeps(){leti=this.deps.lengthwhile(i--){constdep=this.deps[i]if(!this.newDepIds.has(dep.id)){dep.removeSub(this)}}lettmp:any=this.depIdsthis.depIds=this.newDepIdsthis.newDepIds=tmpthis.newDepIds.clear()tmp=this.depsthis.deps=this.newDepsthis.newDeps=tmpthis.newDeps.length=0}/***Subscriberinterface.*Willbecalledwhenadependencychanges.*/update(){/*istanbulignoreelse*/if(this.lazy){this.dirty=true}elseif(this.sync){this.run()}else{queueWatcher(this)}}/***Schedulerjobinterface.*Willbecalledbythescheduler.*/run(){if(this.active){constvalue=this.get()if(value!==this.value||DeepwatchersandwatchersonObject/Arraysshouldfireevenwhenthevalueisthesame,becausethevaluemayhavemutated.isObject(value)||this.deep){setnewvalueconstoldValue=this.valuethis.value=valueif(this.user){constinfo=`callbackforwatcher"${this.expression}"`invokeWithErrorHandling(this.cb,this.vm,[value,oldValue],this.vm,info)}else{this.cb.call(this.vm,value,oldValue)}}}}/***Evaluatethevalueofthewatcher.*Thisonlygetscalledforlazywatchers.*/evaluate(){this.value=this.get()this.dirty=false}/***Dependonalldepscollectedbythiswatcher.*/depend(){leti=this.deps.lengthwhile(i--){this.deps[i].depend()}}/***Removeselffromalldependencies'subscriberlist.*/teardown(){if(this.vm&&!this.vm._isBeingDestroyed){remove(this.vm._scope.effects,this)}if(this.active){leti=this.deps.lengthwhile(i--){this.deps[i].removeSub(this)}this.active=falseif(this.onStop){this.onStop()}}}}