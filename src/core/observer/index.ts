importDepfrom'./dep'importVNodefrom'../vdom/vnode'import{arrayMethods}from'./array'import{def,warn,hasOwn,isArray,hasProto,isPlainObject,isPrimitive,isUndef,isValidArrayIndex,isServerRendering,hasChanged,noop}from'../util/index'import{isReadonly,isRef,TrackOpTypes,TriggerOpTypes}from'../../v3'constarrayKeys=Object.getOwnPropertyNames(arrayMethods)constNO_INITIAL_VALUE={}/***Insomecaseswemaywanttodisableobservationinsideacomponent's*updatecomputation.*/exportletshouldObserve:boolean=trueexportfunctiontoggleObserving(value:boolean){shouldObserve=value}ssrmockdepconstmockDep={notify:noop,depend:noop,addSub:noop,removeSub:noop}asDep/***Observerclassthatisattachedtoeachobserved*object.Onceattached,theobserverconvertsthetarget*object'spropertykeysintogetter/settersthat*collectdependenciesanddispatchupdates.*/exportclassObserver{dep:DepvmCount:numbernumberofvmsthathavethisobjectasroot$dataconstructor(publicvalue:any,publicshallow=false,publicmock=false){this.value=valuethis.dep=mock?mockDep:newDep()this.vmCount=0def(value,'__ob__',this)if(isArray(value)){if(!mock){if(hasProto){/*eslint-disableno-proto*/;(valueasany).__proto__=arrayMethods/*eslint-enableno-proto*/}else{for(leti=0,l=arrayKeys.length;i<l;i++){constkey=arrayKeys[i]def(value,key,arrayMethods[key])}}}if(!shallow){this.observeArray(value)}}else{/***Walkthroughallpropertiesandconverttheminto*getter/setters.Thismethodshouldonlybecalledwhen*valuetypeisObject.*/constkeys=Object.keys(value)for(leti=0;i<keys.length;i++){constkey=keys[i]defineReactive(value,key,NO_INITIAL_VALUE,undefined,shallow,mock)}}}/***ObservealistofArrayitems.*/observeArray(value:any[]){for(leti=0,l=value.length;i<l;i++){observe(value[i],false,this.mock)}}}helpers/***Attempttocreateanobserverinstanceforavalue,*returnsthenewobserverifsuccessfullyobserved,*ortheexistingobserverifthevaluealreadyhasone.*/exportfunctionobserve(value:any,shallow?:boolean,ssrMockReactivity?:boolean):Observer|void{if(value&&hasOwn(value,'__ob__')&&value.__ob__instanceofObserver){returnvalue.__ob__}if(shouldObserve&&(ssrMockReactivity||!isServerRendering())&&(isArray(value)||isPlainObject(value))&&Object.isExtensible(value)&&!value.__v_skip/*ReactiveFlags.SKIP*/&&!isRef(value)&&!(valueinstanceofVNode)){returnnewObserver(value,shallow,ssrMockReactivity)}}/***DefineareactivepropertyonanObject.*/exportfunctiondefineReactive(obj:object,key:string,val?:any,customSetter?:Function|null,shallow?:boolean,mock?:boolean){constdep=newDep()constproperty=Object.getOwnPropertyDescriptor(obj,key)if(property&&property.configurable===false){return}caterforpre-definedgetter/settersconstgetter=property&&property.getconstsetter=property&&property.setif((!getter||setter)&&(val===NO_INITIAL_VALUE||arguments.length===2)){val=obj[key]}letchildOb=!shallow&&observe(val,false,mock)Object.defineProperty(obj,key,{enumerable:true,configurable:true,get:functionreactiveGetter(){constvalue=getter?getter.call(obj):valif(Dep.target){if(__DEV__){dep.depend({target:obj,type:TrackOpTypes.GET,key})}else{dep.depend()}if(childOb){childOb.dep.depend()if(isArray(value)){dependArray(value)}}}returnisRef(value)&&!shallow?value.value:value},set:functionreactiveSetter(newVal){constvalue=getter?getter.call(obj):valif(!hasChanged(value,newVal)){return}if(__DEV__&&customSetter){customSetter()}if(setter){setter.call(obj,newVal)}elseif(getter){#7981:foraccessorpropertieswithoutsetterreturn}elseif(!shallow&&isRef(value)&&!isRef(newVal)){value.value=newValreturn}else{val=newVal}childOb=!shallow&&observe(newVal,false,mock)if(__DEV__){dep.notify({type:TriggerOpTypes.SET,target:obj,key,newValue:newVal,oldValue:value})}else{dep.notify()}}})returndep}/***Setapropertyonanobject.Addsthenewpropertyand*triggerschangenotificationifthepropertydoesn't*alreadyexist.*/exportfunctionset<T>(array:T[],key:number,value:T):Texportfunctionset<T>(object:object,key:string|number,value:T):Texportfunctionset(target:any[]|Record<string,any>,key:any,val:any):any{if(__DEV__&&(isUndef(target)||isPrimitive(target))){warn(`Cannotsetreactivepropertyonundefined,null,orprimitivevalue:${target}`)}if(isReadonly(target)){__DEV__&&warn(`Setoperationonkey"${key}"failed:targetisreadonly.`)return}constob=(targetasany).__ob__if(isArray(target)&&isValidArrayIndex(key)){target.length=Math.max(target.length,key)target.splice(key,1,val)whenmockingforSSR,arraymethodsarenothijackedif(ob&&!ob.shallow&&ob.mock){observe(val,false,true)}returnval}if(keyintarget&&!(keyinObject.prototype)){target[key]=valreturnval}if((targetasany)._isVue||(ob&&ob.vmCount)){__DEV__&&warn('AvoidaddingreactivepropertiestoaVueinstanceoritsroot$data'+'atruntime-declareitupfrontinthedataoption.')returnval}if(!ob){target[key]=valreturnval}defineReactive(ob.value,key,val,undefined,ob.shallow,ob.mock)if(__DEV__){ob.dep.notify({type:TriggerOpTypes.ADD,target:target,key,newValue:val,oldValue:undefined})}else{ob.dep.notify()}returnval}/***Deleteapropertyandtriggerchangeifnecessary.*/exportfunctiondel<T>(array:T[],key:number):voidexportfunctiondel(object:object,key:string|number):voidexportfunctiondel(target:any[]|object,key:any){if(__DEV__&&(isUndef(target)||isPrimitive(target))){warn(`Cannotdeletereactivepropertyonundefined,null,orprimitivevalue:${target}`)}if(isArray(target)&&isValidArrayIndex(key)){target.splice(key,1)return}constob=(targetasany).__ob__if((targetasany)._isVue||(ob&&ob.vmCount)){__DEV__&&warn('AvoiddeletingpropertiesonaVueinstanceoritsroot$data'+'-justsetittonull.')return}if(isReadonly(target)){__DEV__&&warn(`Deleteoperationonkey"${key}"failed:targetisreadonly.`)return}if(!hasOwn(target,key)){return}deletetarget[key]if(!ob){return}if(__DEV__){ob.dep.notify({type:TriggerOpTypes.DELETE,target:target,key})}else{ob.dep.notify()}}/***Collectdependenciesonarrayelementswhenthearrayistouched,since*wecannotinterceptarrayelementaccesslikepropertygetters.*/functiondependArray(value:Array<any>){for(lete,i=0,l=value.length;i<l;i++){e=value[i]if(e&&e.__ob__){e.__ob__.dep.depend()}if(isArray(e)){dependArray(e)}}}