/***VirtualDOMpatchingalgorithmbasedonSnabbdomby*SimonFriisVindum(@paldepind)*LicensedundertheMITLicense*https://github.com/paldepind/snabbdom/blob/master/LICENSE**modifiedbyEvanYou(@yyx990803)**Nottype-checkingthisbecausethisfileisperf-criticalandthecost*ofmakingflowunderstanditisnotworthit.*/importVNode,{cloneVNode}from'./vnode'importconfigfrom'../config'import{SSR_ATTR}from'shared/constants'import{registerRef}from'./modules/template-ref'import{traverse}from'../observer/traverse'import{activeInstance}from'../instance/lifecycle'import{isTextInputType}from'web/util/element'import{warn,isDef,isUndef,isTrue,isArray,makeMap,isRegExp,isPrimitive}from'../util/index'exportconstemptyNode=newVNode('',{},[])consthooks=['create','activate','update','remove','destroy']functionsameVnode(a,b){return(a.key===b.key&&a.asyncFactory===b.asyncFactory&&((a.tag===b.tag&&a.isComment===b.isComment&&isDef(a.data)===isDef(b.data)&&sameInputType(a,b))||(isTrue(a.isAsyncPlaceholder)&&isUndef(b.asyncFactory.error))))}functionsameInputType(a,b){if(a.tag!=='input')returntrueleticonsttypeA=isDef((i=a.data))&&isDef((i=i.attrs))&&i.typeconsttypeB=isDef((i=b.data))&&isDef((i=i.attrs))&&i.typereturntypeA===typeB||(isTextInputType(typeA)&&isTextInputType(typeB))}functioncreateKeyToOldIdx(children,beginIdx,endIdx){leti,keyconstmap={}for(i=beginIdx;i<=endIdx;++i){key=children[i].keyif(isDef(key))map[key]=i}returnmap}exportfunctioncreatePatchFunction(backend){leti,jconstcbs:any={}const{modules,nodeOps}=backendfor(i=0;i<hooks.length;++i){cbs[hooks[i]]=[]for(j=0;j<modules.length;++j){if(isDef(modules[j][hooks[i]])){cbs[hooks[i]].push(modules[j][hooks[i]])}}}functionemptyNodeAt(elm){returnnewVNode(nodeOps.tagName(elm).toLowerCase(),{},[],undefined,elm)}functioncreateRmCb(childElm,listeners){functionremove(){if(--remove.listeners===0){removeNode(childElm)}}remove.listeners=listenersreturnremove}functionremoveNode(el){constparent=nodeOps.parentNode(el)//elementmayhavealreadybeenremovedduetov-html/v-textif(isDef(parent)){nodeOps.removeChild(parent,el)}}functionisUnknownElement(vnode,inVPre){return(!inVPre&&!vnode.ns&&!(config.ignoredElements.length&&config.ignoredElements.some(ignore=>{returnisRegExp(ignore)?ignore.test(vnode.tag):ignore===vnode.tag}))&&config.isUnknownElement(vnode.tag))}letcreatingElmInVPre=0functioncreateElm(vnode,insertedVnodeQueue,parentElm?:any,refElm?:any,nested?:any,ownerArray?:any,index?:any){if(isDef(vnode.elm)&&isDef(ownerArray)){//Thisvnodewasusedinapreviousrender!//nowit'susedasanewnode,overwritingitselmwouldcause//potentialpatcherrorsdowntheroadwhenit'susedasaninsertion//referencenode.Instead,weclonethenodeon-demandbeforecreating//associatedDOMelementforit.vnode=ownerArray[index]=cloneVNode(vnode)}vnode.isRootInsert=!nested//fortransitionentercheckif(createComponent(vnode,insertedVnodeQueue,parentElm,refElm)){return}constdata=vnode.dataconstchildren=vnode.childrenconsttag=vnode.tagif(isDef(tag)){if(__DEV__){if(data&&data.pre){creatingElmInVPre++}if(isUnknownElement(vnode,creatingElmInVPre)){warn('Unknowncustomelement:<'+tag+'>-didyou'+'registerthecomponentcorrectly?Forrecursivecomponents,'+'makesuretoprovidethe"name"option.',vnode.context)}}vnode.elm=vnode.ns?nodeOps.createElementNS(vnode.ns,tag):nodeOps.createElement(tag,vnode)setScope(vnode)createChildren(vnode,children,insertedVnodeQueue)if(isDef(data)){invokeCreateHooks(vnode,insertedVnodeQueue)}insert(parentElm,vnode.elm,refElm)if(__DEV__&&data&&data.pre){creatingElmInVPre--}}elseif(isTrue(vnode.isComment)){vnode.elm=nodeOps.createComment(vnode.text)insert(parentElm,vnode.elm,refElm)}else{vnode.elm=nodeOps.createTextNode(vnode.text)insert(parentElm,vnode.elm,refElm)}}functioncreateComponent(vnode,insertedVnodeQueue,parentElm,refElm){leti=vnode.dataif(isDef(i)){constisReactivated=isDef(vnode.componentInstance)&&i.keepAliveif(isDef((i=i.hook))&&isDef((i=i.init))){i(vnode,false/*hydrating*/)}//aftercallingtheinithook,ifthevnodeisachildcomponent//itshould'vecreatedachildinstanceandmountedit.thechild//componentalsohassettheplaceholdervnode'selm.//inthatcasewecanjustreturntheelementandbedone.if(isDef(vnode.componentInstance)){initComponent(vnode,insertedVnodeQueue)insert(parentElm,vnode.elm,refElm)if(isTrue(isReactivated)){reactivateComponent(vnode,insertedVnodeQueue,parentElm,refElm)}returntrue}}}functioninitComponent(vnode,insertedVnodeQueue){if(isDef(vnode.data.pendingInsert)){insertedVnodeQueue.push.apply(insertedVnodeQueue,vnode.data.pendingInsert)vnode.data.pendingInsert=null}vnode.elm=vnode.componentInstance.$elif(isPatchable(vnode)){invokeCreateHooks(vnode,insertedVnodeQueue)setScope(vnode)}else{//emptycomponentroot.//skipallelement-relatedmodulesexceptforref(#3455)registerRef(vnode)//makesuretoinvoketheinserthookinsertedVnodeQueue.push(vnode)}}functionreactivateComponent(vnode,insertedVnodeQueue,parentElm,refElm){leti//hackfor#4339:areactivatedcomponentwithinnertransition//doesnottriggerbecausetheinnernode'screatedhooksarenotcalled//again.It'snotidealtoinvolvemodule-specificlogicinherebut//theredoesn'tseemtobeabetterwaytodoit.letinnerNode=vnodewhile(innerNode.componentInstance){innerNode=innerNode.componentInstance._vnodeif(isDef((i=innerNode.data))&&isDef((i=i.transition))){for(i=0;i<cbs.activate.length;++i){cbs.activate[i](emptyNode,innerNode)}insertedVnodeQueue.push(innerNode)break}}//unlikeanewlycreatedcomponent,//areactivatedkeep-alivecomponentdoesn'tinsertitselfinsert(parentElm,vnode.elm,refElm)}functioninsert(parent,elm,ref){if(isDef(parent)){if(isDef(ref)){if(nodeOps.parentNode(ref)===parent){nodeOps.insertBefore(parent,elm,ref)}}else{nodeOps.appendChild(parent,elm)}}}functioncreateChildren(vnode,children,insertedVnodeQueue){if(isArray(children)){if(__DEV__){checkDuplicateKeys(children)}for(leti=0;i<children.length;++i){createElm(children[i],insertedVnodeQueue,vnode.elm,null,true,children,i)}}elseif(isPrimitive(vnode.text)){nodeOps.appendChild(vnode.elm,nodeOps.createTextNode(String(vnode.text)))}}functionisPatchable(vnode){while(vnode.componentInstance){vnode=vnode.componentInstance._vnode}returnisDef(vnode.tag)}functioninvokeCreateHooks(vnode,insertedVnodeQueue){for(leti=0;i<cbs.create.length;++i){cbs.create[i](emptyNode,vnode)}i=vnode.data.hook//Reusevariableif(isDef(i)){if(isDef(i.create))i.create(emptyNode,vnode)if(isDef(i.insert))insertedVnodeQueue.push(vnode)}}//setscopeidattributeforscopedCSS.//thisisimplementedasaspecialcasetoavoidtheoverhead//ofgoingthroughthenormalattributepatchingprocess.functionsetScope(vnode){letiif(isDef((i=vnode.fnScopeId))){nodeOps.setStyleScope(vnode.elm,i)}else{letancestor=vnodewhile(ancestor){if(isDef((i=ancestor.context))&&isDef((i=i.$options._scopeId))){nodeOps.setStyleScope(vnode.elm,i)}ancestor=ancestor.parent}}//forslotcontenttheyshouldalsogetthescopeIdfromthehostinstance.if(isDef((i=activeInstance))&&i!==vnode.context&&i!==vnode.fnContext&&isDef((i=i.$options._scopeId))){nodeOps.setStyleScope(vnode.elm,i)}}functionaddVnodes(parentElm,refElm,vnodes,startIdx,endIdx,insertedVnodeQueue){for(;startIdx<=endIdx;++startIdx){createElm(vnodes[startIdx],insertedVnodeQueue,parentElm,refElm,false,vnodes,startIdx)}}functioninvokeDestroyHook(vnode){leti,jconstdata=vnode.dataif(isDef(data)){if(isDef((i=data.hook))&&isDef((i=i.destroy)))i(vnode)for(i=0;i<cbs.destroy.length;++i)cbs.destroy[i](vnode)}if(isDef((i=vnode.children))){for(j=0;j<vnode.children.length;++j){invokeDestroyHook(vnode.children[j])}}}functionremoveVnodes(vnodes,startIdx,endIdx){for(;startIdx<=endIdx;++startIdx){constch=vnodes[startIdx]if(isDef(ch)){if(isDef(ch.tag)){removeAndInvokeRemoveHook(ch)invokeDestroyHook(ch)}else{//TextnoderemoveNode(ch.elm)}}}}functionremoveAndInvokeRemoveHook(vnode,rm?:any){if(isDef(rm)||isDef(vnode.data)){leticonstlisteners=cbs.remove.length+1if(isDef(rm)){//wehavearecursivelypasseddownrmcallback//increasethelistenerscountrm.listeners+=listeners}else{//directlyremovingrm=createRmCb(vnode.elm,listeners)}//recursivelyinvokehooksonchildcomponentrootnodeif(isDef((i=vnode.componentInstance))&&isDef((i=i._vnode))&&isDef(i.data)){removeAndInvokeRemoveHook(i,rm)}for(i=0;i<cbs.remove.length;++i){cbs.remove[i](vnode,rm)}if(isDef((i=vnode.data.hook))&&isDef((i=i.remove))){i(vnode,rm)}else{rm()}}else{removeNode(vnode.elm)}}functionupdateChildren(parentElm,oldCh,newCh,insertedVnodeQueue,removeOnly){letoldStartIdx=0letnewStartIdx=0letoldEndIdx=oldCh.length-1letoldStartVnode=oldCh[0]letoldEndVnode=oldCh[oldEndIdx]letnewEndIdx=newCh.length-1letnewStartVnode=newCh[0]letnewEndVnode=newCh[newEndIdx]letoldKeyToIdx,idxInOld,vnodeToMove,refElm//removeOnlyisaspecialflagusedonlyby<transition-group>//toensureremovedelementsstayincorrectrelativepositions//duringleavingtransitionsconstcanMove=!removeOnlyif(__DEV__){checkDuplicateKeys(newCh)}while(oldStartIdx<=oldEndIdx&&newStartIdx<=newEndIdx){if(isUndef(oldStartVnode)){oldStartVnode=oldCh[++oldStartIdx]//Vnodehasbeenmovedleft}elseif(isUndef(oldEndVnode)){oldEndVnode=oldCh[--oldEndIdx]}elseif(sameVnode(oldStartVnode,newStartVnode)){patchVnode(oldStartVnode,newStartVnode,insertedVnodeQueue,newCh,newStartIdx)oldStartVnode=oldCh[++oldStartIdx]newStartVnode=newCh[++newStartIdx]}elseif(sameVnode(oldEndVnode,newEndVnode)){patchVnode(oldEndVnode,newEndVnode,insertedVnodeQueue,newCh,newEndIdx)oldEndVnode=oldCh[--oldEndIdx]newEndVnode=newCh[--newEndIdx]}elseif(sameVnode(oldStartVnode,newEndVnode)){//VnodemovedrightpatchVnode(oldStartVnode,newEndVnode,insertedVnodeQueue,newCh,newEndIdx)canMove&&nodeOps.insertBefore(parentElm,oldStartVnode.elm,nodeOps.nextSibling(oldEndVnode.elm))oldStartVnode=oldCh[++oldStartIdx]newEndVnode=newCh[--newEndIdx]}elseif(sameVnode(oldEndVnode,newStartVnode)){//VnodemovedleftpatchVnode(oldEndVnode,newStartVnode,insertedVnodeQueue,newCh,newStartIdx)canMove&&nodeOps.insertBefore(parentElm,oldEndVnode.elm,oldStartVnode.elm)oldEndVnode=oldCh[--oldEndIdx]newStartVnode=newCh[++newStartIdx]}else{if(isUndef(oldKeyToIdx))oldKeyToIdx=createKeyToOldIdx(oldCh,oldStartIdx,oldEndIdx)idxInOld=isDef(newStartVnode.key)?oldKeyToIdx[newStartVnode.key]:findIdxInOld(newStartVnode,oldCh,oldStartIdx,oldEndIdx)if(isUndef(idxInOld)){//NewelementcreateElm(newStartVnode,insertedVnodeQueue,parentElm,oldStartVnode.elm,false,newCh,newStartIdx)}else{vnodeToMove=oldCh[idxInOld]if(sameVnode(vnodeToMove,newStartVnode)){patchVnode(vnodeToMove,newStartVnode,insertedVnodeQueue,newCh,newStartIdx)oldCh[idxInOld]=undefinedcanMove&&nodeOps.insertBefore(parentElm,vnodeToMove.elm,oldStartVnode.elm)}else{//samekeybutdifferentelement.treatasnewelementcreateElm(newStartVnode,insertedVnodeQueue,parentElm,oldStartVnode.elm,false,newCh,newStartIdx)}}newStartVnode=newCh[++newStartIdx]}}if(oldStartIdx>oldEndIdx){refElm=isUndef(newCh[newEndIdx+1])?null:newCh[newEndIdx+1].elmaddVnodes(parentElm,refElm,newCh,newStartIdx,newEndIdx,insertedVnodeQueue)}elseif(newStartIdx>newEndIdx){removeVnodes(oldCh,oldStartIdx,oldEndIdx)}}functioncheckDuplicateKeys(children){constseenKeys={}for(leti=0;i<children.length;i++){constvnode=children[i]constkey=vnode.keyif(isDef(key)){if(seenKeys[key]){warn(`Duplicatekeysdetected:'${key}'.Thismaycauseanupdateerror.`,vnode.context)}else{seenKeys[key]=true}}}}functionfindIdxInOld(node,oldCh,start,end){for(leti=start;i<end;i++){constc=oldCh[i]if(isDef(c)&&sameVnode(node,c))returni}}functionpatchVnode(oldVnode,vnode,insertedVnodeQueue,ownerArray,index,removeOnly?:any){if(oldVnode===vnode){return}if(isDef(vnode.elm)&&isDef(ownerArray)){//clonereusedvnodevnode=ownerArray[index]=cloneVNode(vnode)}constelm=(vnode.elm=oldVnode.elm)if(isTrue(oldVnode.isAsyncPlaceholder)){if(isDef(vnode.asyncFactory.resolved)){hydrate(oldVnode.elm,vnode,insertedVnodeQueue)}else{vnode.isAsyncPlaceholder=true}return}//reuseelementforstatictrees.//noteweonlydothisifthevnodeiscloned-//ifthenewnodeisnotcloneditmeanstherenderfunctionshavebeen//resetbythehot-reload-apiandweneedtodoaproperre-render.if(isTrue(vnode.isStatic)&&isTrue(oldVnode.isStatic)&&vnode.key===oldVnode.key&&(isTrue(vnode.isCloned)||isTrue(vnode.isOnce))){vnode.componentInstance=oldVnode.componentInstancereturn}leticonstdata=vnode.dataif(isDef(data)&&isDef((i=data.hook))&&isDef((i=i.prepatch))){i(oldVnode,vnode)}constoldCh=oldVnode.childrenconstch=vnode.childrenif(isDef(data)&&isPatchable(vnode)){for(i=0;i<cbs.update.length;++i)cbs.update[i](oldVnode,vnode)if(isDef((i=data.hook))&&isDef((i=i.update)))i(oldVnode,vnode)}if(isUndef(vnode.text)){if(isDef(oldCh)&&isDef(ch)){if(oldCh!==ch)updateChildren(elm,oldCh,ch,insertedVnodeQueue,removeOnly)}elseif(isDef(ch)){if(__DEV__){checkDuplicateKeys(ch)}if(isDef(oldVnode.text))nodeOps.setTextContent(elm,'')addVnodes(elm,null,ch,0,ch.length-1,insertedVnodeQueue)}elseif(isDef(oldCh)){removeVnodes(oldCh,0,oldCh.length-1)}elseif(isDef(oldVnode.text)){nodeOps.setTextContent(elm,'')}}elseif(oldVnode.text!==vnode.text){nodeOps.setTextContent(elm,vnode.text)}if(isDef(data)){if(isDef((i=data.hook))&&isDef((i=i.postpatch)))i(oldVnode,vnode)}}functioninvokeInsertHook(vnode,queue,initial){//delayinserthooksforcomponentrootnodes,invokethemafterthe//elementisreallyinsertedif(isTrue(initial)&&isDef(vnode.parent)){vnode.parent.data.pendingInsert=queue}else{for(leti=0;i<queue.length;++i){queue[i].data.hook.insert(queue[i])}}}lethydrationBailed=false//listofmodulesthatcanskipcreatehookduringhydrationbecausethey//arealreadyrenderedontheclientorhasnoneedforinitialization//Note:styleisexcludedbecauseitreliesoninitialcloneforfuture//deepupdates(#7063).constisRenderedModule=makeMap('attrs,class,staticClass,staticStyle,key')//Note:thisisabrowser-onlyfunctionsowecanassumeelmsareDOMnodes.functionhydrate(elm,vnode,insertedVnodeQueue,inVPre?:boolean){leticonst{tag,data,children}=vnodeinVPre=inVPre||(data&&data.pre)vnode.elm=elmif(isTrue(vnode.isComment)&&isDef(vnode.asyncFactory)){vnode.isAsyncPlaceholder=truereturntrue}//assertnodematchif(__DEV__){if(!assertNodeMatch(elm,vnode,inVPre)){returnfalse}}if(isDef(data)){if(isDef((i=data.hook))&&isDef((i=i.init)))i(vnode,true/*hydrating*/)if(isDef((i=vnode.componentInstance))){//childcomponent.itshouldhavehydrateditsowntree.initComponent(vnode,insertedVnodeQueue)returntrue}}if(isDef(tag)){if(isDef(children)){//emptyelement,allowclienttopickupandpopulatechildrenif(!elm.hasChildNodes()){createChildren(vnode,children,insertedVnodeQueue)}else{//v-htmlanddomProps:innerHTMLif(isDef((i=data))&&isDef((i=i.domProps))&&isDef((i=i.innerHTML))){if(i!==elm.innerHTML){/*istanbulignoreif*/if(__DEV__&&typeofconsole!=='undefined'&&!hydrationBailed){hydrationBailed=trueconsole.warn('Parent:',elm)console.warn('serverinnerHTML:',i)console.warn('clientinnerHTML:',elm.innerHTML)}returnfalse}}else{//iterateandcomparechildrenlistsletchildrenMatch=trueletchildNode=elm.firstChildfor(leti=0;i<children.length;i++){if(!childNode||!hydrate(childNode,children[i],insertedVnodeQueue,inVPre)){childrenMatch=falsebreak}childNode=childNode.nextSibling}//ifchildNodeisnotnull,itmeanstheactualchildNodeslistis//longerthanthevirtualchildrenlist.if(!childrenMatch||childNode){/*istanbulignoreif*/if(__DEV__&&typeofconsole!=='undefined'&&!hydrationBailed){hydrationBailed=trueconsole.warn('Parent:',elm)console.warn('MismatchingchildNodesvs.VNodes:',elm.childNodes,children)}returnfalse}}}}if(isDef(data)){letfullInvoke=falsefor(constkeyindata){if(!isRenderedModule(key)){fullInvoke=trueinvokeCreateHooks(vnode,insertedVnodeQueue)break}}if(!fullInvoke&&data['class']){//ensurecollectingdepsfordeepclassbindingsforfutureupdatestraverse(data['class'])}}}elseif(elm.data!==vnode.text){elm.data=vnode.text}returntrue}functionassertNodeMatch(node,vnode,inVPre){if(isDef(vnode.tag)){return(vnode.tag.indexOf('vue-component')===0||(!isUnknownElement(vnode,inVPre)&&vnode.tag.toLowerCase()===(node.tagName&&node.tagName.toLowerCase())))}else{returnnode.nodeType===(vnode.isComment?8:3)}}returnfunctionpatch(oldVnode,vnode,hydrating,removeOnly){if(isUndef(vnode)){if(isDef(oldVnode))invokeDestroyHook(oldVnode)return}letisInitialPatch=falseconstinsertedVnodeQueue:any[]=[]if(isUndef(oldVnode)){//emptymount(likelyascomponent),createnewrootelementisInitialPatch=truecreateElm(vnode,insertedVnodeQueue)}else{constisRealElement=isDef(oldVnode.nodeType)if(!isRealElement&&sameVnode(oldVnode,vnode)){//patchexistingrootnodepatchVnode(oldVnode,vnode,insertedVnodeQueue,null,null,removeOnly)}else{if(isRealElement){//mountingtoarealelement//checkifthisisserver-renderedcontentandifwecanperform//asuccessfulhydration.if(oldVnode.nodeType===1&&oldVnode.hasAttribute(SSR_ATTR)){oldVnode.removeAttribute(SSR_ATTR)hydrating=true}if(isTrue(hydrating)){if(hydrate(oldVnode,vnode,insertedVnodeQueue)){invokeInsertHook(vnode,insertedVnodeQueue,true)returnoldVnode}elseif(__DEV__){warn('Theclient-siderenderedvirtualDOMtreeisnotmatching'+'server-renderedcontent.Thisislikelycausedbyincorrect'+'HTMLmarkup,forexamplenestingblock-levelelementsinside'+'<p>,ormissing<tbody>.Bailinghydrationandperforming'+'fullclient-siderender.')}}//eithernotserver-rendered,orhydrationfailed.//createanemptynodeandreplaceitoldVnode=emptyNodeAt(oldVnode)}//replacingexistingelementconstoldElm=oldVnode.elmconstparentElm=nodeOps.parentNode(oldElm)//createnewnodecreateElm(vnode,insertedVnodeQueue,//extremelyrareedgecase:donotinsertifoldelementisina//leavingtransition.Onlyhappenswhencombiningtransition+//keep-alive+HOCs.(#4590)oldElm._leaveCb?null:parentElm,nodeOps.nextSibling(oldElm))//updateparentplaceholdernodeelement,recursivelyif(isDef(vnode.parent)){letancestor=vnode.parentconstpatchable=isPatchable(vnode)while(ancestor){for(leti=0;i<cbs.destroy.length;++i){cbs.destroy[i](ancestor)}ancestor.elm=vnode.elmif(patchable){for(leti=0;i<cbs.create.length;++i){cbs.create[i](emptyNode,ancestor)}//#6513//invokeinserthooksthatmayhavebeenmergedbycreatehooks.//e.g.fordirectivesthatusesthe"inserted"hook.constinsert=ancestor.data.hook.insertif(insert.merged){//startatindex1toavoidre-invokingcomponentmountedhookfor(leti=1;i<insert.fns.length;i++){insert.fns[i]()}}}else{registerRef(ancestor)}ancestor=ancestor.parent}}//destroyoldnodeif(isDef(parentElm)){removeVnodes([oldVnode],0,0)}elseif(isDef(oldVnode.tag)){invokeDestroyHook(oldVnode)}}}invokeInsertHook(vnode,insertedVnodeQueue,isInitialPatch)returnvnode.elm}}