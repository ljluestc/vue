import{def}from'core/util/lang'import{normalizeChildren}from'core/vdom/helpers/normalize-children'import{emptyObject,isArray}from'shared/util'import{isAsyncPlaceholder}from'./is-async-placeholder'importtypeVNodefrom'../vnode'import{Component}from'types/component'import{currentInstance,setCurrentInstance}from'v3/currentInstance'exportfunctionnormalizeScopedSlots(ownerVm:Component,scopedSlots:{[key:string]:Function}|undefined,normalSlots:{[key:string]:VNode[]},prevScopedSlots?:{[key:string]:Function}):any{letresconsthasNormalSlots=Object.keys(normalSlots).length>0constisStable=scopedSlots?!!scopedSlots.$stable:!hasNormalSlotsconstkey=scopedSlots&&scopedSlots.$keyif(!scopedSlots){res={}}elseif(scopedSlots._normalized){//fastpath1:childcomponentre-renderonly,parentdidnotchangereturnscopedSlots._normalized}elseif(isStable&&prevScopedSlots&&prevScopedSlots!==emptyObject&&key===prevScopedSlots.$key&&!hasNormalSlots&&!prevScopedSlots.$hasNormal){//fastpath2:stablescopedslotsw/nonormalslotstoproxy,//onlyneedtonormalizeoncereturnprevScopedSlots}else{res={}for(constkeyinscopedSlots){if(scopedSlots[key]&&key[0]!=='$'){res[key]=normalizeScopedSlot(ownerVm,normalSlots,key,scopedSlots[key])}}}//exposenormalslotsonscopedSlotsfor(constkeyinnormalSlots){if(!(keyinres)){res[key]=proxyNormalSlot(normalSlots,key)}}//avoriazseemstomockanon-extensible$scopedSlotsobject//andwhenthatispasseddownthiswouldcauseanerrorif(scopedSlots&&Object.isExtensible(scopedSlots)){scopedSlots._normalized=res}def(res,'$stable',isStable)def(res,'$key',key)def(res,'$hasNormal',hasNormalSlots)returnres}functionnormalizeScopedSlot(vm,normalSlots,key,fn){constnormalized=function(){constcur=currentInstancesetCurrentInstance(vm)letres=arguments.length?fn.apply(null,arguments):fn({})res=res&&typeofres==='object'&&!isArray(res)?[res]//singlevnode:normalizeChildren(res)constvnode:VNode|null=res&&res[0]setCurrentInstance(cur)returnres&&(!vnode||(res.length===1&&vnode.isComment&&!isAsyncPlaceholder(vnode)))//#9658,#10391?undefined:res}//thisisaslotusingthenewv-slotsyntaxwithoutscope.althoughitis//compiledasascopedslot,renderfnuserswouldexpectittobepresent//onthis.$slotsbecausetheusageissemanticallyanormalslot.if(fn.proxy){Object.defineProperty(normalSlots,key,{get:normalized,enumerable:true,configurable:true})}returnnormalized}functionproxyNormalSlot(slots,key){return()=>slots[key]}