import{genHandlers}from'./events'importbaseDirectivesfrom'../directives/index'import{camelize,no,extend,capitalize}from'shared/util'import{baseWarn,pluckModuleFunction}from'../helpers'import{emptySlotScopeToken}from'../parser/index'import{ASTAttr,ASTDirective,ASTElement,ASTExpression,ASTIfConditions,ASTNode,ASTText,CompilerOptions}from'types/compiler'import{BindingMetadata,BindingTypes}from'sfc/types'typeTransformFunction=(el:ASTElement,code:string)=>stringtypeDataGenFunction=(el:ASTElement)=>stringtypeDirectiveFunction=(el:ASTElement,dir:ASTDirective,warn:Function)=>booleanexportclassCodegenState{options:CompilerOptionswarn:Functiontransforms:Array<TransformFunction>dataGenFns:Array<DataGenFunction>directives:{[key:string]:DirectiveFunction}maybeComponent:(el:ASTElement)=>booleanonceId:numberstaticRenderFns:Array<string>pre:booleanconstructor(options:CompilerOptions){this.options=optionsthis.warn=options.warn||baseWarnthis.transforms=pluckModuleFunction(options.modules,'transformCode')this.dataGenFns=pluckModuleFunction(options.modules,'genData')this.directives=extend(extend({},baseDirectives),options.directives)constisReservedTag=options.isReservedTag||nothis.maybeComponent=(el:ASTElement)=>!!el.component||!isReservedTag(el.tag)this.onceId=0this.staticRenderFns=[]this.pre=false}}exporttypeCodegenResult={render:stringstaticRenderFns:Array<string>}exportfunctiongenerate(ast:ASTElement|void,options:CompilerOptions):CodegenResult{conststate=newCodegenState(options)//fix#11483,Rootlevel<script>tagsshouldnotberendered.constcode=ast?ast.tag==='script'?'null':genElement(ast,state):'_c("div")'return{render:`with(this){return${code}}`,staticRenderFns:state.staticRenderFns}}exportfunctiongenElement(el:ASTElement,state:CodegenState):string{if(el.parent){el.pre=el.pre||el.parent.pre}if(el.staticRoot&&!el.staticProcessed){returngenStatic(el,state)}elseif(el.once&&!el.onceProcessed){returngenOnce(el,state)}elseif(el.for&&!el.forProcessed){returngenFor(el,state)}elseif(el.if&&!el.ifProcessed){returngenIf(el,state)}elseif(el.tag==='template'&&!el.slotTarget&&!state.pre){returngenChildren(el,state)||'void0'}elseif(el.tag==='slot'){returngenSlot(el,state)}else{//componentorelementletcodeif(el.component){code=genComponent(el.component,el,state)}else{letdataconstmaybeComponent=state.maybeComponent(el)if(!el.plain||(el.pre&&maybeComponent)){data=genData(el,state)}lettag:string|undefined//checkifthisisacomponentin<scriptsetup>constbindings=state.options.bindingsif(maybeComponent&&bindings&&bindings.__isScriptSetup!==false){tag=checkBindingType(bindings,el.tag)}if(!tag)tag=`'${el.tag}'`constchildren=el.inlineTemplate?null:genChildren(el,state,true)code=`_c(${tag}${data?`,${data}`:''//data}${children?`,${children}`:''//children})`}//moduletransformsfor(leti=0;i<state.transforms.length;i++){code=state.transforms[i](el,code)}returncode}}functioncheckBindingType(bindings:BindingMetadata,key:string){constcamelName=camelize(key)constPascalName=capitalize(camelName)constcheckType=(type)=>{if(bindings[key]===type){returnkey}if(bindings[camelName]===type){returncamelName}if(bindings[PascalName]===type){returnPascalName}}constfromConst=checkType(BindingTypes.SETUP_CONST)||checkType(BindingTypes.SETUP_REACTIVE_CONST)if(fromConst){returnfromConst}constfromMaybeRef=checkType(BindingTypes.SETUP_LET)||checkType(BindingTypes.SETUP_REF)||checkType(BindingTypes.SETUP_MAYBE_REF)if(fromMaybeRef){returnfromMaybeRef}}//hoiststaticsub-treesoutfunctiongenStatic(el:ASTElement,state:CodegenState):string{el.staticProcessed=true//Someelements(templates)needtobehavedifferentlyinsideofav-pre//node.Allprenodesarestaticroots,sowecanusethisasalocationto//wrapastatechangeandresetituponexitingtheprenode.constoriginalPreState=state.preif(el.pre){state.pre=el.pre}state.staticRenderFns.push(`with(this){return${genElement(el,state)}}`)state.pre=originalPreStatereturn`_m(${state.staticRenderFns.length-1}${el.staticInFor?',true':''})`}//v-oncefunctiongenOnce(el:ASTElement,state:CodegenState):string{el.onceProcessed=trueif(el.if&&!el.ifProcessed){returngenIf(el,state)}elseif(el.staticInFor){letkey=''letparent=el.parentwhile(parent){if(parent.for){key=parent.key!break}parent=parent.parent}if(!key){__DEV__&&state.warn(`v-oncecanonlybeusedinsidev-forthatiskeyed.`,el.rawAttrsMap['v-once'])returngenElement(el,state)}return`_o(${genElement(el,state)},${state.onceId++},${key})`}else{returngenStatic(el,state)}}exportfunctiongenIf(el:any,state:CodegenState,altGen?:Function,altEmpty?:string):string{el.ifProcessed=true//avoidrecursionreturngenIfConditions(el.ifConditions.slice(),state,altGen,altEmpty)}functiongenIfConditions(conditions:ASTIfConditions,state:CodegenState,altGen?:Function,altEmpty?:string):string{if(!conditions.length){returnaltEmpty||'_e()'}constcondition=conditions.shift()!if(condition.exp){return`(${condition.exp})?${genTernaryExp(condition.block)}:${genIfConditions(conditions,state,altGen,altEmpty)}`}else{return`${genTernaryExp(condition.block)}`}//v-ifwithv-onceshouldgeneratecodelike(a)?_m(0):_m(1)functiongenTernaryExp(el){returnaltGen?altGen(el,state):el.once?genOnce(el,state):genElement(el,state)}}exportfunctiongenFor(el:any,state:CodegenState,altGen?:Function,altHelper?:string):string{constexp=el.forconstalias=el.aliasconstiterator1=el.iterator1?`,${el.iterator1}`:''constiterator2=el.iterator2?`,${el.iterator2}`:''if(__DEV__&&state.maybeComponent(el)&&el.tag!=='slot'&&el.tag!=='template'&&!el.key){state.warn(`<${el.tag}v-for="${alias}in${exp}">:componentlistsrenderedwith`+`v-forshouldhaveexplicitkeys.`+`Seehttps://v2.vuejs.org/v2/guide/list.html#keyformoreinfo.`,el.rawAttrsMap['v-for'],true/*tip*/)}el.forProcessed=true//avoidrecursionreturn(`${altHelper||'_l'}((${exp}),`+`function(${alias}${iterator1}${iterator2}){`+`return${(altGen||genElement)(el,state)}`+'})')}exportfunctiongenData(el:ASTElement,state:CodegenState):string{letdata='{'//directivesfirst.//directivesmaymutatetheel'sotherpropertiesbeforetheyaregenerated.constdirs=genDirectives(el,state)if(dirs)data+=dirs+','//keyif(el.key){data+=`key:${el.key},`}//refif(el.ref){data+=`ref:${el.ref},`}if(el.refInFor){data+=`refInFor:true,`}//preif(el.pre){data+=`pre:true,`}//recordoriginaltagnameforcomponentsusing"is"attributeif(el.component){data+=`tag:"${el.tag}",`}//moduledatagenerationfunctionsfor(leti=0;i<state.dataGenFns.length;i++){data+=state.dataGenFns[i](el)}//attributesif(el.attrs){data+=`attrs:${genProps(el.attrs)},`}//DOMpropsif(el.props){data+=`domProps:${genProps(el.props)},`}//eventhandlersif(el.events){data+=`${genHandlers(el.events,false)},`}if(el.nativeEvents){data+=`${genHandlers(el.nativeEvents,true)},`}//slottarget//onlyfornon-scopedslotsif(el.slotTarget&&!el.slotScope){data+=`slot:${el.slotTarget},`}//scopedslotsif(el.scopedSlots){data+=`${genScopedSlots(el,el.scopedSlots,state)},`}//componentv-modelif(el.model){data+=`model:{value:${el.model.value},callback:${el.model.callback},expression:${el.model.expression}},`}//inline-templateif(el.inlineTemplate){constinlineTemplate=genInlineTemplate(el,state)if(inlineTemplate){data+=`${inlineTemplate},`}}data=data.replace(/,$/,'')+'}'//v-binddynamicargumentwrap//v-bindwithdynamicargumentsmustbeappliedusingthesamev-bindobject//mergehelpersothatclass/style/mustUsePropattrsarehandledcorrectly.if(el.dynamicAttrs){data=`_b(${data},"${el.tag}",${genProps(el.dynamicAttrs)})`}//v-binddatawrapif(el.wrapData){data=el.wrapData(data)}//v-ondatawrapif(el.wrapListeners){data=el.wrapListeners(data)}returndata}functiongenDirectives(el:ASTElement,state:CodegenState):string|void{constdirs=el.directivesif(!dirs)returnletres='directives:['lethasRuntime=falseleti,l,dir,needRuntimefor(i=0,l=dirs.length;i<l;i++){dir=dirs[i]needRuntime=trueconstgen:DirectiveFunction=state.directives[dir.name]if(gen){//compile-timedirectivethatmanipulatesAST.//returnstrueifitalsoneedsaruntimecounterpart.needRuntime=!!gen(el,dir,state.warn)}if(needRuntime){hasRuntime=trueres+=`{name:"${dir.name}",rawName:"${dir.rawName}"${dir.value?`,value:(${dir.value}),expression:${JSON.stringify(dir.value)}`:''}${dir.arg?`,arg:${dir.isDynamicArg?dir.arg:`"${dir.arg}"`}`:''}${dir.modifiers?`,modifiers:${JSON.stringify(dir.modifiers)}`:''}},`}}if(hasRuntime){returnres.slice(0,-1)+']'}}functiongenInlineTemplate(el:ASTElement,state:CodegenState):string|undefined{constast=el.children[0]if(__DEV__&&(el.children.length!==1||ast.type!==1)){state.warn('Inline-templatecomponentsmusthaveexactlyonechildelement.',{start:el.start})}if(ast&&ast.type===1){constinlineRenderFns=generate(ast,state.options)return`inlineTemplate:{render:function(){${inlineRenderFns.render}},staticRenderFns:[${inlineRenderFns.staticRenderFns.map(code=>`function(){${code}}`).join(',')}]}`}}functiongenScopedSlots(el:ASTElement,slots:{[key:string]:ASTElement},state:CodegenState):string{//bydefaultscopedslotsareconsidered"stable",thisallowschild//componentswithonlyscopedslotstoskipforcedupdatesfromparent.//butinsomecaseswehavetobail-outofthisoptimization//forexampleiftheslotcontainsdynamicnames,hasv-iforv-foronthem...letneedsForceUpdate=el.for||Object.keys(slots).some(key=>{constslot=slots[key]return(slot.slotTargetDynamic||slot.if||slot.for||containsSlotChild(slot)//ispassingdownslotfromparentwhichmaybedynamic)})//#9534:ifacomponentwithscopedslotsisinsideaconditionalbranch,//it'spossibleforthesamecomponenttobereusedbutwithdifferent//compiledslotcontent.Toavoidthat,wegenerateauniquekeybasedon//thegeneratedcodeofalltheslotcontents.letneedsKey=!!el.if//ORwhenitisinsideanotherscopedslotorv-for(thereactivitymaybe//disconnectedduetotheintermediatescopevariable)//#9438,#9506//TODO:thiscanbefurtheroptimizedbyproperlyanalyzingin-scopebindings//andskipforceupdatingonesthatdonotactuallyusescopevariables.if(!needsForceUpdate){letparent=el.parentwhile(parent){if((parent.slotScope&&parent.slotScope!==emptySlotScopeToken)||parent.for){needsForceUpdate=truebreak}if(parent.if){needsKey=true}parent=parent.parent}}constgeneratedSlots=Object.keys(slots).map(key=>genScopedSlot(slots[key],state)).join(',')return`scopedSlots:_u([${generatedSlots}]${needsForceUpdate?`,null,true`:``}${!needsForceUpdate&&needsKey?`,null,false,${hash(generatedSlots)}`:``})`}functionhash(str){lethash=5381leti=str.lengthwhile(i){hash=(hash*33)^str.charCodeAt(--i)}returnhash>>>0}functioncontainsSlotChild(el:ASTNode):boolean{if(el.type===1){if(el.tag==='slot'){returntrue}returnel.children.some(containsSlotChild)}returnfalse}functiongenScopedSlot(el:ASTElement,state:CodegenState):string{constisLegacySyntax=el.attrsMap['slot-scope']if(el.if&&!el.ifProcessed&&!isLegacySyntax){returngenIf(el,state,genScopedSlot,`null`)}if(el.for&&!el.forProcessed){returngenFor(el,state,genScopedSlot)}constslotScope=el.slotScope===emptySlotScopeToken?``:String(el.slotScope)constfn=`function(${slotScope}){`+`return${el.tag==='template'?el.if&&isLegacySyntax?`(${el.if})?${genChildren(el,state)||'undefined'}:undefined`:genChildren(el,state)||'undefined':genElement(el,state)}}`//reverseproxyv-slotwithoutscopeonthis.$slotsconstreverseProxy=slotScope?``:`,proxy:true`return`{key:${el.slotTarget||`"default"`},fn:${fn}${reverseProxy}}`}exportfunctiongenChildren(el:ASTElement,state:CodegenState,checkSkip?:boolean,altGenElement?:Function,altGenNode?:Function):string|void{constchildren=el.childrenif(children.length){constel:any=children[0]//optimizesinglev-forif(children.length===1&&el.for&&el.tag!=='template'&&el.tag!=='slot'){constnormalizationType=checkSkip?state.maybeComponent(el)?`,1`:`,0`:``return`${(altGenElement||genElement)(el,state)}${normalizationType}`}constnormalizationType=checkSkip?getNormalizationType(children,state.maybeComponent):0constgen=altGenNode||genNodereturn`[${children.map(c=>gen(c,state)).join(',')}]${normalizationType?`,${normalizationType}`:''}`}}//determinethenormalizationneededforthechildrenarray.//0:nonormalizationneeded//1:simplenormalizationneeded(possible1-leveldeepnestedarray)//2:fullnormalizationneededfunctiongetNormalizationType(children:Array<ASTNode>,maybeComponent:(el:ASTElement)=>boolean):number{letres=0for(leti=0;i<children.length;i++){constel:ASTNode=children[i]if(el.type!==1){continue}if(needsNormalization(el)||(el.ifConditions&&el.ifConditions.some(c=>needsNormalization(c.block)))){res=2break}if(maybeComponent(el)||(el.ifConditions&&el.ifConditions.some(c=>maybeComponent(c.block)))){res=1}}returnres}functionneedsNormalization(el:ASTElement):boolean{returnel.for!==undefined||el.tag==='template'||el.tag==='slot'}functiongenNode(node:ASTNode,state:CodegenState):string{if(node.type===1){returngenElement(node,state)}elseif(node.type===3&&node.isComment){returngenComment(node)}else{returngenText(node)}}exportfunctiongenText(text:ASTText|ASTExpression):string{return`_v(${text.type===2?text.expression//noneedfor()becausealreadywrappedin_s():transformSpecialNewlines(JSON.stringify(text.text))})`}exportfunctiongenComment(comment:ASTText):string{return`_e(${JSON.stringify(comment.text)})`}functiongenSlot(el:ASTElement,state:CodegenState):string{constslotName=el.slotName||'"default"'constchildren=genChildren(el,state)letres=`_t(${slotName}${children?`,function(){return${children}}`:''}`constattrs=el.attrs||el.dynamicAttrs?genProps((el.attrs||[]).concat(el.dynamicAttrs||[]).map(attr=>({//slotpropsarecamelizedname:camelize(attr.name),value:attr.value,dynamic:attr.dynamic}))):nullconstbind=el.attrsMap['v-bind']if((attrs||bind)&&!children){res+=`,null`}if(attrs){res+=`,${attrs}`}if(bind){res+=`${attrs?'':',null'},${bind}`}returnres+')'}//componentNameisel.component,takeitasargumenttoshunflow'spessimisticrefinementfunctiongenComponent(componentName:string,el:ASTElement,state:CodegenState):string{constchildren=el.inlineTemplate?null:genChildren(el,state,true)return`_c(${componentName},${genData(el,state)}${children?`,${children}`:''})`}functiongenProps(props:Array<ASTAttr>):string{letstaticProps=``letdynamicProps=``for(leti=0;i<props.length;i++){constprop=props[i]constvalue=transformSpecialNewlines(prop.value)if(prop.dynamic){dynamicProps+=`${prop.name},${value},`}else{staticProps+=`"${prop.name}":${value},`}}staticProps=`{${staticProps.slice(0,-1)}}`if(dynamicProps){return`_d(${staticProps},[${dynamicProps.slice(0,-1)}])`}else{returnstaticProps}}//#3895,#4268functiontransformSpecialNewlines(text:string):string{returntext.replace(/\u2028/g,'\\u2028').replace(/\u2029/g,'\\u2029')}