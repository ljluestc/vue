importhefrom'he'import{parseHTML}from'./html-parser'import{parseText}from'./text-parser'import{parseFilters}from'./filter-parser'import{genAssignmentCode}from'../directives/model'import{extend,cached,no,camelize,hyphenate}from'shared/util'import{isIE,isEdge,isServerRendering}from'core/util/env'import{addProp,addAttr,baseWarn,addHandler,addDirective,getBindingAttr,getAndRemoveAttr,getRawBindingAttr,pluckModuleFunction,getAndRemoveAttrByRegex}from'../helpers'import{ASTAttr,ASTElement,ASTIfCondition,ASTNode,ASTText,CompilerOptions}from'types/compiler'exportconstonRE=/^@|^v-on:/exportconstdirRE=process.env.VBIND_PROP_SHORTHAND?/^v-|^@|^:|^\.|^#/:/^v-|^@|^:|^#/exportconstforAliasRE=/([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/exportconstforIteratorRE=/,([^,\}\]]*)(?:,([^,\}\]]*))?$/conststripParensRE=/^\(|\)$/gconstdynamicArgRE=/^\[.*\]$/constargRE=/:(.*)$/exportconstbindRE=/^:|^\.|^v-bind:/constpropBindRE=/^\./constmodifierRE=/\.[^.\]]+(?=[^\]]*$)/gexportconstslotRE=/^v-slot(:|$)|^#/constlineBreakRE=/[\r\n]/constwhitespaceRE=/[\f\t\r\n]+/gconstinvalidAttributeRE=/[\s"'<>\/=]/constdecodeHTMLCached=cached(he.decode)exportconstemptySlotScopeToken=`_empty_`//configurablestateexportletwarn:anyletdelimiterslettransformsletpreTransformsletpostTransformsletplatformIsPreTagletplatformMustUsePropletplatformGetTagNamespaceletmaybeComponentexportfunctioncreateASTElement(tag:string,attrs:Array<ASTAttr>,parent:ASTElement|void):ASTElement{return{type:1,tag,attrsList:attrs,attrsMap:makeAttrsMap(attrs),rawAttrsMap:{},parent,children:[]}}/***ConvertHTMLstringtoAST.*/exportfunctionparse(template:string,options:CompilerOptions):ASTElement{warn=options.warn||baseWarnplatformIsPreTag=options.isPreTag||noplatformMustUseProp=options.mustUseProp||noplatformGetTagNamespace=options.getTagNamespace||noconstisReservedTag=options.isReservedTag||nomaybeComponent=(el:ASTElement)=>!!(el.component||el.attrsMap[':is']||el.attrsMap['v-bind:is']||!(el.attrsMap.is?isReservedTag(el.attrsMap.is):isReservedTag(el.tag)))transforms=pluckModuleFunction(options.modules,'transformNode')preTransforms=pluckModuleFunction(options.modules,'preTransformNode')postTransforms=pluckModuleFunction(options.modules,'postTransformNode')delimiters=options.delimitersconststack:any[]=[]constpreserveWhitespace=options.preserveWhitespace!==falseconstwhitespaceOption=options.whitespaceletrootletcurrentParentletinVPre=falseletinPre=falseletwarned=falsefunctionwarnOnce(msg,range){if(!warned){warned=truewarn(msg,range)}}functioncloseElement(element){trimEndingWhitespace(element)if(!inVPre&&!element.processed){element=processElement(element,options)}//treemanagementif(!stack.length&&element!==root){//allowrootelementswithv-if,v-else-ifandv-elseif(root.if&&(element.elseif||element.else)){if(__DEV__){checkRootConstraints(element)}addIfCondition(root,{exp:element.elseif,block:element})}elseif(__DEV__){warnOnce(`Componenttemplateshouldcontainexactlyonerootelement.`+`Ifyouareusingv-ifonmultipleelements,`+`usev-else-iftochaintheminstead.`,{start:element.start})}}if(currentParent&&!element.forbidden){if(element.elseif||element.else){processIfConditions(element,currentParent)}else{if(element.slotScope){//scopedslot//keepitinthechildrenlistsothatv-else(-if)conditionscan//finditastheprevnode.constname=element.slotTarget||'"default"';(currentParent.scopedSlots||(currentParent.scopedSlots={}))[name]=element}currentParent.children.push(element)element.parent=currentParent}}//finalchildrencleanup//filteroutscopedslotselement.children=element.children.filter(c=>!c.slotScope)//removetrailingwhitespacenodeagaintrimEndingWhitespace(element)//checkprestateif(element.pre){inVPre=false}if(platformIsPreTag(element.tag)){inPre=false}//applypost-transformsfor(leti=0;i<postTransforms.length;i++){postTransforms[i](element,options)}}functiontrimEndingWhitespace(el){//removetrailingwhitespacenodeif(!inPre){letlastNodewhile((lastNode=el.children[el.children.length-1])&&lastNode.type===3&&lastNode.text===''){el.children.pop()}}}functioncheckRootConstraints(el){if(el.tag==='slot'||el.tag==='template'){warnOnce(`Cannotuse<${el.tag}>ascomponentrootelementbecauseitmay`+'containmultiplenodes.',{start:el.start})}if(el.attrsMap.hasOwnProperty('v-for')){warnOnce('Cannotusev-foronstatefulcomponentrootelementbecause'+'itrendersmultipleelements.',el.rawAttrsMap['v-for'])}}parseHTML(template,{warn,expectHTML:options.expectHTML,isUnaryTag:options.isUnaryTag,canBeLeftOpenTag:options.canBeLeftOpenTag,shouldDecodeNewlines:options.shouldDecodeNewlines,shouldDecodeNewlinesForHref:options.shouldDecodeNewlinesForHref,shouldKeepComment:options.comments,outputSourceRange:options.outputSourceRange,start(tag,attrs,unary,start,end){//checknamespace.//inheritparentnsifthereisoneconstns=(currentParent&&currentParent.ns)||platformGetTagNamespace(tag)//handleIEsvgbug/*istanbulignoreif*/if(isIE&&ns==='svg'){attrs=guardIESVGBug(attrs)}letelement:ASTElement=createASTElement(tag,attrs,currentParent)if(ns){element.ns=ns}if(__DEV__){if(options.outputSourceRange){element.start=startelement.end=endelement.rawAttrsMap=element.attrsList.reduce((cumulated,attr)=>{cumulated[attr.name]=attrreturncumulated},{})}attrs.forEach(attr=>{if(invalidAttributeRE.test(attr.name)){warn(`Invaliddynamicargumentexpression:attributenamescannotcontain`+`spaces,quotes,<,>,/or=.`,options.outputSourceRange?{start:attr.start!+attr.name.indexOf(`[`),end:attr.start!+attr.name.length}:undefined)}})}if(isForbiddenTag(element)&&!isServerRendering()){element.forbidden=true__DEV__&&warn('Templatesshouldonlyberesponsibleformappingthestatetothe'+'UI.Avoidplacingtagswithside-effectsinyourtemplates,suchas'+`<${tag}>`+',astheywillnotbeparsed.',{start:element.start})}//applypre-transformsfor(leti=0;i<preTransforms.length;i++){element=preTransforms[i](element,options)||element}if(!inVPre){processPre(element)if(element.pre){inVPre=true}}if(platformIsPreTag(element.tag)){inPre=true}if(inVPre){processRawAttrs(element)}elseif(!element.processed){//structuraldirectivesprocessFor(element)processIf(element)processOnce(element)}if(!root){root=elementif(__DEV__){checkRootConstraints(root)}}if(!unary){currentParent=elementstack.push(element)}else{closeElement(element)}},end(tag,start,end){constelement=stack[stack.length-1]//popstackstack.length-=1currentParent=stack[stack.length-1]if(__DEV__&&options.outputSourceRange){element.end=end}closeElement(element)},chars(text:string,start?:number,end?:number){if(!currentParent){if(__DEV__){if(text===template){warnOnce('Componenttemplaterequiresarootelement,ratherthanjusttext.',{start})}elseif((text=text.trim())){warnOnce(`text"${text}"outsiderootelementwillbeignored.`,{start})}}return}//IEtextareaplaceholderbug/*istanbulignoreif*/if(isIE&&currentParent.tag==='textarea'&&currentParent.attrsMap.placeholder===text){return}constchildren=currentParent.childrenif(inPre||text.trim()){text=isTextTag(currentParent)?text:(decodeHTMLCached(text)asstring)}elseif(!children.length){//removethewhitespace-onlynoderightafteranopeningtagtext=''}elseif(whitespaceOption){if(whitespaceOption==='condense'){//incondensemode,removethewhitespacenodeifitcontains//linebreak,otherwisecondensetoasinglespacetext=lineBreakRE.test(text)?'':''}else{text=''}}else{text=preserveWhitespace?'':''}if(text){if(!inPre&&whitespaceOption==='condense'){//condenseconsecutivewhitespacesintosinglespacetext=text.replace(whitespaceRE,'')}letresletchild:ASTNode|undefinedif(!inVPre&&text!==''&&(res=parseText(text,delimiters))){child={type:2,expression:res.expression,tokens:res.tokens,text}}elseif(text!==''||!children.length||children[children.length-1].text!==''){child={type:3,text}}if(child){if(__DEV__&&options.outputSourceRange){child.start=startchild.end=end}children.push(child)}}},comment(text:string,start,end){//addinganythingasasiblingtotherootnodeisforbidden//commentsshouldstillbeallowed,butignoredif(currentParent){constchild:ASTText={type:3,text,isComment:true}if(__DEV__&&options.outputSourceRange){child.start=startchild.end=end}currentParent.children.push(child)}}})returnroot}functionprocessPre(el){if(getAndRemoveAttr(el,'v-pre')!=null){el.pre=true}}functionprocessRawAttrs(el){constlist=el.attrsListconstlen=list.lengthif(len){constattrs:Array<ASTAttr>=(el.attrs=newArray(len))for(leti=0;i<len;i++){attrs[i]={name:list[i].name,value:JSON.stringify(list[i].value)}if(list[i].start!=null){attrs[i].start=list[i].startattrs[i].end=list[i].end}}}elseif(!el.pre){//nonrootnodeinpreblockswithnoattributesel.plain=true}}exportfunctionprocessElement(element:ASTElement,options:CompilerOptions){processKey(element)//determinewhetherthisisaplainelementafter//removingstructuralattributeselement.plain=!element.key&&!element.scopedSlots&&!element.attrsList.lengthprocessRef(element)processSlotContent(element)processSlotOutlet(element)processComponent(element)for(leti=0;i<transforms.length;i++){element=transforms[i](element,options)||element}processAttrs(element)returnelement}functionprocessKey(el){constexp=getBindingAttr(el,'key')if(exp){if(__DEV__){if(el.tag==='template'){warn(`<template>cannotbekeyed.Placethekeyonrealelementsinstead.`,getRawBindingAttr(el,'key'))}if(el.for){constiterator=el.iterator2||el.iterator1constparent=el.parentif(iterator&&iterator===exp&&parent&&parent.tag==='transition-group'){warn(`Donotusev-forindexaskeyon<transition-group>children,`+`thisisthesameasnotusingkeys.`,getRawBindingAttr(el,'key'),true/*tip*/)}}}el.key=exp}}functionprocessRef(el){constref=getBindingAttr(el,'ref')if(ref){el.ref=refel.refInFor=checkInFor(el)}}exportfunctionprocessFor(el:ASTElement){letexpif((exp=getAndRemoveAttr(el,'v-for'))){constres=parseFor(exp)if(res){extend(el,res)}elseif(__DEV__){warn(`Invalidv-forexpression:${exp}`,el.rawAttrsMap['v-for'])}}}typeForParseResult={for:stringalias:stringiterator1?:stringiterator2?:string}exportfunctionparseFor(exp:string):ForParseResult|undefined{constinMatch=exp.match(forAliasRE)if(!inMatch)returnconstres:any={}res.for=inMatch[2].trim()constalias=inMatch[1].trim().replace(stripParensRE,'')constiteratorMatch=alias.match(forIteratorRE)if(iteratorMatch){res.alias=alias.replace(forIteratorRE,'').trim()res.iterator1=iteratorMatch[1].trim()if(iteratorMatch[2]){res.iterator2=iteratorMatch[2].trim()}}else{res.alias=alias}returnres}functionprocessIf(el){constexp=getAndRemoveAttr(el,'v-if')if(exp){el.if=expaddIfCondition(el,{exp:exp,block:el})}else{if(getAndRemoveAttr(el,'v-else')!=null){el.else=true}constelseif=getAndRemoveAttr(el,'v-else-if')if(elseif){el.elseif=elseif}}}functionprocessIfConditions(el,parent){constprev=findPrevElement(parent.children)if(prev&&prev.if){addIfCondition(prev,{exp:el.elseif,block:el})}elseif(__DEV__){warn(`v-${el.elseif?'else-if="'+el.elseif+'"':'else'}`+`usedonelement<${el.tag}>withoutcorrespondingv-if.`,el.rawAttrsMap[el.elseif?'v-else-if':'v-else'])}}functionfindPrevElement(children:Array<any>):ASTElement|void{leti=children.lengthwhile(i--){if(children[i].type===1){returnchildren[i]}else{if(__DEV__&&children[i].text!==''){warn(`text"${children[i].text.trim()}"betweenv-ifandv-else(-if)`+`willbeignored.`,children[i])}children.pop()}}}exportfunctionaddIfCondition(el:ASTElement,condition:ASTIfCondition){if(!el.ifConditions){el.ifConditions=[]}el.ifConditions.push(condition)}functionprocessOnce(el){constonce=getAndRemoveAttr(el,'v-once')if(once!=null){el.once=true}}//handlecontentbeingpassedtoacomponentasslot,//e.g.<templateslot="xxx">,<divslot-scope="xxx">functionprocessSlotContent(el){letslotScopeif(el.tag==='template'){slotScope=getAndRemoveAttr(el,'scope')/*istanbulignoreif*/if(__DEV__&&slotScope){warn(`the"scope"attributeforscopedslotshavebeendeprecatedand`+`replacedby"slot-scope"since2.5.Thenew"slot-scope"attribute`+`canalsobeusedonplainelementsinadditionto<template>to`+`denotescopedslots.`,el.rawAttrsMap['scope'],true)}el.slotScope=slotScope||getAndRemoveAttr(el,'slot-scope')}elseif((slotScope=getAndRemoveAttr(el,'slot-scope'))){/*istanbulignoreif*/if(__DEV__&&el.attrsMap['v-for']){warn(`Ambiguouscombinedusageofslot-scopeandv-foron<${el.tag}>`+`(v-fortakeshigherpriority).Useawrapper<template>forthe`+`scopedslottomakeitclearer.`,el.rawAttrsMap['slot-scope'],true)}el.slotScope=slotScope}//slot="xxx"constslotTarget=getBindingAttr(el,'slot')if(slotTarget){el.slotTarget=slotTarget==='""'?'"default"':slotTargetel.slotTargetDynamic=!!(el.attrsMap[':slot']||el.attrsMap['v-bind:slot'])//preserveslotasanattributefornativeshadowDOMcompat//onlyfornon-scopedslots.if(el.tag!=='template'&&!el.slotScope){addAttr(el,'slot',slotTarget,getRawBindingAttr(el,'slot'))}}//2.6v-slotsyntaxif(process.env.NEW_SLOT_SYNTAX){if(el.tag==='template'){//v-sloton<template>constslotBinding=getAndRemoveAttrByRegex(el,slotRE)if(slotBinding){if(__DEV__){if(el.slotTarget||el.slotScope){warn(`Unexpectedmixedusageofdifferentslotsyntaxes.`,el)}if(el.parent&&!maybeComponent(el.parent)){warn(`<templatev-slot>canonlyappearattherootlevelinside`+`thereceivingcomponent`,el)}}const{name,dynamic}=getSlotName(slotBinding)el.slotTarget=nameel.slotTargetDynamic=dynamicel.slotScope=slotBinding.value||emptySlotScopeToken//forceitintoascopedslotforperf}}else{//v-slotoncomponent,denotesdefaultslotconstslotBinding=getAndRemoveAttrByRegex(el,slotRE)if(slotBinding){if(__DEV__){if(!maybeComponent(el)){warn(`v-slotcanonlybeusedoncomponentsor<template>.`,slotBinding)}if(el.slotScope||el.slotTarget){warn(`Unexpectedmixedusageofdifferentslotsyntaxes.`,el)}if(el.scopedSlots){warn(`Toavoidscopeambiguity,thedefaultslotshouldalsouse`+`<template>syntaxwhenthereareothernamedslots.`,slotBinding)}}//addthecomponent'schildrentoitsdefaultslotconstslots=el.scopedSlots||(el.scopedSlots={})const{name,dynamic}=getSlotName(slotBinding)constslotContainer=(slots[name]=createASTElement('template',[],el))slotContainer.slotTarget=nameslotContainer.slotTargetDynamic=dynamicslotContainer.children=el.children.filter((c:any)=>{if(!c.slotScope){c.parent=slotContainerreturntrue}})slotContainer.slotScope=slotBinding.value||emptySlotScopeToken//removechildrenastheyarereturnedfromscopedSlotsnowel.children=[]//markelnon-plainsodatagetsgeneratedel.plain=false}}}}functiongetSlotName(binding){letname=binding.name.replace(slotRE,'')if(!name){if(binding.name[0]!=='#'){name='default'}elseif(__DEV__){warn(`v-slotshorthandsyntaxrequiresaslotname.`,binding)}}returndynamicArgRE.test(name)?//dynamic[name]{name:name.slice(1,-1),dynamic:true}://staticname{name:`"${name}"`,dynamic:false}}//handle<slot/>outletsfunctionprocessSlotOutlet(el){if(el.tag==='slot'){el.slotName=getBindingAttr(el,'name')if(__DEV__&&el.key){warn(`\`key\`doesnotworkon<slot>becauseslotsareabstractoutlets`+`andcanpossiblyexpandintomultipleelements.`+`Usethekeyonawrappingelementinstead.`,getRawBindingAttr(el,'key'))}}}functionprocessComponent(el){letbindingif((binding=getBindingAttr(el,'is'))){el.component=binding}if(getAndRemoveAttr(el,'inline-template')!=null){el.inlineTemplate=true}}functionprocessAttrs(el){constlist=el.attrsListleti,l,name,rawName,value,modifiers,syncGen,isDynamicfor(i=0,l=list.length;i<l;i++){name=rawName=list[i].namevalue=list[i].valueif(dirRE.test(name)){//markelementasdynamicel.hasBindings=true//modifiersmodifiers=parseModifiers(name.replace(dirRE,''))//support.fooshorthandsyntaxforthe.propmodifierif(process.env.VBIND_PROP_SHORTHAND&&propBindRE.test(name)){;(modifiers||(modifiers={})).prop=truename=`.`+name.slice(1).replace(modifierRE,'')}elseif(modifiers){name=name.replace(modifierRE,'')}if(bindRE.test(name)){//v-bindname=name.replace(bindRE,'')value=parseFilters(value)isDynamic=dynamicArgRE.test(name)if(isDynamic){name=name.slice(1,-1)}if(__DEV__&&value.trim().length===0){warn(`Thevalueforav-bindexpressioncannotbeempty.Foundin"v-bind:${name}"`)}if(modifiers){if(modifiers.prop&&!isDynamic){name=camelize(name)if(name==='innerHtml')name='innerHTML'}if(modifiers.camel&&!isDynamic){name=camelize(name)}if(modifiers.sync){syncGen=genAssignmentCode(value,`$event`)if(!isDynamic){addHandler(el,`update:${camelize(name)}`,syncGen,null,false,warn,list[i])if(hyphenate(name)!==camelize(name)){addHandler(el,`update:${hyphenate(name)}`,syncGen,null,false,warn,list[i])}}else{//handlerw/dynamiceventnameaddHandler(el,`"update:"+(${name})`,syncGen,null,false,warn,list[i],true//dynamic)}}}if((modifiers&&modifiers.prop)||(!el.component&&platformMustUseProp(el.tag,el.attrsMap.type,name))){addProp(el,name,value,list[i],isDynamic)}else{addAttr(el,name,value,list[i],isDynamic)}}elseif(onRE.test(name)){//v-onname=name.replace(onRE,'')isDynamic=dynamicArgRE.test(name)if(isDynamic){name=name.slice(1,-1)}addHandler(el,name,value,modifiers,false,warn,list[i],isDynamic)}else{//normaldirectivesname=name.replace(dirRE,'')//parseargconstargMatch=name.match(argRE)letarg=argMatch&&argMatch[1]isDynamic=falseif(arg){name=name.slice(0,-(arg.length+1))if(dynamicArgRE.test(arg)){arg=arg.slice(1,-1)isDynamic=true}}addDirective(el,name,rawName,value,arg,isDynamic,modifiers,list[i])if(__DEV__&&name==='model'){checkForAliasModel(el,value)}}}else{//literalattributeif(__DEV__){constres=parseText(value,delimiters)if(res){warn(`${name}="${value}":`+'Interpolationinsideattributeshasbeenremoved.'+'Usev-bindorthecolonshorthandinstead.Forexample,'+'insteadof<divid="{{val}}">,use<div:id="val">.',list[i])}}addAttr(el,name,JSON.stringify(value),list[i])//#6887firefoxdoesn'tupdatemutedstateifsetviaattribute//evenimmediatelyafterelementcreationif(!el.component&&name==='muted'&&platformMustUseProp(el.tag,el.attrsMap.type,name)){addProp(el,name,'true',list[i])}}}}functioncheckInFor(el:ASTElement):boolean{letparent:ASTElement|void=elwhile(parent){if(parent.for!==undefined){returntrue}parent=parent.parent}returnfalse}functionparseModifiers(name:string):Object|void{constmatch=name.match(modifierRE)if(match){constret={}match.forEach(m=>{ret[m.slice(1)]=true})returnret}}functionmakeAttrsMap(attrs:Array<Record<string,any>>):Record<string,any>{constmap={}for(leti=0,l=attrs.length;i<l;i++){if(__DEV__&&map[attrs[i].name]&&!isIE&&!isEdge){warn('duplicateattribute:'+attrs[i].name,attrs[i])}map[attrs[i].name]=attrs[i].value}returnmap}//forscript(e.g.type="x/template")orstyle,donotdecodecontentfunctionisTextTag(el):boolean{returnel.tag==='script'||el.tag==='style'}functionisForbiddenTag(el):boolean{return(el.tag==='style'||(el.tag==='script'&&(!el.attrsMap.type||el.attrsMap.type==='text/javascript')))}constieNSBug=/^xmlns:NS\d+/constieNSPrefix=/^NS\d+://*istanbulignorenext*/functionguardIESVGBug(attrs){constres:any[]=[]for(leti=0;i<attrs.length;i++){constattr=attrs[i]if(!ieNSBug.test(attr.name)){attr.name=attr.name.replace(ieNSPrefix,'')res.push(attr)}}returnres}functioncheckForAliasModel(el,value){let_el=elwhile(_el){if(_el.for&&_el.alias===value){warn(`<${el.tag}v-model="${value}">:`+`Youarebindingv-modeldirectlytoav-foriterationalias.`+`Thiswillnotbeabletomodifythev-forsourcearraybecause`+`writingtothealiasislikemodifyingafunctionlocalvariable.`+`Considerusinganarrayofobjectsandusev-modelonanobjectpropertyinstead.`,el.rawAttrsMap['v-model'])}_el=_el.parent}}