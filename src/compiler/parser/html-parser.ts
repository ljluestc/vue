/***Nottype-checkingthisfilebecauseit'smostlyvendorcode.*//*!*HTMLParserByJohnResig(ejohn.org)*ModifiedbyJuriy"kangax"Zaytsev*OriginalcodebyErikArvidsson(MPL-1.1ORApache-2.0ORGPL-2.0-or-later)*http://erik.eae.net/simplehtmlparser/simplehtmlparser.js*/import{makeMap,no}from'shared/util'import{isNonPhrasingTag}from'web/compiler/util'import{unicodeRegExp}from'core/util/lang'import{ASTAttr,CompilerOptions}from'types/compiler'//RegularExpressionsforparsingtagsandattributesconstattribute=/^\s*([^\s"'<>\/=]+)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=<>`]+)))?/constdynamicArgAttribute=/^\s*((?:v-[\w-]+:|@|:|#)\[[^=]+?\][^\s"'<>\/=]*)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=<>`]+)))?/constncname=`[a-zA-Z_][\\-\\.0-9_a-zA-Z${unicodeRegExp.source}]*`constqnameCapture=`((?:${ncname}\\:)?${ncname})`conststartTagOpen=newRegExp(`^<${qnameCapture}`)conststartTagClose=/^\s*(\/?)>/constendTag=newRegExp(`^<\\/${qnameCapture}[^>]*>`)constdoctype=/^<!DOCTYPE[^>]+>/i//#7298:escape-toavoidbeingpassedasHTMLcommentwheninlinedinpageconstcomment=/^<!\--/constconditionalComment=/^<!\[///SpecialElements(cancontainanything)exportconstisPlainTextElement=makeMap('script,style,textarea',true)constreCache={}constdecodingMap={'&lt;':'<','&gt;':'>','&quot;':'"','&amp;':'&','&#10;':'\n','&#9;':'\t','&#39;':"'"}constencodedAttr=/&(?:lt|gt|quot|amp|#39);/gconstencodedAttrWithNewLines=/&(?:lt|gt|quot|amp|#39|#10|#9);/g//#5992constisIgnoreNewlineTag=makeMap('pre,textarea',true)constshouldIgnoreFirstNewline=(tag,html)=>tag&&isIgnoreNewlineTag(tag)&&html[0]==='\n'functiondecodeAttr(value,shouldDecodeNewlines){constre=shouldDecodeNewlines?encodedAttrWithNewLines:encodedAttrreturnvalue.replace(re,match=>decodingMap[match])}exportinterfaceHTMLParserOptionsextendsCompilerOptions{start?:(tag:string,attrs:ASTAttr[],unary:boolean,start:number,end:number)=>voidend?:(tag:string,start:number,end:number)=>voidchars?:(text:string,start?:number,end?:number)=>voidcomment?:(content:string,start:number,end:number)=>void}exportfunctionparseHTML(html,options:HTMLParserOptions){conststack:any[]=[]constexpectHTML=options.expectHTMLconstisUnaryTag=options.isUnaryTag||noconstcanBeLeftOpenTag=options.canBeLeftOpenTag||noletindex=0letlast,lastTagwhile(html){last=html//Makesurewe'renotinaplaintextcontentelementlikescript/styleif(!lastTag||!isPlainTextElement(lastTag)){lettextEnd=html.indexOf('<')if(textEnd===0){//Comment:if(comment.test(html)){constcommentEnd=html.indexOf('-->')if(commentEnd>=0){if(options.shouldKeepComment&&options.comment){options.comment(html.substring(4,commentEnd),index,index+commentEnd+3)}advance(commentEnd+3)continue}}//https://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_commentif(conditionalComment.test(html)){constconditionalEnd=html.indexOf(']>')if(conditionalEnd>=0){advance(conditionalEnd+2)continue}}//Doctype:constdoctypeMatch=html.match(doctype)if(doctypeMatch){advance(doctypeMatch[0].length)continue}//Endtag:constendTagMatch=html.match(endTag)if(endTagMatch){constcurIndex=indexadvance(endTagMatch[0].length)parseEndTag(endTagMatch[1],curIndex,index)continue}//Starttag:conststartTagMatch=parseStartTag()if(startTagMatch){handleStartTag(startTagMatch)if(shouldIgnoreFirstNewline(startTagMatch.tagName,html)){advance(1)}continue}}lettext,rest,nextif(textEnd>=0){rest=html.slice(textEnd)while(!endTag.test(rest)&&!startTagOpen.test(rest)&&!comment.test(rest)&&!conditionalComment.test(rest)){//<inplaintext,beforgivingandtreatitastextnext=rest.indexOf('<',1)if(next<0)breaktextEnd+=nextrest=html.slice(textEnd)}text=html.substring(0,textEnd)}if(textEnd<0){text=html}if(text){advance(text.length)}if(options.chars&&text){options.chars(text,index-text.length,index)}}else{letendTagLength=0conststackedTag=lastTag.toLowerCase()constreStackedTag=reCache[stackedTag]||(reCache[stackedTag]=newRegExp('([\\s\\S]*?)(</'+stackedTag+'[^>]*>)','i'))constrest=html.replace(reStackedTag,function(all,text,endTag){endTagLength=endTag.lengthif(!isPlainTextElement(stackedTag)&&stackedTag!=='noscript'){text=text.replace(/<!\--([\s\S]*?)-->/g,'$1')//#7298.replace(/<!\[CDATA\[([\s\S]*?)]]>/g,'$1')}if(shouldIgnoreFirstNewline(stackedTag,text)){text=text.slice(1)}if(options.chars){options.chars(text)}return''})index+=html.length-rest.lengthhtml=restparseEndTag(stackedTag,index-endTagLength,index)}if(html===last){options.chars&&options.chars(html)if(__DEV__&&!stack.length&&options.warn){options.warn(`Mal-formattedtagatendoftemplate:"${html}"`,{start:index+html.length})}break}}//CleanupanyremainingtagsparseEndTag()functionadvance(n){index+=nhtml=html.substring(n)}functionparseStartTag(){conststart=html.match(startTagOpen)if(start){constmatch:any={tagName:start[1],attrs:[],start:index}advance(start[0].length)letend,attrwhile(!(end=html.match(startTagClose))&&(attr=html.match(dynamicArgAttribute)||html.match(attribute))){attr.start=indexadvance(attr[0].length)attr.end=indexmatch.attrs.push(attr)}if(end){match.unarySlash=end[1]advance(end[0].length)match.end=indexreturnmatch}}}functionhandleStartTag(match){consttagName=match.tagNameconstunarySlash=match.unarySlashif(expectHTML){if(lastTag==='p'&&isNonPhrasingTag(tagName)){parseEndTag(lastTag)}if(canBeLeftOpenTag(tagName)&&lastTag===tagName){parseEndTag(tagName)}}constunary=isUnaryTag(tagName)||!!unarySlashconstl=match.attrs.lengthconstattrs:ASTAttr[]=newArray(l)for(leti=0;i<l;i++){constargs=match.attrs[i]constvalue=args[3]||args[4]||args[5]||''constshouldDecodeNewlines=tagName==='a'&&args[1]==='href'?options.shouldDecodeNewlinesForHref:options.shouldDecodeNewlinesattrs[i]={name:args[1],value:decodeAttr(value,shouldDecodeNewlines)}if(__DEV__&&options.outputSourceRange){attrs[i].start=args.start+args[0].match(/^\s*/).lengthattrs[i].end=args.end}}if(!unary){stack.push({tag:tagName,lowerCasedTag:tagName.toLowerCase(),attrs:attrs,start:match.start,end:match.end})lastTag=tagName}if(options.start){options.start(tagName,attrs,unary,match.start,match.end)}}functionparseEndTag(tagName?:any,start?:any,end?:any){letpos,lowerCasedTagNameif(start==null)start=indexif(end==null)end=index//Findtheclosestopenedtagofthesametypeif(tagName){lowerCasedTagName=tagName.toLowerCase()for(pos=stack.length-1;pos>=0;pos--){if(stack[pos].lowerCasedTag===lowerCasedTagName){break}}}else{//Ifnotagnameisprovided,cleanshoppos=0}if(pos>=0){//Closealltheopenelements,upthestackfor(leti=stack.length-1;i>=pos;i--){if(__DEV__&&(i>pos||!tagName)&&options.warn){options.warn(`tag<${stack[i].tag}>hasnomatchingendtag.`,{start:stack[i].start,end:stack[i].end})}if(options.end){options.end(stack[i].tag,start,end)}}//Removetheopenelementsfromthestackstack.length=poslastTag=pos&&stack[pos-1].tag}elseif(lowerCasedTagName==='br'){if(options.start){options.start(tagName,[],true,start,end)}}elseif(lowerCasedTagName==='p'){if(options.start){options.start(tagName,[],false,start,end)}if(options.end){options.end(tagName,start,end)}}}}