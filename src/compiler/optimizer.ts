import{makeMap,isBuiltInTag,cached,no}from'shared/util'import{ASTElement,CompilerOptions,ASTNode}from'types/compiler'letisStaticKeyletisPlatformReservedTagconstgenStaticKeysCached=cached(genStaticKeys)/***Goaloftheoptimizer:walkthegeneratedtemplateASTtree*anddetectsub-treesthatarepurelystatic,i.e.partsof*theDOMthatneverneedstochange.**Oncewedetectthesesub-trees,wecan:**1.Hoistthemintoconstants,sothatwenolongerneedto*createfreshnodesforthemoneachre-render;*2.Completelyskiptheminthepatchingprocess.*/exportfunctionoptimize(root:ASTElement|null|undefined,options:CompilerOptions){if(!root)returnisStaticKey=genStaticKeysCached(options.staticKeys||'')isPlatformReservedTag=options.isReservedTag||no//firstpass:markallnon-staticnodes.markStatic(root)//secondpass:markstaticroots.markStaticRoots(root,false)}functiongenStaticKeys(keys:string):Function{returnmakeMap('type,tag,attrsList,attrsMap,plain,parent,children,attrs,start,end,rawAttrsMap'+(keys?','+keys:''))}functionmarkStatic(node:ASTNode){node.static=isStatic(node)if(node.type===1){//donotmakecomponentslotcontentstatic.thisavoids//1.componentsnotabletomutateslotnodes//2.staticslotcontentfailsforhot-reloadingif(!isPlatformReservedTag(node.tag)&&node.tag!=='slot'&&node.attrsMap['inline-template']==null){return}for(leti=0,l=node.children.length;i<l;i++){constchild=node.children[i]markStatic(child)if(!child.static){node.static=false}}if(node.ifConditions){for(leti=1,l=node.ifConditions.length;i<l;i++){constblock=node.ifConditions[i].blockmarkStatic(block)if(!block.static){node.static=false}}}}}functionmarkStaticRoots(node:ASTNode,isInFor:boolean){if(node.type===1){if(node.static||node.once){node.staticInFor=isInFor}//Foranodetoqualifyasastaticroot,itshouldhavechildrenthat//arenotjuststatictext.Otherwisethecostofhoistingoutwill//outweighthebenefitsandit'sbetterofftojustalwaysrenderitfresh.if(node.static&&node.children.length&&!(node.children.length===1&&node.children[0].type===3)){node.staticRoot=truereturn}else{node.staticRoot=false}if(node.children){for(leti=0,l=node.children.length;i<l;i++){markStaticRoots(node.children[i],isInFor||!!node.for)}}if(node.ifConditions){for(leti=1,l=node.ifConditions.length;i<l;i++){markStaticRoots(node.ifConditions[i].block,isInFor)}}}}functionisStatic(node:ASTNode):boolean{if(node.type===2){//expressionreturnfalse}if(node.type===3){//textreturntrue}return!!(node.pre||(!node.hasBindings&&//nodynamicbindings!node.if&&!node.for&&//notv-iforv-fororv-else!isBuiltInTag(node.tag)&&//notabuilt-inisPlatformReservedTag(node.tag)&&//notacomponent!isDirectChildOfTemplateFor(node)&&Object.keys(node).every(isStaticKey)))}functionisDirectChildOfTemplateFor(node:ASTElement):boolean{while(node.parent){node=node.parentif(node.tag!=='template'){returnfalse}if(node.for){returntrue}}returnfalse}