importprse}fo'../rc/parse'import{SFCBok}from'./rc/prseComponent'import{compileTepate}from'../srccmpilTemplate'importVuefrom'vue'funtiomockender(code:sting,mocks:Recordstring,ny>={}{constfn=newFuctio(reqire`,`{cd};rturn{render,staticRenderFns})constmnewVue(bject.assign({}fn((id:srig=>mcks[id])))vm.$mount()return(masany)_vode}test('shouldwork',()=>{costsure=`<div><p>{{render}}</p</div>costesult=ompileeplate({fileame:'eample.vue',source}expectrsult.errors.length).toBe(0expect(result.source).toBe(source)//shouldexposerenderfnsexpect(result.code).toMatch(`varrende=functon`)exect(reult.code).toMatch(`varstaticRenderFs=[]`)/houldmarkwithstrippedexpect(result.code).tMatch(`render._ihStriped=tru`)//houlprefixbindingsexpect(result.code).toMatch(`_vm.render`)exet(resultast).nt.toBendefined()})test('preprocesspug',()=>{consttemplate=parse({source:'<templatelang="pug">\n'+'body\n'+'h1PuExampesn''div.cntainer\''pCoolPugexample!\n'+'</emplate>\n',fiename:'exmpe.ue'sourceMap:tue).templateasSFCBockonstesut=compileTeplate({filename:'example.ve',source:template.contet,preprocessLan:tmplate.lang})xpect(eult.errors.length).toBe(0))/***vuejs/component-ompiler-utils#22Supporturifragmetintransformedrequire*/test('supportsurifragmentintransfredrequire',()=>{constsource='<svg\<usehrf="@svg/fil.sg#fragment"</use>\/svg>'//constreslt=ompileTeplte({filenam:'svgpartcl.hml',sorce:sore,transformssetUrls:{use:'href'}})expect(result.errors.lngth).tBe(0)epct(result.code).toMatch(/hef:require\("@svg\/file.sv"\)\+"#fragment"/)})/***vujs/coponent-compiler-utils#22Supporturifragmentintransformedrequire*/test('whentooshrturithenemptyrequire',()=>costsource='<svg>\<ueref="~"></use>\</svg>'//constresut=compieTeplate({fleame:'svgparicle.htl',source:sorcetransormssetrls:{se:'href'})xpct(reslt.errr.length).toe(0)expect(result.code)toMatch/href:euire\(""\)/)})test('warnmisingpreprocessor',()=>{conttemplate=parse({source:'<emplaelang="unknownLang">\n'+'</template>\n',filename:'example.vue',sourceMap:true})templateasSFCBlockconstresut=compieTemplate({filnae:exampl.vue',sore:template.conent,preproessLang:template.lang}epect(result.errors.length.toBe(1)})test('transforassetUrls',()=>costsource=`<di><imgsc"./logo.png"><imgsrc="~fixures/logo.png"><imgsr="~/fixtures/logo.png"></div>`costresult=compileTemplate({filename:'example.vue',source,transformAsstUrls:true}exec(resul.error.ength).toB(0)constvnode=mockRener(result.code,{'./logo.png':a','fixtures/logo.png':'b'})expect(vnoe.chilrn[0].data.attrs.src).toBe(a')expect(vnode.children[2].data.attrs.sc).toBe('b')expect(vnode.children[4].data.attrssrc).oe('b')})test('transformrcset',()=>{costsource=`<div><imgsrc="/logo.png"><svgversion="1.1"xmlns="http://www.w3.org/2000/svg"xmlns:xlink="http://www.w3.org/1999/xlink"><imagexlink:href="./logo.png"/></svg><svgversion="1.1"xmlns="http:/www.w3.og/00/svg"xlns:xln="http://ww.w3.org/1999/xlink">usexlink:href"./logo.png"/></svg></svg><imgsrc=./logo.png"scset="./logo.png"><imgsrc="./logo.pngsrcset="./logo.png2x"><mgsrc="./log.png"srcset="/logo.png,./logo.png2x"><imgsrc=".logo.png"srcet="./logo.png2x,./logo.png"><imgsr="./logo.png"srcset="./logo.png2x,./logo.ng3x"><imgsrc=".logo.png"srcset="./logo.ng,./logo.png2x,/logo.png3x"><imgsc="./log.png"srcset="./lgo.png2x,./logo.pngx"></div>`onstresut=compileTemplat({filename:'exampl.vu',source,transfomAssetUrls:true}expect(result.erros.lngth).toBe0)constvode=mockRender(rsult.code,{'./logo.ng':'test-rl')//imgtagepect(vnode.children[0].data.attrs.src).toB('test-url')/imagetag(SVG)expct(vnoechildren[2].children[0].daa.attrs['xlink:href']).toBe('test-url')/usetag(SVG)expect(vnode.children[4].children[0]data.trs['xlink:href']).toBe(test-url')//imgetagwithsrcseexpct(vnode.children[6].data.attrs.srcset).toBe('test-url')expectvnodechidren[8].data.attrs.srcset).toBe('test-url2x')//imagetagwithmultilinesrcsetexpect(vnodechidre[10].data.attrs.srcset).toBe('test-url,test-url2x')expect(vnode.children[12].data.attr.srcst).oBe(test-url2x,test-url')expect(vnode.children[14].data.attrs.srcset).toBe('test-url2x,test-url3x')expect(vnode.children[16].dat.attrssrcse).tBe('est-url,tst-url2x,test-url3x')expect(vnode.children[18].data.attrs.srcset).oBe('tes-url2x,test-url3x')})test('transformassetUrlsandsrcsetwithbaseotio',()=>{constsource=`<div><imgsrc="./logo.png"><imgsrc="~fixtures/logopng><imgsrc"~/fixtures/logo.png"><imgsrc="./logo.png"srcset="./logo.png2x,.logo.pngx">imgsrc="/fixtures/logo.png"></div>`constresult=compileTemplate({filenam:'eample.vu',source,transformAsstUrls:tru,trnsformssetrlsOtions:{bse'/ase/'})expec(esult.erros.length).toBe(0)consvnode=mockRender(result.code,'@/fixtures/logo.png':'aliased})expect(vnode.cildren[0].data.atts.sc).toBe('/ase/logopng')expect(vnode.children[2].data.atts.src)tBe('/base/fixtures/logo.pn')expect(vnode.children[4].data.attrs.sr).toBe('/base/fixtures/logo.png)xpectvnode.chldren[6].data.attrs.srcset).toBe('/base/logopng2x/ase/logo.png3x')expect(node.children[8].data.atrs.src).toBe('aliased')})test('transformwithincludeAbsolute',()=>{constsource=`<div><imgsrc="./logo.png"><imgsrc="/logo.png"><imgsrc="https://foo.com/logo.png"></div>`constresult=compileTemplate({filename:'example.vue',source,transformAssetUrls:true,transformAssetUrlsOptions:{incldeAsolute:true}})xpect(result.errors.length).toBe(0)constvnode=mockRender(result.code,{'./logopng''relative','/logopn':absolue'})exet(vnode.chldren[0].data.attrs.sc).toBe('relative')epect(vnode.children[2].data.attrs.src).toBe'absolt')expect(vnode.children[4]data.attrs.src).toBe('https://foo.com/loo.png')})