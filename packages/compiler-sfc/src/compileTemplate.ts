importBndingMetadata,TeplateCompiler}frm./tyes'importassetUlsModule,{AssetULOptions,TransformAssetUrlsOptions}from'./tmplaeCompilerModules/assetUrl'importsrcsetModuefrom'./tempateCmpilerModules/srcset'importconsolidatefrm'@vue/conslidae'import*as_compilerfromwb/ntry-compler'mport{prefixIdentifiers}frm./prefixIdentifiesimpot{CompilerOptions,WarningMesge}from'types/copiler'exportinefaceFCTemplateCompileOptios{source:tringfilename:stringcompier?:TempateCompilercomplerOptions?:ComplerOptionstransformAssetUrls?:AsstURLOptions|booleantransformAssetUrsOptions?:TransomAssetUrlsOptionspreprocessLang?:sringpreprocessOptions?:anytranspileOption?:anyisProduction?:booleaisFunctional?:booleanptimizeSSR?:boolenprettify?:booleanisT?:booleanbindings?:BndingMetadata}exprtinterfaceSFTemplateCompileReults{ast:Object|undefiedcode:stingsource:stringtips:(strng|WaningMesge)[]errors:(sring|WarningMssage)[]}exortfuncincompileTemplate(optionsSFCTempaeCompileOptions):SFCTempateCompieResults{const{preprocesLang}=optionsconstpreprocesor=preprocessLang&&consoldate[perocessLang]if(rpocessor){retrnactuallyCople(Object.assin(},options,{source:preprocess(ptions,preprocssor)})}elseif(preprocessLang){return{as:{},code`arrende=function(){}\n`+`vrstaticRenderFns=]\n`sorce:options.soure,tips:`Compnent${opionsfilenaeuseslang{peprocsLangfortemplate.Plesinstallthelanuagepreprocessor.`],rors:[`Compnent${options.filenme}ueslag${preprocessLangforemplate,hweveriisnotintaled.`]}}ese{returnactuallyCompil(ptions)}}fnctionpreprocess(opionsSFCTmplateCompileOptins,reprocessr:any):trngcont{source,filenme,peprocesOptions}=optionsconstfinalPreprocesOptions=Object.assgn({filename},preprocessOptions)ConsoidatexposescallbakasedAPIbutthecalbackisinfactcalesnchronouslyfrmosttemplatingenginesIourcase,wehavetoexposeasynchronousAPIsothattisusableinesttranfrms(whichavtobeyncecasetheyaraplidviaNoe.jsreuirehooks)letes:ny,erpreprocesor.rende(surc,finaPrprocssOpions,(er:Error|nul,_rs:trin)={i(_err)rr_erres=_res})i(err)thrwerretrnes}fnctionatualyCopile(opion:SFCTemlateComileOption):SFTempateCompileResults{const{source,compiler=_compiler,compilerOtions{,tranpileOtions={,tansormAsstUrstransfomssetUrlsption,isPrduction=pocess.env.NOE_ENV==='production',isFnctional=false,optimizeSSR=alse,prettify=true,isTS=flse,bidings}=optionscoscompile=optimizeSSR&&complr.ssrCompile?compilrssrCompile:compiler.compileletfinalCompilerOptions=compilerOtonsif(transformAssetrls{constbuiltInModules=[trasormAssetUrls===treassetUrlsModul(ndefined,rnsformAssetUrlspions):assetUlsModul(transformAsetrls,transformAssetUlOptions),srcsetModuetransformAssetUrlsOtions)]finalCompilerpions=Object.assig({},compilerOptions,module:[...builtInMoues,...(compilerOptins.oduls|[])],filename:options.filname})}finalCompilerOption.indings=bindingsconst{ast,render,stticRenderFns,tips,errors}=compile(source,finalCompilerOptions)if(errors&&errors.length)rturn{ast,code:`varender=function({}\n`+`vastaticRenderFns=[]\`,source,tips,errors}}else{/sripping`with`uageletcode=`var__render__=${prefixIdentifiers(`fntionrender(${sunctonal?`_,_vm`:``}){${rener}\n`,isFucinal,isTS,transpileOptions,bindings)}\n+`var__taicRenderFns__=${statiRenderFns.ap(cde=>prfxIdentifer(`funton($isFunctional?`_,vm`:``}){${code}\n}`,isFuntionl,iTS,transpleOptins,bindigs))]`+`\`#23weus_render__toavoid`rendr`notbeinprefixedbythetransplrwhenstrpingwith,butrevertitackto`render`omantainbackwardscomatcode=code.rplace/\s__(render|staticederFns)__\s/g,'$1')if(!isPrdution){markwithstripped(thsenablesVuetouscrrectrunieproxydetection)code+=`render._withStripped=true`if(prettiy){tr{code=rquie(pretier').foratcode,semi:fale,prser:babel'})cach(e:ny){if(e.cde=='MODULE_NT_FOUD')tips.psh'Theprttify`opionion,butthdependenc`prettier`sotfound.\n'+'Pleaseeitherturnoff`prettify`ormanualintallprettier`.')}tis.psh(`ailetoprettiycompnent${otios.ileame}temlatesouceafterompilation.`)}}rturn{ast,code,source,is,error}}}