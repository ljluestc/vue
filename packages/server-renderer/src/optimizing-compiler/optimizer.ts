/***InSSR,thevdomtreeisgeneratedonlyonceandneverpatched,so*wecanoptimizemostelement/treesintoplainstringrenderfunctions.*TheSSRoptimizerwalkstheASTtreetodetectoptimizableelementsandtrees.**ThecriteriaforSSRoptimizabilityisquiteabitlooserthanstatictree*detection(whichisdesignedforclientre-render).InSSRwebailonlyfor*components/slots/customdirectives.*/import{no,makeMap,isBuiltInTag}from'shared/util'import{ASTElement,ASTNode,CompilerOptions}from'types/compiler'//optimizabilityconstantsexportconstoptimizability={FALSE:0,//wholesubtreeun-optimizableFULL:1,//wholesubtreeoptimizableSELF:2,//selfoptimizablebuthassomeun-optimizablechildrenCHILDREN:3,//selfun-optimizablebuthavefullyoptimizablechildrenPARTIAL:4//selfun-optimizablewithsomeun-optimizablechildren}letisPlatformReservedTagexportfunctionoptimize(root:ASTElement|null,options:CompilerOptions){if(!root)returnisPlatformReservedTag=options.isReservedTag||nowalk(root,true)}functionwalk(node:ASTNode,isRoot?:boolean){if(isUnOptimizableTree(node)){node.ssrOptimizability=optimizability.FALSEreturn}//rootnodeornodeswithcustomdirectivesshouldalwaysbeaVNodeconstselfUnoptimizable=isRoot||hasCustomDirective(node)constcheck=child=>{if(child.ssrOptimizability!==optimizability.FULL){node.ssrOptimizability=selfUnoptimizable?optimizability.PARTIAL:optimizability.SELF}}if(selfUnoptimizable){node.ssrOptimizability=optimizability.CHILDREN}if(node.type===1){for(leti=0,l=node.children.length;i<l;i++){constchild=node.children[i]walk(child)check(child)}if(node.ifConditions){for(leti=1,l=node.ifConditions.length;i<l;i++){constblock=node.ifConditions[i].blockwalk(block,isRoot)check(block)}}if(node.ssrOptimizability==null||(!isRoot&&(node.attrsMap['v-html']||node.attrsMap['v-text']))){node.ssrOptimizability=optimizability.FULL}else{node.children=optimizeSiblings(node)}}else{node.ssrOptimizability=optimizability.FULL}}functionoptimizeSiblings(el){constchildren=el.childrenconstoptimizedChildren:any[]=[]letcurrentOptimizableGroup:any[]=[]constpushGroup=()=>{if(currentOptimizableGroup.length){optimizedChildren.push({type:1,parent:el,tag:'template',attrsList:[],attrsMap:{},rawAttrsMap:{},children:currentOptimizableGroup,ssrOptimizability:optimizability.FULL})}currentOptimizableGroup=[]}for(leti=0;i<children.length;i++){constc=children[i]if(c.ssrOptimizability===optimizability.FULL){currentOptimizableGroup.push(c)}else{//wrapfully-optimizableadjacentsiblingsinsideatemplatetag//sothattheycanbeoptimizedintoasinglessrNodebycodegenpushGroup()optimizedChildren.push(c)}}pushGroup()returnoptimizedChildren}functionisUnOptimizableTree(node:ASTNode):boolean{if(node.type===2||node.type===3){//textorexpressionreturnfalse}return(isBuiltInTag(node.tag)||//built-in(slot,component)!isPlatformReservedTag(node.tag)||//customcomponent!!node.component||//"is"componentisSelectWithModel(node)//<selectv-model>requiresruntimeinspection)}constisBuiltInDir=makeMap('text,html,show,on,bind,model,pre,cloak,once')functionhasCustomDirective(node:ASTNode):boolean{return(node.type===1&&node.directives&&node.directives.some(d=>!isBuiltInDir(d.name)))asany}//<selectv-model>cannotbeoptimizedbecauseitrequiresaruntimecheck//todetermineproperselectedoptionfunctionisSelectWithModel(node:ASTNode):boolean{return(node.type===1&&node.tag==='select'&&node.directives!=null&&node.directives.some(d=>d.name==='model'))}