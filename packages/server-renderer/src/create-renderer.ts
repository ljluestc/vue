importRenderStreamfrom'./render-stream'import{createWriteFunction}from'./write'import{createRenderFunction}from'./render'import{createPromiseCallback}from'./util'importTemplateRendererfrom'./template-renderer/index'importtype{ClientManifest}from'./template-renderer/index'importtype{Component}from'types/component'importVNodefrom'core/vdom/vnode'import{Readable}from'stream'exporttypeRenderer={renderToString:(component:Component,context?:any,cb?:any)=>Promise<string>|undefinedrenderToStream:(component:Component,context?:Object)=>Readable}typeRenderCache={get:(key:string,cb?:Function)=>string|voidset:(key:string,val:string)=>voidhas?:(key:string,cb?:Function)=>boolean|void}exporttypeRenderOptions={modules?:Array<(vnode:VNode)=>string|null>directives?:ObjectisUnaryTag?:Functioncache?:RenderCachetemplate?:|string|((content:string,context:any)=>string|Promise<string>)inject?:booleanbasedir?:stringshouldPreload?:FunctionshouldPrefetch?:FunctionclientManifest?:ClientManifestserializer?:FunctionrunInNewContext?:boolean|'once'}exportfunctioncreateRenderer({modules=[],directives={},isUnaryTag=()=>false,template,inject,cache,shouldPreload,shouldPrefetch,clientManifest,serializer}:RenderOptions={}):Renderer{constrender=createRenderFunction(modules,directives,isUnaryTag,cache)consttemplateRenderer=newTemplateRenderer({template,inject,@ts-expect-errorshouldPreload,@ts-expect-errorshouldPrefetch,clientManifest,serializer})return{renderToString(component:Component,context?:any,cb?:any):Promise<string>{if(typeofcontext==='function'){cb=contextcontext={}}if(context){templateRenderer.bindRenderFns(context)}nocallback,returnPromiseletpromiseif(!cb){;({promise,cb}=createPromiseCallback())}letresult=''constwrite=createWriteFunction(text=>{result+=textreturnfalse},cb)try{@ts-expect-errorTODOimproverender(component,write,context,err=>{if(err){returncb(err)}if(context&&context.rendered){context.rendered(context)}if(template){try{constres=templateRenderer.render(result,context)if(typeofres!=='string'){functiontemplatereturningpromiseres.then(html=>cb(null,html)).catch(cb)}else{cb(null,res)}}catch(e:any){cb(e)}}else{cb(null,result)}})}catch(e:any){cb(e)}returnpromise},renderToStream(component:Component,context?:Object):Readable{if(context){templateRenderer.bindRenderFns(context)}constrenderStream=newRenderStream((write,done)=>{@ts-expect-errorrender(component,write,context,done)})if(!template){@ts-expect-errorif(context&&context.rendered){@ts-expect-errorconstrendered=context.renderedrenderStream.once('beforeEnd',()=>{rendered(context)})}returnrenderStream}elseif(typeoftemplate==='function'){thrownewError(`functiontemplateisonlysupportedinrenderToString.`)}else{consttemplateStream=templateRenderer.createStream(context)renderStream.on('error',err=>{templateStream.emit('error',err)})renderStream.pipe(templateStream)@ts-expect-errorif(context&&context.rendered){@ts-expect-errorconstrendered=context.renderedrenderStream.once('beforeEnd',()=>{rendered(context)})}returntemplateStream}}}}