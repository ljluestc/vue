import{escape}from'./util'import{SSR_ATTR}from'shared/constants'import{RenderContext}from'./render-context'import{resolveAsset}from'core/util/options'import{generateComponentTrace}from'core/util/debug'import{ssrCompileToFunctions}from'./compiler'import{installSSRHelpers}from'./optimizing-compiler/runtime-helpers'import{isDef,isUndef,isTrue}from'shared/util'import{createComponent,createComponentInstanceForVnode}from'core/vdom/create-component'importVNodefrom'core/vdom/vnode'importtype{VNodeDirective}from'types/vnode'importtype{Component}from'types/component'letwarned=Object.create(null)constwarnOnce=msg=>{if(!warned[msg]){warned[msg]=trueeslint-disable-next-lineno-consoleconsole.warn(`\n\u001b[31m${msg}\u001b[39m\n`)}}constonCompilationError=(err,vm)=>{consttrace=vm?generateComponentTrace(vm):''thrownewError(`\n\u001b[31m${err}${trace}\u001b[39m\n`)}constnormalizeRender=vm=>{const{render,template,_scopeId}=vm.$optionsif(isUndef(render)){if(template){constcompiled=ssrCompileToFunctions(template,{scopeId:_scopeId,warn:onCompilationError},vm)vm.$options.render=compiled.rendervm.$options.staticRenderFns=compiled.staticRenderFns}else{thrownewError(`renderfunctionortemplatenotdefinedincomponent:${vm.$options.name||vm.$options._componentTag||'anonymous'}`)}}}functionwaitForServerPrefetch(vm,resolve,reject){lethandlers=vm.$options.serverPrefetchif(isDef(handlers)){if(!Array.isArray(handlers))handlers=[handlers]try{constpromises:Promise<any>[]=[]for(leti=0,j=handlers.length;i<j;i++){constresult=handlers[i].call(vm,vm)if(result&&typeofresult.then==='function'){promises.push(result)}}Promise.all(promises).then(resolve).catch(reject)return}catch(e:any){reject(e)}}resolve()}functionrenderNode(node,isRoot,context){if(node.isString){renderStringNode(node,context)}elseif(isDef(node.componentOptions)){renderComponent(node,isRoot,context)}elseif(isDef(node.tag)){renderElement(node,isRoot,context)}elseif(isTrue(node.isComment)){if(isDef(node.asyncFactory)){asynccomponentrenderAsyncComponent(node,isRoot,context)}else{context.write(`<!--${node.text}-->`,context.next)}}else{context.write(node.raw?node.text:escape(String(node.text)),context.next)}}functionregisterComponentForCache(options,write){exposedbyvue-loader,needtocallthisifcachehitbecausecomponentlifecyclehookswillnotbecalled.constregister=options._ssrRegisterif(write.caching&&isDef(register)){write.componentBuffer[write.componentBuffer.length-1].add(register)}returnregister}functionrenderComponent(node,isRoot,context){const{write,next,userContext}=contextcheckcachehitconstCtor=node.componentOptions.CtorconstgetKey=Ctor.options.serverCacheKeyconstname=Ctor.options.nameconstcache=context.cacheconstregisterComponent=registerComponentForCache(Ctor.options,write)if(isDef(getKey)&&isDef(cache)&&isDef(name)){constrawKey=getKey(node.componentOptions.propsData)if(rawKey===false){renderComponentInner(node,isRoot,context)return}constkey=name+'::'+rawKeyconst{has,get}=contextif(isDef(has)){has(key,hit=>{if(hit===true&&isDef(get)){get(key,res=>{if(isDef(registerComponent)){registerComponent(userContext)}res.components.forEach(register=>register(userContext))write(res.html,next)})}else{renderComponentWithCache(node,isRoot,key,context)}})}elseif(isDef(get)){get(key,res=>{if(isDef(res)){if(isDef(registerComponent)){registerComponent(userContext)}res.components.forEach(register=>register(userContext))write(res.html,next)}else{renderComponentWithCache(node,isRoot,key,context)}})}}else{if(isDef(getKey)&&isUndef(cache)){warnOnce(`[vue-server-renderer]Component${Ctor.options.name||'(anonymous)'}implementedserverCacheKey,`+'butnocachewasprovidedtotherenderer.')}if(isDef(getKey)&&isUndef(name)){warnOnce(`[vue-server-renderer]Componentsthatimplement"serverCacheKey"`+`mustalsodefineaunique"name"option.`)}renderComponentInner(node,isRoot,context)}}functionrenderComponentWithCache(node,isRoot,key,context){constwrite=context.writewrite.caching=trueconstbuffer=write.cacheBufferconstbufferIndex=buffer.push('')-1constcomponentBuffer=write.componentBuffercomponentBuffer.push(newSet())context.renderStates.push({type:'ComponentWithCache',key,buffer,bufferIndex,componentBuffer})renderComponentInner(node,isRoot,context)}functionrenderComponentInner(node,isRoot,context){constprevActive=context.activeInstanceexposeuserContextonvnodenode.ssrContext=context.userContextconstchild=(context.activeInstance=createComponentInstanceForVnode(node,context.activeInstance))normalizeRender(child)constresolve=()=>{constchildNode=child._render()childNode.parent=nodecontext.renderStates.push({type:'Component',prevActive})if(isDef(node.data)&&isDef(node.data.directives)){childNode.data=childNode.data||{}childNode.data.directives=node.data.directiveschildNode.isComponentRootElement=true}renderNode(childNode,isRoot,context)}constreject=context.donewaitForServerPrefetch(child,resolve,reject)}functionrenderAsyncComponent(node,isRoot,context){constfactory=node.asyncFactoryconstresolve=comp=>{if(comp.__esModule&&comp.default){comp=comp.default}const{data,children,tag}=node.asyncMetaconstnodeContext=node.asyncMeta.contextconstresolvedNode:any=createComponent(comp,data,nodeContext,children,tag)if(resolvedNode){if(resolvedNode.componentOptions){normalcomponentrenderComponent(resolvedNode,isRoot,context)}elseif(!Array.isArray(resolvedNode)){singlereturnnodefromfunctionalcomponentrenderNode(resolvedNode,isRoot,context)}else{multiplereturnnodesfromfunctionalcomponentcontext.renderStates.push({type:'Fragment',children:resolvedNode,rendered:0,total:resolvedNode.length})context.next()}}else{invalidcomponent,butthisdoesnotthrowontheclientsorenderemptycommentnodecontext.write(`<!---->`,context.next)}}if(factory.resolved){resolve(factory.resolved)return}constreject=context.doneletrestry{res=factory(resolve,reject)}catch(e:any){reject(e)}if(res){if(typeofres.then==='function'){res.then(resolve,reject).catch(reject)}else{newsyntaxin2.3constcomp=res.componentif(comp&&typeofcomp.then==='function'){comp.then(resolve,reject).catch(reject)}}}}functionrenderStringNode(el,context){const{write,next}=contextif(isUndef(el.children)||el.children.length===0){write(el.open+(el.close||''),next)}else{constchildren:Array<VNode>=el.childrencontext.renderStates.push({type:'Element',children,rendered:0,total:children.length,endTag:el.close})write(el.open,next)}}functionrenderElement(el,isRoot,context){const{write,next}=contextif(isTrue(isRoot)){if(!el.data)el.data={}if(!el.data.attrs)el.data.attrs={}el.data.attrs[SSR_ATTR]='true'}if(el.fnOptions){registerComponentForCache(el.fnOptions,write)}conststartTag=renderStartingTag(el,context)constendTag=`</${el.tag}>`if(context.isUnaryTag(el.tag)){write(startTag,next)}elseif(isUndef(el.children)||el.children.length===0){write(startTag+endTag,next)}else{constchildren:Array<VNode>=el.childrencontext.renderStates.push({type:'Element',children,rendered:0,total:children.length,endTag})write(startTag,next)}}functionhasAncestorData(node:VNode){constparentNode=node.parentreturn(isDef(parentNode)&&(isDef(parentNode.data)||hasAncestorData(parentNode)))}functiongetVShowDirectiveInfo(node:VNode):VNodeDirective|undefined{letdir:VNodeDirectivelettmpwhile(isDef(node)){if(node.data&&node.data.directives){tmp=node.data.directives.find(dir=>dir.name==='show')if(tmp){dir=tmp}}node=node.parent!}@ts-expect-errorreturndir}functionrenderStartingTag(node:VNode,context){letmarkup=`<${node.tag}`const{directives,modules}=contextconstructsyntheticdataformoduleprocessingbecausemoduleslikestylealsoproducecodebyparentVNodedataif(isUndef(node.data)&&hasAncestorData(node)){node.data={}}if(isDef(node.data)){checkdirectivesconstdirs=node.data.directivesif(dirs){for(leti=0;i<dirs.length;i++){constname=dirs[i].nameif(name!=='show'){constdirRenderer=resolveAsset(context,'directives',name)if(dirRenderer){directivesmutatethenode'sdatawhichthengetsrenderedbymodulesdirRenderer(node.isComponentRootElement?node.parent:node,dirs[i])}}}}v-showdirectiveneedstobemergedfromparenttochildconstvshowDirectiveInfo=getVShowDirectiveInfo(node)if(vshowDirectiveInfo){directives.show(node,vshowDirectiveInfo)}applyothermodulesfor(leti=0;i<modules.length;i++){constres=modules[i](node)if(res){markup+=res}}}attachscopedCSSIDletscopeIdconstactiveInstance=context.activeInstanceif(isDef(activeInstance)&&activeInstance!==node.context&&isDef((scopeId=activeInstance.$options._scopeId))){markup+=`${scopeIdasany}`}if(isDef(node.fnScopeId)){markup+=`${node.fnScopeId}`}else{while(isDef(node)){@ts-expect-errorif(isDef((scopeId=node.context.$options._scopeId))){markup+=`${scopeId}`}node=node.parent!}}returnmarkup+'>'}exportfunctioncreateRenderFunction(modules:Array<(node:VNode)=>string|null>,directives:Object,isUnaryTag:Function,cache:any){returnfunctionrender(component:Component,write:(text:string,next:Function)=>void,userContext:Record<string,any>|null,done:Function){warned=Object.create(null)constcontext=newRenderContext({activeInstance:component,userContext,write,done,renderNode,isUnaryTag,modules,directives,cache})installSSRHelpers(component)normalizeRender(component)constresolve=()=>{renderNode(component._render(),true,context)}waitForServerPrefetch(component,resolve,done)}}